<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>åº—èˆ—ä¸€æ‹¬ç™»éŒ²ãƒ„ãƒ¼ãƒ«ï¼ˆPocketBaseå¯¾å¿œãƒ»å¸‚åŒºåŒºåˆ‡ã‚Šå¯¾å¿œï¼‰</title>
<style>
  body { background:#000; color:#fff; font-family:"Helvetica Neue",sans-serif; padding:20px; }
  textarea { width:100%; height:300px; background:#111; color:#fff; border:1px solid #555; padding:10px; font-size:14px; margin-bottom:10px; }
  button { background:#2ecc71; color:#fff; border:none; padding:10px 20px; margin-right:10px; border-radius:5px; cursor:pointer; }
  button:hover { opacity:0.8; }
  table { width:100%; border-collapse:collapse; margin-top:20px; }
  th,td { border:1px solid #555; padding:8px; text-align:left; }
  th { background:#222; }
  td[contenteditable="true"] { background:#111; }
  #status { margin-top:10px; font-size:14px; }

  /* âœ… ãƒˆãƒ¼ã‚¹ãƒˆé€šçŸ¥ï¼ˆå³ä¸Šå›ºå®šï¼‰ */
  #toast {
    position: fixed;
    top: 20px;
    right: 20px;
    background: #2ecc71;
    color: #fff;
    padding: 12px 18px;
    border-radius: 8px;
    font-size: 15px;
    font-weight: bold;
    box-shadow: 0 4px 10px rgba(0,0,0,0.4);
    display: none;
    z-index: 9999;
    animation: slideIn 0.4s ease-out;
  }
  @keyframes slideIn {
    from { opacity: 0; transform: translateX(50px); }
    to { opacity: 1; transform: translateX(0); }
  }
</style>
</head>
<body>

<h2>ğŸ“¦ åº—èˆ—ä¸€æ‹¬ç™»éŒ²ãƒ„ãƒ¼ãƒ«ï¼ˆPocketBaseå¯¾å¿œãƒ»å¸‚åŒºåŒºåˆ‡ã‚Šå¯¾å¿œï¼‰</h2>
<p>ã‚³ãƒ”ãƒšã—ãŸãƒ†ã‚­ã‚¹ãƒˆã‹ã‚‰è‡ªå‹•è§£æã€‚æ—¢å­˜åº—èˆ—ã¯é™¤å¤–ã€‚<br>å¸‚ãƒ»åŒºãƒ»ç”ºãƒ»æ‘ã§æ­£ç¢ºã«åˆ‡ã‚Šé›¢ã—ã€‚</p>

<textarea id="inputData" placeholder="ä¾‹ï¼š
ãƒã‚¯ãƒ‰ãƒŠãƒ«ãƒ‰ æ–¹å—ç”ºåº— (McDonald's HONAN-CHO)
æ±äº¬éƒ½æ‰ä¸¦åŒºæ–¹å—2ä¸ç›®19-9
"></textarea>

<div>
  <button id="parseBtn">è‡ªå‹•åˆ¤åˆ¥ï¼‹é‡è¤‡é™¤å¤–</button>
  <button id="registerBtn">ç™»éŒ²</button>
</div>

<div id="status"></div>

<table id="previewTable" style="display:none;">
  <thead>
    <tr><th>ç™»éŒ²</th><th>åº—å</th><th>éƒ½é“åºœçœŒ</th><th>å¸‚åŒºç”ºæ‘</th><th>ä½æ‰€</th></tr>
  </thead>
  <tbody></tbody>
</table>

<div id="toast">âœ… ç™»éŒ²ãŒå®Œäº†ã—ã¾ã—ãŸï¼</div>

<script type="module">
import PocketBase from "https://cdn.jsdelivr.net/npm/pocketbase@0.21.2/dist/pocketbase.es.mjs";
const pb = new PocketBase("https://delivery-eye.onrender.com");

const prefectures = [
  "åŒ—æµ·é“","é’æ£®çœŒ","å²©æ‰‹çœŒ","å®®åŸçœŒ","ç§‹ç”°çœŒ","å±±å½¢çœŒ","ç¦å³¶çœŒ",
  "èŒ¨åŸçœŒ","æ ƒæœ¨çœŒ","ç¾¤é¦¬çœŒ","åŸ¼ç‰çœŒ","åƒè‘‰çœŒ","æ±äº¬éƒ½","ç¥å¥ˆå·çœŒ",
  "æ–°æ½ŸçœŒ","å¯Œå±±çœŒ","çŸ³å·çœŒ","ç¦äº•çœŒ","å±±æ¢¨çœŒ","é•·é‡çœŒ","å²é˜œçœŒ",
  "é™å²¡çœŒ","æ„›çŸ¥çœŒ","ä¸‰é‡çœŒ","æ»‹è³€çœŒ","äº¬éƒ½åºœ","å¤§é˜ªåºœ","å…µåº«çœŒ",
  "å¥ˆè‰¯çœŒ","å’Œæ­Œå±±çœŒ","é³¥å–çœŒ","å³¶æ ¹çœŒ","å²¡å±±çœŒ","åºƒå³¶çœŒ","å±±å£çœŒ",
  "å¾³å³¶çœŒ","é¦™å·çœŒ","æ„›åª›çœŒ","é«˜çŸ¥çœŒ","ç¦å²¡çœŒ","ä½è³€çœŒ","é•·å´çœŒ",
  "ç†Šæœ¬çœŒ","å¤§åˆ†çœŒ","å®®å´çœŒ","é¹¿å…å³¶çœŒ","æ²–ç¸„çœŒ"
];

const inputData=document.getElementById("inputData");
const parseBtn=document.getElementById("parseBtn");
const registerBtn=document.getElementById("registerBtn");
const previewTable=document.getElementById("previewTable");
const tbody=previewTable.querySelector("tbody");
const status=document.getElementById("status");
const toast=document.getElementById("toast");

let parsedData=[],existingStores=[];

// ===== PocketBaseæ—¢å­˜ãƒ‡ãƒ¼ã‚¿ =====
async function fetchExistingStores(){
  try{
    const all = await pb.collection("stores").getFullList({ sort: "name" });
    existingStores = all.map(s => ({ name: s.name, city: s.city }));
  }catch(err){
    console.error("PocketBaseå–å¾—ã‚¨ãƒ©ãƒ¼:",err);
    status.textContent="âš ï¸ æ—¢å­˜ãƒ‡ãƒ¼ã‚¿å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸã€‚";
  }
}

function cleanText(txt){
  return txt
    .replace(/\u200b/g,"")
    .replace(/\u3000/g," ")
    .replace(/\t/g," ")
    .replace(/ +/g," ")
    .trim();
}

// ===== ä½æ‰€è§£æï¼ˆå¸‚ãƒ»åŒºã§åŒºåˆ‡ã‚‹ï¼‰ =====
function parseAddress(fullAddr) {
  let prefecture = "", city = "", rest = "";
  for (const pref of prefectures) {
    if (fullAddr.includes(pref)) {
      prefecture = pref;
      const after = fullAddr.split(pref)[1].trim();

      // âœ… å¸‚ï¼åŒºï¼ç”ºï¼æ‘ã®ä½ç½®ã§åˆ‡ã‚Šé›¢ã™
      const match = after.match(/^(.+?[å¸‚åŒºç”ºæ‘])(.*)$/);
      if (match) {
        city = match[1].trim();
        rest = match[2].trim();
      } else {
        rest = after.trim();
      }
      break;
    }
  }
  return { prefecture, city, rest };
}

// ===== ãƒ¡ã‚¤ãƒ³è§£æ =====
parseBtn.addEventListener("click", async ()=>{
  await fetchExistingStores();

  const cleaned = cleanText(inputData.value);
  const lines = cleaned.split(/\r?\n/).map(l=>l.trim()).filter(l=>l);
  parsedData=[];

  for(let i=0;i<lines.length;i++){
    const line = lines[i];
    const next = lines[i+1]||"";
    const pref = prefectures.find(p=>line.includes(p) || next.includes(p));
    if(!pref) continue;

    let namePart, addressPart;
    if(line.includes(pref)){
      const prefIndex = line.indexOf(pref);
      namePart = line.substring(0,prefIndex).trim();
      addressPart = line.substring(prefIndex).trim();
    } else {
      namePart = line.trim();
      addressPart = next.trim();
      i++;
    }

    const addrParts = parseAddress(addressPart);
    const isDuplicate = existingStores.some(s => s.name === namePart && s.city === addrParts.city);
    if (isDuplicate) continue;

    parsedData.push({
      name: namePart,
      prefecture: addrParts.prefecture,
      city: addrParts.city,
      address: addrParts.rest,
      register: true
    });
  }

  renderTable(parsedData);
  status.style.color="#fff";
  status.textContent=`${parsedData.length} ä»¶ã‚’æ–°è¦æ¤œå‡ºã—ã¾ã—ãŸï¼ˆæ—¢å­˜åº—èˆ—ã¯é™¤å¤–ãƒ»å¸‚åŒºåŒºåˆ‡ã‚Šå¯¾å¿œï¼‰ã€‚`;
});

// ===== ãƒ†ãƒ¼ãƒ–ãƒ«æç”» =====
function renderTable(data){
  if(!data.length){previewTable.style.display="none";return;}
  previewTable.style.display="table";
  tbody.innerHTML="";
  data.forEach(d=>{
    const row=document.createElement("tr");
    const checkCell=document.createElement("td");
    const checkbox=document.createElement("input");
    checkbox.type="checkbox"; checkbox.checked=d.register;
    checkbox.addEventListener("change",()=>d.register=checkbox.checked);
    checkCell.appendChild(checkbox);
    row.appendChild(checkCell);
    ["name","prefecture","city","address"].forEach(key=>{
      const cell=document.createElement("td");
      cell.textContent=d[key];
      cell.contentEditable="true";
      cell.addEventListener("input",()=>d[key]=cell.textContent.trim());
      row.appendChild(cell);
    });
    tbody.appendChild(row);
  });
}

// ===== PocketBaseç™»éŒ²ï¼ˆå³ä¸Šãƒˆãƒ¼ã‚¹ãƒˆï¼‰ =====
registerBtn.addEventListener("click", async ()=>{
  if(!parsedData.length){alert("ã¾ãšãƒ‡ãƒ¼ã‚¿ã‚’å…¥åŠ›ã—ã¦è‡ªå‹•åˆ¤åˆ¥ã—ã¦ãã ã•ã„ã€‚");return;}
  const toRegister = parsedData.filter(d=>d.register);
  if(!toRegister.length){alert("ãƒã‚§ãƒƒã‚¯ã•ã‚ŒãŸãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“ã€‚");return;}

  let added=0;
  for(const item of toRegister){
    try{
      await pb.collection("stores").create({
        name:item.name,
        prefecture:item.prefecture,
        city:item.city,
        address:item.address,
        createdAt:new Date().toISOString()
      });
      added++;
    }catch(err){console.error("ç™»éŒ²ã‚¨ãƒ©ãƒ¼:",err);}
  }

  toast.textContent = `âœ… ç™»éŒ²ãŒå®Œäº†ã—ã¾ã—ãŸï¼ï¼ˆ${added}ä»¶ç™»éŒ²ï¼‰`;
  toast.style.display="block";

  inputData.value="";
  previewTable.style.display="none";

  setTimeout(()=>{
    toast.style.display="none";
  },3000);
});
</script>

</body>
</html>
