<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>åº—èˆ—ä¸€æ‹¬ç™»éŒ²ï¼ˆPocketBaseå¯¾å¿œï¼‰</title>
<style>
  body {
    background-color: #000;
    color: #fff;
    font-family: "Helvetica Neue", sans-serif;
    padding: 20px;
  }
  textarea {
    width: 100%;
    height: 200px;
    margin-bottom: 10px;
    background: #111;
    color: #fff;
    border: 1px solid #555;
    padding: 10px;
    font-size: 14px;
  }
  button {
    background-color: #2ecc71;
    color: #fff;
    border: none;
    padding: 10px 20px;
    margin-right: 10px;
    border-radius: 5px;
    cursor: pointer;
  }
  button:hover { opacity: 0.8; }
  table {
    width: 100%;
    border-collapse: collapse;
    margin-top: 20px;
  }
  th, td {
    border: 1px solid #555;
    padding: 8px;
    text-align: left;
  }
  th { background: #222; }
  td[contenteditable="true"] { background: #111; }
  tr.duplicate { background-color: #440000; } /* é‡è¤‡è¡Œã¯èµ¤ç³» */
  #status { margin-top: 10px; font-size: 14px; }
</style>
</head>
<body>

<h2>ğŸ“¦ åº—èˆ—ä¸€æ‹¬ç™»éŒ²ãƒ„ãƒ¼ãƒ«ï¼ˆPocketBaseå¯¾å¿œï¼‰</h2>
<p>ä¸‹è¨˜ã« <b>åº—åï¼‹ä½æ‰€</b> ã‚’æ”¹è¡ŒåŒºåˆ‡ã‚Šã§å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚</p>

<textarea id="inputData" placeholder="ä¾‹ï¼š
ãƒã‚¯ãƒ‰ãƒŠãƒ«ãƒ‰æ¸‹è°·åº—æ±äº¬éƒ½æ¸‹è°·åŒºé“ç„å‚2-11-1
å‰é‡å®¶æ–°å®¿åº—æ±äº¬éƒ½æ–°å®¿åŒºè¥¿æ–°å®¿1-7-1
"></textarea>

<div>
  <button id="parseBtn">è‡ªå‹•åˆ¤åˆ¥ï¼‹é‡è¤‡ãƒã‚§ãƒƒã‚¯</button>
  <button id="registerBtn">ç™»éŒ²</button>
</div>

<div id="status"></div>

<table id="previewTable" style="display:none;">
  <thead>
    <tr>
      <th>ç™»éŒ²</th>
      <th>åº—å</th>
      <th>éƒ½é“åºœçœŒ</th>
      <th>å¸‚åŒºç”ºæ‘</th>
      <th>ä½æ‰€</th>
    </tr>
  </thead>
  <tbody></tbody>
</table>

<script type="module">
import PocketBase from "https://cdn.jsdelivr.net/npm/pocketbase@0.21.2/dist/pocketbase.es.mjs";
const pb = new PocketBase("https://delivery-eye.onrender.com");

// éƒ½é“åºœçœŒãƒªã‚¹ãƒˆ
const prefectures = [
  "åŒ—æµ·é“","é’æ£®çœŒ","å²©æ‰‹çœŒ","å®®åŸçœŒ","ç§‹ç”°çœŒ","å±±å½¢çœŒ","ç¦å³¶çœŒ",
  "èŒ¨åŸçœŒ","æ ƒæœ¨çœŒ","ç¾¤é¦¬çœŒ","åŸ¼ç‰çœŒ","åƒè‘‰çœŒ","æ±äº¬éƒ½","ç¥å¥ˆå·çœŒ",
  "æ–°æ½ŸçœŒ","å¯Œå±±çœŒ","çŸ³å·çœŒ","ç¦äº•çœŒ","å±±æ¢¨çœŒ","é•·é‡çœŒ","å²é˜œçœŒ",
  "é™å²¡çœŒ","æ„›çŸ¥çœŒ","ä¸‰é‡çœŒ","æ»‹è³€çœŒ","äº¬éƒ½åºœ","å¤§é˜ªåºœ","å…µåº«çœŒ",
  "å¥ˆè‰¯çœŒ","å’Œæ­Œå±±çœŒ","é³¥å–çœŒ","å³¶æ ¹çœŒ","å²¡å±±çœŒ","åºƒå³¶çœŒ","å±±å£çœŒ",
  "å¾³å³¶çœŒ","é¦™å·çœŒ","æ„›åª›çœŒ","é«˜çŸ¥çœŒ","ç¦å²¡çœŒ","ä½è³€çœŒ","é•·å´çœŒ",
  "ç†Šæœ¬çœŒ","å¤§åˆ†çœŒ","å®®å´çœŒ","é¹¿å…å³¶çœŒ","æ²–ç¸„çœŒ"
];

const inputData = document.getElementById("inputData");
const parseBtn = document.getElementById("parseBtn");
const registerBtn = document.getElementById("registerBtn");
const previewTable = document.getElementById("previewTable");
const tbody = previewTable.querySelector("tbody");
const status = document.getElementById("status");

let parsedData = [];
let existingStores = [];

// ===== PocketBase ã‹ã‚‰æ—¢å­˜ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾— =====
async function fetchExistingStores() {
  try {
    const resultList = await pb.collection("stores").getList(1, 200, { sort: "name" });
    existingStores = resultList.items.map(s => ({ name: s.name, city: s.city }));
  } catch (err) {
    console.error("PocketBaseå–å¾—ã‚¨ãƒ©ãƒ¼:", err);
    status.textContent = "âš ï¸ æ—¢å­˜ãƒ‡ãƒ¼ã‚¿å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸã€‚";
  }
}

// ===== è‡ªå‹•åˆ¤åˆ¥ï¼‹é‡è¤‡ãƒã‚§ãƒƒã‚¯ =====
parseBtn.addEventListener("click", async () => {
  await fetchExistingStores();

  const lines = inputData.value.split("\n").map(l => l.trim()).filter(l => l);
  parsedData = [];

  lines.forEach(line => {
    let pref = prefectures.find(p => line.includes(p));
    if (!pref) return;

    let [namePart, addressPart] = line.split(pref);
    let cityMatch = addressPart.match(/^(.*?[å¸‚åŒºç”ºæ‘])/);
    let city = cityMatch ? cityMatch[1] : "";
    let addr = addressPart.replace(city, "").trim();

    const isDuplicate = existingStores.some(s => s.name === namePart.trim() && s.city === city);

    parsedData.push({
      name: namePart.trim(),
      prefecture: pref,
      city: city,
      address: addr,
      duplicate: isDuplicate,
      register: true
    });
  });

  renderTable(parsedData);
  status.textContent = `${parsedData.length} ä»¶ã‚’è‡ªå‹•åˆ¤åˆ¥ã—ã¾ã—ãŸã€‚é‡è¤‡ã¯èµ¤èƒŒæ™¯ã§è¡¨ç¤ºã—ã¦ã„ã¾ã™ã€‚`;
});

// ===== ãƒ†ãƒ¼ãƒ–ãƒ«æç”» =====
function renderTable(data) {
  previewTable.style.display = "table";
  tbody.innerHTML = "";

  data.forEach((d) => {
    const row = document.createElement("tr");
    if (d.duplicate) row.classList.add("duplicate");

    // ãƒã‚§ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹
    const checkCell = document.createElement("td");
    const checkbox = document.createElement("input");
    checkbox.type = "checkbox";
    checkbox.checked = d.register;
    checkbox.addEventListener("change", () => d.register = checkbox.checked);
    checkCell.appendChild(checkbox);
    row.appendChild(checkCell);

    ["name", "prefecture", "city", "address"].forEach(key => {
      const cell = document.createElement("td");
      cell.textContent = d[key];
      cell.contentEditable = "true";
      cell.addEventListener("input", () => d[key] = cell.textContent.trim());
      row.appendChild(cell);
    });

    tbody.appendChild(row);
  });
}

// ===== ç™»éŒ²å‡¦ç† =====
registerBtn.addEventListener("click", async () => {
  if (!parsedData.length) { alert("ãƒ‡ãƒ¼ã‚¿ã‚’å…¥åŠ›ã—ã¦è‡ªå‹•åˆ¤åˆ¥ã—ã¦ãã ã•ã„ã€‚"); return; }
  const toRegister = parsedData.filter(d => d.register);
  if (!toRegister.length) { alert("ãƒã‚§ãƒƒã‚¯ã•ã‚ŒãŸãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“ã€‚"); return; }

  if (!confirm(`${toRegister.length} ä»¶ã‚’ç™»éŒ²ã—ã¾ã™ã€‚ã‚ˆã‚ã—ã„ã§ã™ã‹ï¼Ÿ`)) return;

  let addedCount = 0, skippedCount = 0;

  for (const item of toRegister) {
    try {
      // é‡è¤‡ãƒã‚§ãƒƒã‚¯
      const check = await pb.collection("stores").getList(1, 1, {
        filter: `name="${item.name}" && city="${item.city}"`
      });
      if (check.items.length > 0) {
        console.warn("é‡è¤‡ã‚¹ã‚­ãƒƒãƒ—:", item.name);
        skippedCount++;
        continue;
      }

      await pb.collection("stores").create({
        name: item.name,
        prefecture: item.prefecture,
        city: item.city,
        address: item.address,
        createdAt: new Date().toISOString()
      });
      addedCount++;
    } catch (err) {
      console.error("ç™»éŒ²ã‚¨ãƒ©ãƒ¼:", err);
    }
  }

  status.textContent = `âœ… ${addedCount} ä»¶ã‚’ç™»éŒ²å®Œäº†ï¼ˆ${skippedCount} ä»¶ã¯é‡è¤‡ã‚¹ã‚­ãƒƒãƒ—ï¼‰`;
});
</script>

</body>
</html>
