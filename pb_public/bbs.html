<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8" />
<title>掲示板</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0" />

<!-- ✅ AdSense（追加：ここだけ） -->
<script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-438930905551232"
crossorigin="anonymous"></script>

<style>
/* ===== ベース ===== */
body{
  margin:0;
  background:#050505;
  color:#fff;
  font-family:system-ui,-apple-system,BlinkMacSystemFont,"Segoe UI",sans-serif;
}

/* ✅ h2（スレッド一覧/新規スレッド作成など）を小さく */
h2{
  margin:0 0 10px;
  font-size:16px;
  font-weight:900;
  letter-spacing:.02em;
}

/* （元のヘッダー定義は残すが、siteHeaderを使うので見た目はそちら） */
header{
  background:#0f0f0f;
  padding:10px 16px;
  border-bottom:1px solid #222;
}
header h1{
  margin:0;
  font-size:1rem;
  color:#66ff99;
}
.container{
  max-width:900px;
  margin:0 auto;
  padding:14px;
}

/* ===== 注意事項 ===== */
.notice-box{
  background:#1a1a1a;
  border-left:4px solid #ff4d4d;
  padding:10px 12px;
  margin:10px auto 16px;
  max-width:900px;
  font-size:0.8rem;
  color:#ddd;
  line-height:1.5;
  border-radius:6px;
}
.notice-box strong{ color:#ff6b6b; }

/* ===== ボタン ===== */
.btn{
  padding:6px 12px;
  border-radius:6px;
  border:none;
  background:#ff7a1a;
  color:#fff;
  cursor:pointer;
  font-size:0.8rem;
}
.btn:hover{opacity:0.9;}
.btn-secondary{
  background:#222;
  color:#ddd;
}
.btn-secondary:hover{background:#333;}

/* 削除/通報/返信 共通（同じ色に統一） */
.btn-action{
  padding:4px 10px;
  font-size:0.7rem;
  border-radius:999px;
  border:1px solid rgba(255,255,255,.12);
  background:rgba(255,255,255,.06);
  color:rgba(245,245,247,.78);
  cursor:pointer;
}
.btn-action:hover{
  background:rgba(255,255,255,.10);
  color:#f5f5f7;
}
.btn-action:disabled{ opacity:.4; cursor:not-allowed; }

/* スレッドの通報（目立たない）※スレッドを開いた時だけ表示 */
.btn-thread-report{
  padding:3px 10px;
  font-size:0.68rem;
  border-radius:999px;
  border:1px solid rgba(255,255,255,.10);
  background:transparent;
  color:rgba(245,245,247,.55);
  cursor:pointer;
}
.btn-thread-report:hover{
  background:rgba(255,255,255,.06);
  color:rgba(245,245,247,.78);
}

/* ===== ページング ===== */
.pager{
  margin-top:12px;
  display:flex;
  gap:8px;
  align-items:center;
  flex-wrap:wrap;
}
.pager .info{
  font-size:0.75rem;
  color:#aaa;
}

/* ===== スレッド一覧 ===== */
.thread-card{
  background:#101010;
  border-radius:10px;
  border:1px solid #222;
  padding:12px;
  margin-bottom:10px;
  cursor:pointer;
}
.thread-card:hover{background:#161616;}
.thread-title{ margin:0; font-size:1rem; }
.thread-info{
  font-size:0.75rem;
  color:#aaa;
  margin-top:6px;
  line-height:1.5;
}
.thread-preview{
  margin-top:8px;
  font-size:0.82rem;
  color:#ddd;
  opacity:0.95;
  white-space:nowrap;
  overflow:hidden;
  text-overflow:ellipsis;
}

/* ===== フォーム ===== */
.form-card{
  background:#101010;
  border-radius:10px;
  border:1px solid #222;
  padding:12px;
  margin-bottom:14px;
}
input,textarea{
  width:100%;
  box-sizing:border-box;
  background:#0a0a0a;
  border:1px solid #333;
  border-radius:6px;
  padding:6px;
  color:#fff;
  margin-bottom:8px;
  font-size:0.85rem;
}
textarea{
  resize:vertical;
  min-height:80px;
}
input:focus,textarea:focus{
  outline:none;
  border-color:#66ff99;
}

/* 返信先表示 */
.reply-banner{
  display:none;
  align-items:center;
  justify-content:space-between;
  gap:10px;
  background:#0e1410;
  border:1px solid rgba(102,255,153,.25);
  border-radius:8px;
  padding:8px 10px;
  margin-bottom:8px;
}
.reply-banner .label{
  font-size:0.75rem;
  color:#b9ffd2;
}
.reply-banner .preview{
  font-size:0.8rem;
  color:#e8ffef;
  opacity:0.9;
  white-space:nowrap;
  overflow:hidden;
  text-overflow:ellipsis;
  max-width:560px;
}
.reply-banner .right{
  display:flex;
  gap:6px;
  align-items:center;
}

/* ===== 投稿カード ===== */
.post-card{
  background:#0e0e0e;
  border-radius:10px;
  border:1px solid #222;
  padding:10px;
  margin-bottom:10px;
}
.post-name{
  font-size:0.8rem;
  color:#66ff99;
}
.post-date{
  font-size:0.7rem;
  color:#777;
}
.post-body{
  margin-top:6px;
  white-space:pre-wrap;
  font-size:0.85rem;
}
.post-footer{
  margin-top:6px;
  display:flex;
  flex-wrap:wrap;
  gap:6px;
}

/* 返信先チップ */
.reply-to-chip{
  display:inline-flex;
  gap:6px;
  align-items:center;
  margin-top:6px;
  padding:4px 8px;
  border-radius:999px;
  border:1px solid rgba(255,255,255,.12);
  background:#0b0b0b;
  color:#ddd;
  font-size:0.72rem;
  cursor:pointer;
}
.reply-to-chip:hover{background:#121212;}
.reply-to-chip b{color:#66ff99; font-weight:600;}

/* ===== その他 ===== */
.back-link{
  color:#66ff99;
  font-size:0.85rem;
  cursor:pointer;
}
.back-link:hover{text-decoration:underline;}

/* ===== 通報モーダル ===== */
.report-overlay{
  position:fixed;
  inset:0;
  background:rgba(0,0,0,0.7);
  display:none;
  align-items:center;
  justify-content:center;
  z-index:50;
}
.report-box{
  background:#111;
  border-radius:10px;
  border:1px solid #444;
  padding:14px;
  max-width:320px;
  width:90%;
  font-size:0.8rem;
}
.report-box h3{
  margin:0 0 8px;
  font-size:0.9rem;
}
.report-reasons{
  display:flex;
  flex-direction:column;
  gap:6px;
  margin-top:6px;
}
.report-reasons button{
  text-align:left;
  width:100%;
}

/* ===== レスポンシブ ===== */
@media (max-width:600px){
  header{ flex-direction:column; align-items:flex-start; gap:4px; }
  .reply-banner .preview{ max-width:220px; }
}

/* =========================
   ✅ 画像と同じヘッダー（共通）
========================= */
header.siteHeader{
  display:flex;
  align-items:center;
  justify-content:space-between;
  gap:12px;
  padding:12px 14px;
  border-radius:18px;
  background:rgba(5,5,8,0.72);
  border:1px solid rgba(255,255,255,0.06);
  backdrop-filter:blur(22px);
  box-shadow:0 18px 60px rgba(0,0,0,0.62);
  margin:12px 12px 18px;
  position:relative;
  z-index:50;
  border-bottom:none;
}
.logoArea{ display:flex; align-items:center; min-width:0; }
.logoLink{ display:inline-block; min-width:0; color:inherit; text-decoration:none; }
.logoTextMain{
  font-weight:900;
  font-size:18px;
  letter-spacing:0.06em;
  white-space:nowrap;
  overflow:hidden;
  text-overflow:ellipsis;
}
.logoTextSub{
  font-size:12px;
  line-height:1.5;
  color:rgba(245,245,247,0.55);
  white-space:nowrap;
  overflow:hidden;
  text-overflow:ellipsis;
  margin-top:2px;
}
.headerRight{ display:flex; align-items:center; gap:10px; flex:0 0 auto; min-width:0; }
nav{ display:flex; align-items:center; gap:8px; flex-wrap:wrap; }
nav a, nav button{
  color:rgba(245,245,247,0.62);
  text-decoration:none;
  padding:8px 12px;
  border-radius:999px;
  border:1px solid rgba(255,255,255,0.06);
  background:rgba(255,255,255,0.02);
  font-size:12px;
  line-height:1;
  transition:all .16s ease;
  white-space:nowrap;
  cursor:pointer;
  font-family:inherit;
}
nav a:hover, nav button:hover{ color:#f5f5f7; background:rgba(255,255,255,0.05); }
nav .primary{
  color:#050814;
  background:#5bff9c;
  border-color:transparent;
  font-weight:900;
  box-shadow:0 0 18px rgba(91,255,156,0.28);
}
nav .primary:hover{ background:#7affb2; }
nav button{ appearance:none; -webkit-appearance:none; }
.loggedPill{
  display:inline-flex !important;
  align-items:center;
  gap:8px;
  color:#07110a !important;
  background:linear-gradient(180deg, rgba(91,255,156,0.95), rgba(91,255,156,0.78)) !important;
  border-color:rgba(91,255,156,0.18) !important;
  box-shadow:0 0 18px rgba(91,255,156,0.22), 0 12px 28px rgba(0,0,0,0.45);
  font-weight:900;
}
.loggedLamp{
  width:10px; height:10px; border-radius:50%;
  background:#5bff9c;
  box-shadow:0 0 10px rgba(91,255,156,0.9), 0 0 24px rgba(91,255,156,0.38);
  position:relative;
}
.loggedLamp::after{
  content:"";
  position:absolute;
  inset:-8px;
  border-radius:999px;
  border:1px solid rgba(91,255,156,0.25);
  animation:pulse 1.6s ease-in-out infinite;
  opacity:.65;
}
@keyframes pulse{
  0%{ transform:scale(0.72); opacity:0.25; }
  55%{ transform:scale(1.08); opacity:0.75; }
  100%{ transform:scale(1.35); opacity:0; }
}
.logoutPill{
  color:rgba(245,245,247,0.88) !important;
  border-color:rgba(255,255,255,0.10) !important;
  background:rgba(255,255,255,0.03) !important;
}
.logoutPill:hover{ border-color:rgba(91,255,156,0.18) !important; }

@media (max-width:640px){
  header.siteHeader{ flex-direction:column; align-items:stretch; gap:10px; }
  .headerRight{ flex-direction:column; align-items:stretch; gap:10px; }
  nav a, nav button{ padding:12px 14px; font-size:14px; }
}

/* ログアウト確認 */
.confirmModal{
  display:none;
  position:fixed;
  inset:0;
  background:rgba(0,0,0,0.72);
  justify-content:center;
  align-items:center;
  z-index:10000;
  padding:14px;
}
.confirmBox{
  width:min(420px, 100%);
  background:rgba(15,16,20,0.92);
  border:1px solid rgba(255,255,255,0.10);
  border-radius:16px;
  padding:16px;
  box-shadow:0 22px 80px rgba(0,0,0,0.72);
  backdrop-filter:blur(18px);
}
.confirmTitle{
  margin:0 0 8px;
  font-size:16px;
  font-weight:900;
  letter-spacing:.02em;
}
.confirmText{
  margin:0 0 12px;
  color:rgba(245,245,247,0.68);
  line-height:1.5;
  font-size:13px;
}
.confirmActions{
  display:flex;
  gap:10px;
  justify-content:flex-end;
  flex-wrap:wrap;
}
.confirmBtn{
  padding:10px 12px;
  border-radius:12px;
  border:1px solid rgba(255,255,255,0.10);
  background:rgba(255,255,255,0.04);
  color:rgba(245,245,247,0.9);
  font-weight:900;
  cursor:pointer;
  font-family:inherit;
}
.confirmBtn:hover{ background:rgba(255,255,255,0.07); }
.confirmBtnDanger{
  border-color:rgba(255,150,150,0.25);
  background:rgba(255,150,150,0.10);
  color:#ffdede;
}
.confirmBtnDanger:hover{ background:rgba(255,150,150,0.16); }
</style>
</head>
<body>

<header class="siteHeader">
  <div class="logoArea">
    <a class="logoLink" href="index.html" aria-label="トップページへ戻る">
      <div style="min-width:0;">
        <div class="logoTextMain">FoodDeliveryEye</div>
        <div class="logoTextSub">配達員の体験を、みんなの安心と効率へ</div>
      </div>
    </a>
  </div>

  <div class="headerRight">
    <nav>
      <a id="navAbout" href="about.html">このサイトについて</a>
      <a id="navLogin" href="login.html">ログイン</a>
      <a id="navSignup" href="signup.html" class="primary">新規登録</a>

      <a id="navLoggedIn" href="mypage.html" style="display:none;">
        <span class="loggedLamp" aria-hidden="true"></span>
        ログイン中
      </a>
      <button id="navLogout" type="button" class="logoutPill" style="display:none;">ログアウトする</button>
    </nav>
  </div>
</header>

<div class="notice-box">
  <strong>【注意事項】</strong><br>
  ・誹謗中傷・攻撃的・不適切な投稿は禁止です<br>
</div>

<div class="container" id="app"></div>

<div id="logoutConfirmModal" class="confirmModal" aria-hidden="true">
  <div class="confirmBox" role="dialog" aria-modal="true" aria-labelledby="confirmTitle">
    <h3 class="confirmTitle" id="confirmTitle">本当にログアウトしますか？</h3>
    <p class="confirmText">ログアウトすると、お気に入り絞り込みや投稿ができなくなります。</p>
    <div class="confirmActions">
      <button id="cancelLogoutBtn" class="confirmBtn" type="button">キャンセル</button>
      <button id="confirmLogoutBtn" class="confirmBtn confirmBtnDanger" type="button">ログアウト</button>
    </div>
  </div>
</div>

<div id="reportOverlay" class="report-overlay">
  <div class="report-box">
    <h3 id="reportTitle">通報しますか？</h3>
    <div>理由を選択してください。</div>
    <div class="report-reasons">
      <button class="btn-action" data-reason="誹謗中傷・攻撃的">① 誹謗中傷・攻撃的</button>
      <button class="btn-action" data-reason="不適切・下ネタ">② 不適切・下ネタ</button>
      <button class="btn-action" data-reason="スパム・広告・URL">③ スパム・広告・URL</button>
      <button class="btn-action" data-reason="個人情報・危険">④ 個人情報・危険</button>
      <button class="btn-action" data-reason="その他">⑤ その他</button>
    </div>
    <div style="text-align:right;margin-top:10px;">
      <button class="btn-action" id="reportCancelBtn">キャンセル</button>
    </div>
  </div>
</div>

<script type="module">
import PocketBase from "https://cdn.jsdelivr.net/npm/pocketbase@0.21.2/dist/pocketbase.es.mjs";

/* =========================
   PocketBase
========================= */
const pb = new PocketBase("https://delivery-eye.onrender.com");

/* =========================
   ナビ（既存挙動維持）
========================= */
const KEY_NEXT_STORE = "fdel_next_url_v1";
const navLogin = document.getElementById("navLogin");
navLogin?.addEventListener("click", ()=>{
  try{
    const current = location.pathname + location.search + location.hash;
    localStorage.setItem(KEY_NEXT_STORE, current);
    navLogin.href = "login.html?next=" + encodeURIComponent(current);
  }catch{}
});

const navAbout    = document.getElementById("navAbout");
const navSignup   = document.getElementById("navSignup");
const navLoggedIn = document.getElementById("navLoggedIn");
const navLogout   = document.getElementById("navLogout");

function setNavLoggedIn(isLoggedIn){
  if(isLoggedIn){
    navAbout.style.display = "none";
    navLogin.style.display = "none";
    navSignup.style.display = "none";
    navLoggedIn.style.display = "";
    navLoggedIn.classList.add("loggedPill");
    navLogout.style.display = "";
  }else{
    navAbout.style.display = "";
    navLogin.style.display = "";
    navSignup.style.display = "";
    navLoggedIn.style.display = "none";
    navLoggedIn.classList.remove("loggedPill");
    navLogout.style.display = "none";
  }
}
async function ensureAuthModel(){
  if(!pb.authStore.isValid){
    setNavLoggedIn(false);
    return;
  }
  try{
    await pb.collection("users").authRefresh();
    setNavLoggedIn(true);
  }catch{
    pb.authStore.clear();
    setNavLoggedIn(false);
  }
}

/* ログアウト確認 */
const logoutConfirmModal = document.getElementById("logoutConfirmModal");
const cancelLogoutBtn = document.getElementById("cancelLogoutBtn");
const confirmLogoutBtn = document.getElementById("confirmLogoutBtn");

let logoutBusy = false;
function openLogoutConfirm(){
  logoutConfirmModal.style.display = "flex";
  logoutConfirmModal.setAttribute("aria-hidden","false");
}
function closeLogoutConfirm(){
  logoutConfirmModal.style.display = "none";
  logoutConfirmModal.setAttribute("aria-hidden","true");
}
async function doLogout(){
  if(logoutBusy) return;
  logoutBusy = true;
  try{
    pb.authStore.clear();
    setNavLoggedIn(false);
    closeLogoutConfirm();
    alert("ログアウトしました");
  }finally{
    logoutBusy = false;
  }
}
navLogout?.addEventListener("click", ()=>openLogoutConfirm());
cancelLogoutBtn?.addEventListener("click", ()=>closeLogoutConfirm());
confirmLogoutBtn?.addEventListener("click", ()=>doLogout());
logoutConfirmModal?.addEventListener("click", (e)=>{ if(e.target === logoutConfirmModal) closeLogoutConfirm(); });
document.addEventListener("keydown", (e)=>{ if(e.key === "Escape" && logoutConfirmModal?.style.display === "flex") closeLogoutConfirm(); });

setNavLoggedIn(pb.authStore.isValid);
await ensureAuthModel();

/* =========================
   掲示板（UIそのまま・永続化PocketBase）
========================= */

/* 端末ID（匿名でも同一端末の識別に使う） */
const VIEWER_ID_KEY = "bbs_viewer_id_v1";
function getViewerId(){
  let id = localStorage.getItem(VIEWER_ID_KEY);
  if(!id){
    id = "v_" + Date.now().toString(36) + "_" + Math.random().toString(36).slice(2,8);
    localStorage.setItem(VIEWER_ID_KEY, id);
  }
  return id;
}
const viewerId = getViewerId();

/* ローカルでのみ使う（UIロジック維持用） */
const BANNED_NAMES_KEY = "bbs_banned_names_v1";
const HIDDEN_POST_IDS_KEY = "bbs_hidden_post_ids_v1";
const USER_REPORT_COUNTS_KEY = "bbs_user_report_counts_v1";
const BANNED_VIEWERS_KEY = "bbs_banned_viewers_v1";

function loadJson(key, fallback){
  try{
    const raw = localStorage.getItem(key);
    if(!raw) return fallback;
    const v = JSON.parse(raw);
    return v ?? fallback;
  }catch{ return fallback; }
}
function saveJson(key, value){ localStorage.setItem(key, JSON.stringify(value)); }

let bannedNames = loadJson(BANNED_NAMES_KEY, []);
let hiddenPostIds = loadJson(HIDDEN_POST_IDS_KEY, []);
let userReportCounts = loadJson(USER_REPORT_COUNTS_KEY, {});
let bannedViewers = loadJson(BANNED_VIEWERS_KEY, []);

const REPORT_THRESHOLD = 2;
const THREAD_REPORT_THRESHOLD = 5;
const USER_TOTAL_REPORT_THRESHOLD = 10;

const THREADS_PER_PAGE = 20;
const POSTS_PER_PAGE = 20;

function saveLocalModeration(){
  saveJson(BANNED_NAMES_KEY, bannedNames);
  saveJson(HIDDEN_POST_IDS_KEY, hiddenPostIds);
  saveJson(USER_REPORT_COUNTS_KEY, userReportCounts);
  saveJson(BANNED_VIEWERS_KEY, bannedViewers);
}

/* =========================
   ✅ NGフィルタ（緩くした版）
   - 1文字禁止を撤去（? だけでもOK）
   - 連続記号は10個以上でNG
   - NGワードは「殺害/自殺/テロ」系の強いものだけ
========================= */
const NG_WORDS = [
  "死ね","しね","殺す","ころす","殺害","自殺","自害","リスカ","テロ","爆破","爆弾"
];

function isDisallowedContent(text){
  if(text == null) return false;
  const s = String(text);
  const t = s.toLowerCase();

  // URL / メールはNG（スパム対策）
  if(/https?:\/\//.test(t)) return true;
  if(/[a-z0-9._%+-]+@[a-z0-9.-]+\.[a-z]{2,}/i.test(s)) return true;

  // 記号連打（緩め：10以上）
  if(/[!?！？]{10,}/.test(s)) return true;

  // 強いNGワードのみ
  for(const w of NG_WORDS){
    if(t.includes(w.toLowerCase())) return true;
  }

  // 文字数が0だけNG（空は別で弾く）
  return false;
}

function formatDate(ts){
  const d = new Date(ts);
  const y = d.getFullYear();
  const m = String(d.getMonth()+1).padStart(2,"0");
  const day = String(d.getDate()).padStart(2,"0");
  const h = String(d.getHours()).padStart(2,"0");
  const min = String(d.getMinutes()).padStart(2,"0");
  return `${y}/${m}/${day} ${h}:${min}`;
}
function toSnippet(text, max=70){
  const raw = (text || "").replace(/\s+/g, " ").trim();
  if(!raw) return "（本文なし）";
  return raw.length > max ? raw.slice(0, max) + "…" : raw;
}

function ensureCanPost(){
  if(bannedViewers.includes(viewerId)){
    alert("通報が累計10回に達したため、この端末からの投稿はできません。");
    return false;
  }
  return true;
}
function addUserReport(targetViewerId){
  if(!targetViewerId) return;
  const cur = Number(userReportCounts[targetViewerId] || 0);
  const next = cur + 1;
  userReportCounts[targetViewerId] = next;
  if(next >= USER_TOTAL_REPORT_THRESHOLD && !bannedViewers.includes(targetViewerId)){
    bannedViewers.push(targetViewerId);
    alert("通報が累計10回に達したため、該当ユーザーは投稿できない状態になりました。");
  }
  saveLocalModeration();
}

/* =========================
   PocketBaseアクセス
========================= */
async function pbSafe(fn){
  try{ return await fn(); }
  catch(e){ console.error(e); throw e; }
}

async function fetchThreadsPage(page){
  return await pbSafe(()=>pb.collection("threads").getList(page, THREADS_PER_PAGE, {
    filter: "isHidden = false",
    sort: "-created"
  }));
}

async function fetchLatestPostForThread(threadId){
  const res = await pbSafe(()=>pb.collection("posts").getList(1, 1, {
    filter: `thread = "${threadId}" && isHidden = false`,
    sort: "-created"
  }));
  const p = res.items?.[0] || null;
  if(!p) return { lastAt:null, preview:"まだ投稿がありません。" };
  return { lastAt: new Date(p.created).getTime(), preview: toSnippet(p.body || "", 60) };
}

async function fetchPostsPage(threadId, page){
  return await pbSafe(()=>pb.collection("posts").getList(page, POSTS_PER_PAGE, {
    filter: `thread = "${threadId}" && isHidden = false`,
    sort: "-created"
  }));
}

/* 通報（重複通報防止：reporter+target） */
async function alreadyReported(targetType, targetId){
  const res = await pbSafe(()=>pb.collection("bbs_reports").getList(1, 1, {
    filter: `targetType = "${targetType}" && targetId = "${targetId}" && reporter = "${viewerId}"`,
    sort: "-created"
  }));
  return (res.totalItems || 0) > 0;
}
async function countReports(targetType, targetId){
  const res = await pbSafe(()=>pb.collection("bbs_reports").getList(1, 1, {
    filter: `targetType = "${targetType}" && targetId = "${targetId}"`,
    sort: "-created"
  }));
  return Number(res.totalItems || 0);
}
async function createReport(targetType, targetId, reason){
  await pbSafe(()=>pb.collection("bbs_reports").create({
    targetType, targetId, reason,
    reporter: viewerId,
  }));
}

/* ✅ PB上でスレッドを非表示化 */
async function hideThreadInPB(threadId){
  await pbSafe(()=>pb.collection("threads").update(threadId, { isHidden:true }));
}

/* ✅ PB上で投稿を非表示化（本人だけ） */
async function hidePostInPB(postId){
  await pbSafe(()=>pb.collection("posts").update(postId, { isHidden:true }));
}

/* =========================
   画面状態
========================= */
const app = document.getElementById("app");
let state = { page:"list", currentThreadId:null, threadPage:1, postPage:1 };
let reportContext = { type:null, threadId:null, postId:null };
let replyContext = null;

function clampPage(page, totalPages){
  const p = Number(page || 1);
  if(totalPages <= 0) return 1;
  return Math.max(1, Math.min(totalPages, p));
}
function renderPager({page, total, perPage, onPrev, onNext, onJump}){
  const totalPages = Math.max(1, Math.ceil(total / perPage));
  const cur = clampPage(page, totalPages);
  const start = (cur - 1) * perPage + 1;
  const end = Math.min(cur * perPage, total);
  return `
    <div class="pager">
      <button class="btn-action" onclick="${onPrev}" ${cur<=1?'disabled':''}>前へ</button>
      <button class="btn-action" onclick="${onNext}" ${cur>=totalPages?'disabled':''}>次へ</button>
      <span class="info">${total===0 ? '0件' : `${start}〜${end} / ${total}件`}（${cur}/${totalPages}）</span>
      <button class="btn-action" onclick="${onJump}(1)">1</button>
      <button class="btn-action" onclick="${onJump}(${totalPages})">${totalPages}</button>
    </div>
  `;
}

/* グローバルに公開（onclick用） */
window.prevThreadPage = ()=>{ state.threadPage = Math.max(1, state.threadPage - 1); renderThreadList(); };
window.nextThreadPage = ()=>{ state.threadPage = state.threadPage + 1; renderThreadList(); };
window.jumpThreadPage = (p)=>{ state.threadPage = p; renderThreadList(); };

window.goCreateThread = ()=>goCreateThread();
window.backToList = ()=>backToList();
window.createThread = ()=>createThread();
window.postToThread = ()=>postToThread();
window.cancelReply = ()=>cancelReply();
window.startReply = (id)=>startReply(id);
window.deletePost = (id)=>deletePost(id);
window.openPostReportDialog = (id)=>openPostReportDialog(id);
window.openThreadReportDialog = (id)=>openThreadReportDialog(id);
window.closeReportDialog = ()=>closeReportDialog();
window.prevPostPage = ()=>{ state.postPage = Math.max(1, state.postPage - 1); renderPosts(); };
window.nextPostPage = ()=>{ state.postPage = state.postPage + 1; renderPosts(); };
window.jumpPostPage = (p)=>{ state.postPage = p; renderPosts(); };

function render(){ state.page === "thread" ? renderThreadPage() : renderThreadList(); }

/* =========================
   スレッド一覧
========================= */
async function renderThreadList(){
  app.innerHTML = `
    <h2>スレッド一覧</h2>
    <button class="btn" onclick="goCreateThread()">＋ 新規スレッド作成</button>
    <div id="threadList" style="margin-top:14px;"></div>
    <div id="threadPager"></div>
    <div id="errBox" style="margin-top:10px;color:#f2a3a3;"></div>
  `;

  const list = document.getElementById("threadList");
  const pager = document.getElementById("threadPager");
  const errBox = document.getElementById("errBox");

  try{
    const res = await fetchThreadsPage(state.threadPage);
    const total = Number(res.totalItems || 0);
    const totalPages = Math.max(1, Number(res.totalPages || 1));
    state.threadPage = clampPage(state.threadPage, totalPages);

    if(total === 0){
      list.innerHTML = `<div style="color:#777;margin-top:20px;">まだスレッドがありません。</div>`;
      pager.innerHTML = "";
      errBox.textContent = "";
      return;
    }

    const items = res.items || [];
    const enriched = await Promise.all(items.map(async t=>{
      const info = await fetchLatestPostForThread(t.id);
      return { t, info, lastAt: info.lastAt || new Date(t.created).getTime() };
    }));
    enriched.sort((a,b)=> (b.lastAt||0) - (a.lastAt||0));

    list.innerHTML = "";
    enriched.forEach(({t, info})=>{
      const div = document.createElement("div");
      div.className = "thread-card";

      const title = document.createElement("h3");
      title.className = "thread-title";
      title.textContent = t.title;

      const infoDiv = document.createElement("div");
      infoDiv.className = "thread-info";
      infoDiv.innerHTML = `最新の投稿：${info.lastAt ? formatDate(info.lastAt) : "—"}`;

      const prev = document.createElement("div");
      prev.className = "thread-preview";
      prev.textContent = `最新の投稿：${info.preview}`;

      div.appendChild(title);
      div.appendChild(infoDiv);
      div.appendChild(prev);
      div.onclick = ()=>enterThread(t.id);
      list.appendChild(div);
    });

    pager.innerHTML = renderPager({
      page: state.threadPage, total, perPage: THREADS_PER_PAGE,
      onPrev: "prevThreadPage()", onNext: "nextThreadPage()", onJump: "jumpThreadPage"
    });
    errBox.textContent = "";
  }catch(e){
    list.innerHTML = "";
    pager.innerHTML = "";
    errBox.textContent = "読み込みに失敗しました。PocketBaseの設定（CORS/ルール）とコレクション名を確認してください。";
  }
}

function goCreateThread(){
  app.innerHTML = `
    <h2>新規スレッド作成</h2>
    <div class="form-card">
      <input id="threadTitle" placeholder="スレッドタイトル（必須）" />
      <textarea id="threadDesc" placeholder="スレッド説明（任意）"></textarea>
      <button class="btn" onclick="createThread()">作成</button>
      <button class="btn-secondary" onclick="backToList()">戻る</button>
    </div>
  `;
}

async function createThread(){
  if(!ensureCanPost()) return;
  const title = document.getElementById("threadTitle").value.trim();
  const desc = document.getElementById("threadDesc").value.trim();
  if(!title){ alert("タイトルを入力してください。"); return; }
  if(isDisallowedContent(title) || isDisallowedContent(desc)){
    alert("URL/メール等が含まれているため使用できません。");
    return;
  }

  try{
    const created = await pbSafe(()=>pb.collection("threads").create({
      title,
      desc,
      ownerViewerId: viewerId,
      isHidden: false
    }));
    enterThread(created.id);
  }catch(e){
    alert("スレッド作成に失敗しました。PocketBaseのCreateルールを確認してください。");
  }
}

function enterThread(id){
  state.page = "thread";
  state.currentThreadId = id;
  state.postPage = 1;
  replyContext = null;
  renderThreadPage();
}

/* =========================
   スレッド詳細（投稿一覧）
========================= */
async function renderThreadPage(){
  let thread = null;
  try{
    thread = await pbSafe(()=>pb.collection("threads").getOne(state.currentThreadId));
    if(thread.isHidden){
      backToList();
      return;
    }
  }catch{
    backToList();
    return;
  }

  app.innerHTML = `
    <div class="back-link" onclick="backToList()">← スレッド一覧へ</div>
    <div style="display:flex; align-items:center; gap:10px; flex-wrap:wrap;">
      <h2 style="margin:0;">${escapeHtml(thread.title)}</h2>
      <button class="btn-thread-report" onclick="openThreadReportDialog('${thread.id}')">通報</button>
    </div>
    <div style="color:#999;margin-bottom:10px;">${escapeHtml(thread.desc || "")}</div>

    <div class="form-card">
      <div id="replyBanner" class="reply-banner">
        <div>
          <div class="label">返信先</div>
          <div class="preview" id="replyPreview"></div>
        </div>
        <div class="right">
          <button class="btn-action" onclick="cancelReply()">解除</button>
        </div>
      </div>
      <input id="nameInput" placeholder="名前（任意。未入力なら『名無し』）" />
      <textarea id="bodyInput" placeholder="本文（必須）"></textarea>
      <button class="btn" onclick="postToThread()">投稿</button>
    </div>

    <h3 id="postCountTitle">投稿一覧</h3>
    <div id="postList"></div>
    <div id="postPager"></div>
  `;

  if(replyContext) showReplyBanner();
  await renderPosts();
}

function showReplyBanner(){
  const banner = document.getElementById("replyBanner");
  const preview = document.getElementById("replyPreview");
  if(!banner || !preview) return;
  const name = replyContext.name || "名無し";
  preview.textContent = `${name} / ${replyContext.snippet || ""}`;
  banner.style.display = "flex";
}
function cancelReply(){
  replyContext = null;
  const banner = document.getElementById("replyBanner");
  if(banner) banner.style.display = "none";
}

async function renderPosts(){
  const list = document.getElementById("postList");
  const pager = document.getElementById("postPager");
  const title = document.getElementById("postCountTitle");
  if(!list || !pager || !title) return;

  list.innerHTML = "";

  let res;
  try{
    res = await fetchPostsPage(state.currentThreadId, state.postPage);
  }catch{
    list.innerHTML = `<div style="color:#f2a3a3;">投稿の読み込みに失敗しました。</div>`;
    pager.innerHTML = "";
    title.textContent = "投稿一覧";
    return;
  }

  const total = Number(res.totalItems || 0);
  const totalPages = Math.max(1, Number(res.totalPages || 1));
  state.postPage = clampPage(state.postPage, totalPages);

  title.textContent = `投稿一覧（${total}件）`;

  if(total === 0){
    list.innerHTML = `<div style="color:#777;">まだ投稿がありません。</div>`;
    pager.innerHTML = "";
    return;
  }

  const items = res.items || [];

  const visible = items.filter(p=>{
    const name = (p.name && p.name.trim()) ? p.name.trim() : "名無し";
    if(bannedNames.includes(name)) return false;
    if(hiddenPostIds.includes(p.id)) return false;
    if(isDisallowedContent(name) || isDisallowedContent(p.body)) return false;
    return true;
  });

  if(visible.length === 0){
    list.innerHTML = `<div style="color:#777;">表示できる投稿がありません。</div>`;
  }else{
    visible.forEach((p)=>{
      const name = (p.name && p.name.trim()) ? p.name.trim() : "名無し";
      const canDeletePost = (p.viewerId && p.viewerId === viewerId); // ✅ 本人だけ

      const card = document.createElement("div");
      card.className = "post-card";
      card.setAttribute("data-post-id", p.id);

      card.innerHTML = `
        <div class="post-name"></div>
        <div class="post-date">${formatDate(new Date(p.created).getTime())}</div>
        <div class="post-body"></div>
        <div class="post-footer">
          <button class="btn-action" onclick="startReply('${p.id}')">返信</button>
          <button class="btn-action" onclick="openPostReportDialog('${p.id}')">通報</button>
          ${canDeletePost ? `<button class="btn-action" onclick="deletePost('${p.id}')">削除</button>` : ``}
        </div>
      `;

      card.querySelector(".post-name").textContent = name;
      card.querySelector(".post-body").textContent = p.body || "";

      /* ✅ 返信先：IDじゃなくて名前にする（保存済みの replyToName / replyToSnippet を使う） */
      if(p.replyToPostId){
        const rtName = (p.replyToName && String(p.replyToName).trim()) ? String(p.replyToName).trim() : "名無し";
        const rtSnip = (p.replyToSnippet && String(p.replyToSnippet).trim()) ? String(p.replyToSnippet).trim() : "";
        const chip = document.createElement("div");
        chip.className = "reply-to-chip";
        chip.innerHTML = `返信先：<b>${escapeHtml(rtName)}</b>${rtSnip ? " - " + escapeHtml(rtSnip) : ""}`;
        chip.onclick = (e)=>{ e.stopPropagation(); scrollToPost(p.replyToPostId); };
        card.insertBefore(chip, card.querySelector(".post-body"));
      }

      list.appendChild(card);
    });
  }

  pager.innerHTML = renderPager({
    page: state.postPage, total, perPage: POSTS_PER_PAGE,
    onPrev: "prevPostPage()", onNext: "nextPostPage()", onJump: "jumpPostPage"
  });
}

function scrollToPost(postId){
  const el = document.querySelector(`[data-post-id="${postId}"]`);
  if(!el){ alert("返信先の投稿が見つかりません（別ページの可能性）"); return; }
  el.scrollIntoView({ behavior:"smooth", block:"center" });
  const old = el.style.boxShadow;
  el.style.boxShadow = "0 0 0 2px rgba(102,255,153,.35), 0 12px 40px rgba(0,0,0,.45)";
  setTimeout(()=>{ el.style.boxShadow = old; }, 900);
}

async function startReply(postId){
  try{
    const p = await pbSafe(()=>pb.collection("posts").getOne(postId));
    const name = (p.name && p.name.trim()) ? p.name.trim() : "名無し";
    replyContext = {
      postId: p.id,
      name,
      snippet: toSnippet(p.body || "", 48)
    };
    showReplyBanner();
    document.getElementById("bodyInput")?.focus();
  }catch{
    alert("返信先の取得に失敗しました。");
  }
}

async function postToThread(){
  if(!ensureCanPost()) return;

  const nameRaw = document.getElementById("nameInput").value.trim();
  const body = document.getElementById("bodyInput").value.trim();
  const name = nameRaw || "名無し";

  if(!body){ alert("本文を入力してください。"); return; }

  // ✅ 判定は「URL/メール/強NGのみ」
  if(isDisallowedContent(name) || isDisallowedContent(body)){
    alert("URL/メール/強いNG表現が含まれているため投稿できません。");
    return;
  }

  try{
    await pbSafe(()=>pb.collection("posts").create({
      thread: state.currentThreadId,
      name,
      body,
      viewerId: viewerId,
      replyToPostId: replyContext?.postId || "",
      replyToName: replyContext?.name || "",
      replyToSnippet: replyContext?.snippet || "",
      isHidden: false
    }));

    document.getElementById("bodyInput").value = "";
    replyContext = null;

    state.postPage = 1;
    await renderThreadPage();
  }catch(e){
    alert("投稿に失敗しました。postsのCreateルールを確認してください。");
  }
}

/* ✅ 投稿削除：本人だけ & PB上で isHidden=true */
async function deletePost(postId){
  if(!confirm("この投稿を削除しますか？（PocketBase上でも非表示になります）")) return;

  try{
    const p = await pbSafe(()=>pb.collection("posts").getOne(postId));
    if(!p.viewerId || p.viewerId !== viewerId){
      alert("この投稿はあなたの投稿ではないため削除できません。");
      return;
    }

    await hidePostInPB(postId);
    if(!hiddenPostIds.includes(postId)) hiddenPostIds.push(postId);
    saveLocalModeration();

    await renderPosts();
  }catch{
    alert("削除に失敗しました。posts の Update rule を確認してください。");
  }
}

/* =========================
   通報モーダル
========================= */
const reportOverlay = document.getElementById("reportOverlay");
const reportTitle = document.getElementById("reportTitle");
const reportCancelBtn = document.getElementById("reportCancelBtn");

reportCancelBtn?.addEventListener("click", ()=>closeReportDialog());
reportOverlay?.addEventListener("click", (e)=>{ if(e.target === reportOverlay) closeReportDialog(); });

document.querySelectorAll(".report-reasons button").forEach(btn=>{
  btn.addEventListener("click", async ()=>{
    const reason = btn.getAttribute("data-reason") || "その他";
    await submitReport(reason);
  });
});

function openPostReportDialog(postId){
  reportContext.type = "post";
  reportContext.threadId = state.currentThreadId;
  reportContext.postId = postId;
  reportTitle.textContent = "この投稿を通報しますか？";
  reportOverlay.style.display = "flex";
}
function openThreadReportDialog(threadId){
  reportContext.type = "thread";
  reportContext.threadId = threadId;
  reportContext.postId = null;
  reportTitle.textContent = "このスレッドを通報しますか？";
  reportOverlay.style.display = "flex";
}
function closeReportDialog(){
  reportContext.type = null;
  reportContext.threadId = null;
  reportContext.postId = null;
  reportOverlay.style.display = "none";
}

async function submitReport(reason){
  if(reportContext.type === "post") await submitPostReport(reason);
  else if(reportContext.type === "thread") await submitThreadReport(reason);
}

async function submitPostReport(reason){
  const postId = reportContext.postId;
  if(!postId){ closeReportDialog(); return; }

  try{
    if(await alreadyReported("post", postId)){
      alert("この投稿は既に通報済みです。");
      closeReportDialog();
      return;
    }

    await createReport("post", postId, reason);

    const p = await pbSafe(()=>pb.collection("posts").getOne(postId));
    addUserReport(p.viewerId);

    const c = await countReports("post", postId);
    if(c >= REPORT_THRESHOLD){
      const authorName = (p.name && p.name.trim()) ? p.name.trim() : "名無し";
      if(!hiddenPostIds.includes(postId)) hiddenPostIds.push(postId);
      if(!bannedNames.includes(authorName)) bannedNames.push(authorName);
      saveLocalModeration();
      alert("通報が一定数に達したため、この投稿は自動的に非表示となり、同じ名前の投稿は制限されます。");
    }else{
      alert("通報を受け付けました。");
    }

    closeReportDialog();
    renderPosts();
  }catch{
    alert("通報に失敗しました。bbs_reports の Create ルールを確認してください。");
    closeReportDialog();
  }
}

async function submitThreadReport(reason){
  const threadId = reportContext.threadId;
  if(!threadId){ closeReportDialog(); return; }

  try{
    if(await alreadyReported("thread", threadId)){
      alert("このスレッドは既に通報済みです。");
      closeReportDialog();
      return;
    }

    await createReport("thread", threadId, reason);

    const t = await pbSafe(()=>pb.collection("threads").getOne(threadId));
    addUserReport(t.ownerViewerId);

    const c = await countReports("thread", threadId);

    if(c >= THREAD_REPORT_THRESHOLD){
      try{
        await hideThreadInPB(threadId);
      }catch{
        alert("通報は成立しましたが、threads の Update rule が原因で非表示にできませんでした。");
        closeReportDialog();
        return;
      }

      alert("通報が一定数に達したため、このスレッドは自動的に非表示になりました。");
      closeReportDialog();
      backToList();
      return;
    }

    alert("通報を受け付けました。");
    closeReportDialog();
  }catch{
    alert("通報に失敗しました。bbs_reports の Create ルールを確認してください。");
    closeReportDialog();
  }
}

function backToList(){
  state.page = "list";
  state.currentThreadId = null;
  replyContext = null;
  render();
}

/* HTMLエスケープ */
function escapeHtml(s){
  return String(s ?? "")
    .replaceAll("&","&amp;")
    .replaceAll("<","&lt;")
    .replaceAll(">","&gt;")
    .replaceAll('"',"&quot;")
    .replaceAll("'","&#039;");
}

render();
</script>

</body>
</html>
