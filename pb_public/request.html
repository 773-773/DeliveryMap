<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>店舗申請フォーム（PocketBase版）</title>
<style>
body { font-family:sans-serif; margin:0; padding:12px; background:#0d0d0d; color:#fff; }
h2 { color:#66ff99; font-size:18px; margin-bottom:12px; }
label { display:block; margin-top:8px; margin-bottom:4px; font-size:0.85em; }
input, select, button { width:100%; padding:6px; border-radius:6px; border:1px solid #333; font-size:0.85em; }
input, select { background:#111; color:#fff; }
button { background:#ff6600; color:#fff; border:none; cursor:pointer; margin-top:12px; }
small { display:block; font-size:0.7em; color:#ccc; margin-top:2px; }
#nameSuggestions { background:#111; color:#fff; list-style:none; padding:4px; margin:0; border:1px solid #333; border-radius:4px; max-height:120px; overflow-y:auto; position:absolute; display:none; z-index:1000; }
#nameSuggestions li { padding:2px 4px; cursor:pointer; }
#nameSuggestions li:hover { background:#333; }
</style>
</head>
<body>

<h2>掲載店舗を申請する</h2>
<small>※店舗名は正式名称で入力してください</small>

<label>店舗名（必須）</label>
<input type="text" id="reqName" placeholder="例：マクドナルド 渋谷店" autocomplete="off">
<ul id="nameSuggestions"></ul>

<label>都道府県（必須）</label>
<select id="reqPref">
  <option value="">都道府県を選択</option>
</select>

<label>市区町村（必須）</label>
<select id="reqCity" style="display:none">
  <option value="">市区町村を選択</option>
</select>

<label>以下住所（必須）</label>
<input type="text" id="reqAddress" placeholder="例：道玄坂2-11-1">

<button id="submitRequest" disabled>申請する</button>

<script type="module">
import PocketBase from "https://cdn.jsdelivr.net/npm/pocketbase@0.21.2/dist/pocketbase.es.mjs";
const pb = new PocketBase("https://delivery-eye.onrender.com");

// ===== DOM =====
const reqName = document.getElementById("reqName");
const nameSuggestions = document.getElementById("nameSuggestions");
const reqPref = document.getElementById("reqPref");
const reqCity = document.getElementById("reqCity");
const reqAddress = document.getElementById("reqAddress");
const submitBtn = document.getElementById("submitRequest");

// ===== 都道府県リスト =====
const prefectures = [
"北海道","青森県","岩手県","宮城県","秋田県","山形県","福島県",
"茨城県","栃木県","群馬県","埼玉県","千葉県","東京都","神奈川県",
"新潟県","富山県","石川県","福井県","山梨県","長野県",
"岐阜県","静岡県","愛知県","三重県",
"滋賀県","京都府","大阪府","兵庫県","奈良県","和歌山県",
"鳥取県","島根県","岡山県","広島県","山口県",
"徳島県","香川県","愛媛県","高知県",
"福岡県","佐賀県","長崎県","熊本県","大分県","宮崎県","鹿児島県","沖縄県"
];
prefectures.forEach(p=>{
  const opt=document.createElement("option");
  opt.value=p;
  opt.textContent=p;
  reqPref.appendChild(opt);
});

// ===== 匿名ID（ローカルブラウザごと） =====
let browserId = localStorage.getItem("browserId");
if(!browserId){
  browserId="id-"+Math.random().toString(36).substring(2)+Date.now();
  localStorage.setItem("browserId", browserId);
}
submitBtn.disabled=false;

// ===== 店舗名補完のために stores 一覧取得 =====
let allStores = [];
async function fetchStoreNames(){
  try{
    const list = await pb.collection("stores").getList(1,200);
    allStores = list.items;
  }catch(e){ console.error("店舗リスト取得失敗",e); }
}
fetchStoreNames();

// 入力補助
reqName.addEventListener("input", ()=>{
  const val=reqName.value.trim().toLowerCase();
  nameSuggestions.innerHTML="";
  if(!val){ nameSuggestions.style.display="none"; return; }
  const matches = allStores
    .filter(s=>s.name && s.name.toLowerCase().includes(val))
    .slice(0,10);
  matches.forEach(s=>{
    const li=document.createElement("li");
    li.textContent=s.name;
    li.addEventListener("click",()=>{
      reqName.value=s.name;
      nameSuggestions.style.display="none";
    });
    nameSuggestions.appendChild(li);
  });
  nameSuggestions.style.display = matches.length ? "block" : "none";
});
document.addEventListener("click", e=>{
  if(!nameSuggestions.contains(e.target) && e.target!==reqName){
    nameSuggestions.style.display="none";
  }
});

// ===== 都道府県選択で市区町村リスト生成 =====
reqPref.onchange = async ()=>{
  const pref=reqPref.value;
  reqCity.innerHTML=`<option value="">市区町村を選択</option>`;
  if(!pref){ reqCity.style.display="none"; return; }

  try{
    const list = await pb.collection("stores").getList(1,200,{ filter:`prefecture="${pref}"` });
    const cities=[...new Set(list.items.map(s=>s.city).filter(Boolean))].sort();
    cities.forEach(c=>{
      const opt=document.createElement("option");
      opt.value=c;
      opt.textContent=c;
      reqCity.appendChild(opt);
    });
    reqCity.style.display=cities.length?"block":"none";
  }catch(e){
    console.error("市区町村取得失敗",e);
  }
};

// ===== 申請処理 =====
submitBtn.onclick = async ()=>{
  const name=reqName.value.trim();
  const pref=reqPref.value;
  const city=reqCity.value;
  const addr=reqAddress.value.trim();
  if(!name || !pref || !city || !addr){
    alert("必須項目をすべて入力してください");
    return;
  }

  // 重複チェック
  try{
    const existing = await pb.collection("stores").getList(1,200,{
      filter:`name="${name}" && prefecture="${pref}" && city="${city}"`
    });
    if(existing.items.length>0){
      alert("この店舗はすでに登録されています");
      return;
    }

    // storeRequests へ登録
    await pb.collection("storeRequests").create({
      browserId,
      name,
      prefecture:pref,
      city,
      address:addr,
      createdAt:new Date().toISOString()
    });

    alert("申請完了しました。管理者承認後に表示されます。");

    // フォームリセット
    reqName.value="";
    reqPref.value="";
    reqCity.innerHTML=`<option value="">市区町村を選択</option>`;
    reqCity.style.display="none";
    reqAddress.value="";
  }catch(e){
    console.error("申請エラー",e);
    alert("申請に失敗しました。");
  }
};
</script>
</body>
</html>
