<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>店舗申請フォーム</title>

<style>
  :root{
    --bg:#0d0d0d;
    --panel:#111;
    --hair:#222;
    --muted:#bdbdbd;
    --text:#fff;
    --input:#1a1a1a;
    --border:#333;
    --accent:#ffa500;
    --ok:#66ff99;
    --ng:#ff6666;
  }
  *{ box-sizing:border-box; }
  body{
    margin:0;
    padding:10px;
    background:var(--bg);
    color:var(--text);
    font-family:-apple-system,BlinkMacSystemFont,"Noto Sans JP",system-ui,sans-serif;
  }
  header{
    display:flex;
    justify-content:space-between;
    align-items:center;
    padding:8px;
    background:var(--panel);
    border-bottom:1px solid var(--hair);
    position:sticky;
    top:0;
    z-index:10;
  }
  header .status{ font-size:.8em;color:var(--muted); }
  #logoutBtn{
    display:none;
    background:#333;color:#fff;border:none;
    padding:6px 10px;border-radius:8px;
    cursor:pointer;font-weight:800;font-size:.8em;
  }

  main{ max-width:720px; margin:10px auto 30px; }
  h2{ margin:12px 0 6px; }

  .desc{
    background:var(--panel);
    border:1px solid var(--hair);
    border-radius:10px;
    padding:10px;
    color:var(--muted);
    font-size:.85em;
    line-height:1.6;
    margin-bottom:12px;
  }

  .card{
    background:var(--panel);
    border:1px solid var(--hair);
    border-radius:12px;
    padding:14px;
  }

  .row{ margin-bottom:10px; position:relative; }
  label{
    display:block;
    font-size:.85em;
    margin-bottom:6px;
  }
  .req{ color:var(--ng); font-size:.8em; margin-left:6px; }

  input, select, textarea{
    width:100%;
    padding:10px 12px;
    border-radius:10px;
    border:1px solid var(--border);
    background:var(--input);
    color:var(--text);
    font-size:.95em;
    outline:none;
  }
  textarea{ min-height:90px; resize:vertical; }

  #submitBtn{
    width:100%;
    margin-top:8px;
    padding:12px;
    border:none;
    border-radius:12px;
    background:var(--accent);
    color:#000;
    font-weight:900;
    cursor:pointer;
  }
  #submitBtn:disabled{ opacity:.55; cursor:not-allowed; }

  #messageBox{
    margin-top:10px;
    white-space:pre-wrap;
    line-height:1.45;
    font-size:.85em;
  }
  .msg-success{ color:var(--ok); }
  .msg-error{ color:var(--ng); }

  /* 店舗名サジェスト */
  #nameSuggestions{
    display:none;
    position:absolute;
    left:0;
    right:0;
    top:calc(100% + 6px);
    list-style:none;
    margin:0;
    padding:6px;
    border-radius:10px;
    border:1px solid var(--border);
    background:rgba(17,17,17,0.98);
    max-height:180px;
    overflow:auto;
    z-index:50;
  }
  #nameSuggestions li{
    padding:8px 10px;
    border-radius:8px;
    cursor:pointer;
    font-size:.92em;
    color:rgba(255,255,255,0.92);
  }
  #nameSuggestions li:hover{ background:rgba(255,255,255,0.06); }

  /* ✅ 完了後の戻るボタン */
  #backWrap{
    display:none;
    margin-top:10px;
  }
  #backBtn{
    width:100%;
    padding:12px;
    border-radius:12px;
    border:1px solid rgba(255,255,255,0.14);
    background:rgba(255,255,255,0.06);
    color:#fff;
    font-weight:900;
    cursor:pointer;
  }
  #backBtn:hover{ filter:brightness(1.06); }
</style>
</head>

<body>
<header>
  <div class="status" id="userStatus">未ログイン</div>
  <button id="logoutBtn">ログアウト</button>
</header>

<main>
  <h2>掲載店舗を申請する</h2>
  <div class="desc">
    未掲載の店舗を運営に申請するページです。<br>
    申請内容は運営側で確認後、掲載します。<br>
    ※店舗名は正式名称で入力してください。
  </div>

  <div class="card">
    <form id="requestForm">
      <div class="row">
        <label>店舗名 <span class="req">※必須</span></label>
        <input id="nameInput" type="text" placeholder="例：マクドナルド 渋谷店" autocomplete="off">
        <ul id="nameSuggestions" aria-label="店舗名候補"></ul>
      </div>

      <div class="row">
        <label>都道府県 <span class="req">※必須</span></label>
        <select id="prefSelect"><option value="">選択してください</option></select>
      </div>

      <div class="row">
        <label>市区町村 <span class="req">※必須</span></label>
        <input id="cityInput" type="text" placeholder="例）渋谷区、港区、横浜市西区">
      </div>

      <div class="row">
        <label>以下住所 <span class="req">※必須</span></label>
        <input id="addressInput" type="text" placeholder="例：道玄坂2-11-1">
      </div>

      <button id="submitBtn" type="submit">この内容で申請する</button>

      <div id="messageBox"></div>

      <!-- ✅ 申請成功後だけ出す -->
      <div id="backWrap">
        <button type="button" id="backBtn">前のページに戻る</button>
      </div>
    </form>
  </div>
</main>

<script type="module">
import PocketBase from "https://cdn.jsdelivr.net/npm/pocketbase@0.21.2/dist/pocketbase.es.mjs";

const pb = new PocketBase("https://delivery-eye.onrender.com");
if (typeof pb.autoCancellation === "function") pb.autoCancellation(false);

const $ = (id)=>document.getElementById(id);

/* ===== DOM ===== */
const userStatus = $("userStatus");
const logoutBtn  = $("logoutBtn");

const form    = $("requestForm");
const submit  = $("submitBtn");
const msgBox  = $("messageBox");

const nameEl  = $("nameInput");
const prefEl  = $("prefSelect");
const cityEl  = $("cityInput");
const addrEl  = $("addressInput");

const suggBox = $("nameSuggestions");

const backWrap = $("backWrap");
const backBtn  = $("backBtn");

/* ===== ページ/遷移設定 ===== */
const THIS_PAGE = "request.html";
const LOGIN_PAGE = "login.html";
const KEY_NEXT_STORE = "fdel_next_url_v1";

/* ===== 自動申請の“戻り判定”フラグ ===== */
const LOGIN_RETURN_FLAG = "fde_from_login_v1";
const PENDING_KEY = "fde_pending_store_request_v1";

/* ===== 都道府県 ===== */
const prefs = [
  "北海道","青森県","岩手県","宮城県","秋田県","山形県","福島県",
  "茨城県","栃木県","群馬県","埼玉県","千葉県","東京都","神奈川県",
  "新潟県","富山県","石川県","福井県","山梨県","長野県","岐阜県",
  "静岡県","愛知県","三重県","滋賀県","京都府","大阪府","兵庫県",
  "奈良県","和歌山県","鳥取県","島根県","岡山県","広島県","山口県",
  "徳島県","香川県","愛媛県","高知県","福岡県","佐賀県","長崎県",
  "熊本県","大分県","宮崎県","鹿児島県","沖縄県"
];
for(const p of prefs){
  const o=document.createElement("option");
  o.value=p; o.textContent=p;
  prefEl.appendChild(o);
}

function hideBack(){
  backWrap.style.display = "none";
}
function showBack(){
  backWrap.style.display = "block";
}

function showMsg(text,type="success"){
  msgBox.textContent = text;
  msgBox.className = type==="success" ? "msg-success" : "msg-error";
}

backBtn.addEventListener("click", ()=>{
  // 履歴があれば戻る。無ければ index.html に戻す保険
  if (window.history.length > 1) {
    window.history.back();
  } else {
    window.location.href = "index.html";
  }
});

/* ===== ログイン表示 ===== */
function updateStatus(){
  if(pb.authStore.isValid){
    userStatus.textContent = "ログイン中：" + (pb.authStore.model?.email || "");
    logoutBtn.style.display = "inline-block";
  }else{
    userStatus.textContent = "未ログイン";
    logoutBtn.style.display = "none";
  }
}
updateStatus();

logoutBtn.onclick = ()=>{
  pb.authStore.clear();
  updateStatus();
  hideBack();
  showMsg("ログアウトしました。","success");
};

/* ===== 匿名ID（ローカルブラウザごと） ===== */
let browserId = localStorage.getItem("browserId");
if(!browserId){
  browserId = "id-" + Math.random().toString(36).slice(2) + Date.now();
  localStorage.setItem("browserId", browserId);
}

/* ===== 店舗名サジェスト（stores から取得） ===== */
let allStores = [];

async function fetchAllStoreNames(){
  allStores = [];
  try{
    let page = 1;
    const perPage = 200;
    while(true){
      const list = await pb.collection("stores").getList(page, perPage, { sort:"name" });
      allStores.push(...(list.items || []));
      if(page >= (list.totalPages || 1)) break;
      page++;
      if(page > 20) break;
    }
  }catch(e){
    console.error("店舗リスト取得失敗", e);
  }
}
fetchAllStoreNames();

function renderSuggestions(keyword){
  const val = keyword.trim().toLowerCase();
  suggBox.innerHTML = "";
  if(!val){
    suggBox.style.display="none";
    return;
  }
  const matches = allStores
    .filter(s => s?.name && String(s.name).toLowerCase().includes(val))
    .slice(0, 10);

  for(const s of matches){
    const li = document.createElement("li");
    li.textContent = s.name;
    li.addEventListener("click", ()=>{
      nameEl.value = s.name;
      suggBox.style.display="none";
    });
    suggBox.appendChild(li);
  }
  suggBox.style.display = matches.length ? "block" : "none";
}

nameEl.addEventListener("input", ()=> renderSuggestions(nameEl.value));
document.addEventListener("click", (e)=>{
  if(!suggBox.contains(e.target) && e.target !== nameEl){
    suggBox.style.display="none";
  }
});

/* ===== フィルタ用エスケープ ===== */
function escapeFilter(s){
  return String(s ?? "")
    .replaceAll("\\","\\\\")
    .replaceAll('"','\\"')
    .replaceAll("'","\\'");
}

/* ===== pending 保存/復元 ===== */
function savePending(payload){
  try{ sessionStorage.setItem(PENDING_KEY, JSON.stringify(payload)); }catch{}
}
function loadPending(){
  try{
    const raw = sessionStorage.getItem(PENDING_KEY);
    if(!raw) return null;
    return JSON.parse(raw);
  }catch{ return null; }
}
function clearPending(){
  try{ sessionStorage.removeItem(PENDING_KEY); }catch{}
}

/* ===== loginへ ===== */
function goLogin(){
  try { localStorage.setItem(KEY_NEXT_STORE, THIS_PAGE); } catch {}
  window.location.href = `${LOGIN_PAGE}?next=${encodeURIComponent(THIS_PAGE)}`;
}

/* ===== 申請保存コレクションを自動判定（404対策） ===== */
const REQUEST_COLLECTION_CANDIDATES = [
  "storeRequests",
  "store_requests",
  "storeRequest",
  "store_request"
];

let resolvedRequestCollection = null;

async function resolveRequestCollection(){
  if(resolvedRequestCollection) return resolvedRequestCollection;

  for(const col of REQUEST_COLLECTION_CANDIDATES){
    try{
      await pb.collection(col).getList(1, 1, { perPage: 1 });
      resolvedRequestCollection = col;
      return col;
    }catch(e){
      if(Number(e?.status) === 404) continue;
      if(Number(e?.status) === 403){
        resolvedRequestCollection = col;
        return col;
      }
      continue;
    }
  }
  return null;
}

/* ===== 申請処理（本体）===== */
async function submitRequest(payload){
  const { name, pref, city, address } = payload;

  const reqCol = await resolveRequestCollection();
  if(!reqCol){
    throw new Error(
      "PocketBase側に申請用コレクションが見つかりません。\n候補: " +
      REQUEST_COLLECTION_CANDIDATES.join(", ")
    );
  }

  // 重複チェック（storesに同一 name + prefecture + city があるか）
  try{
    const existing = await pb.collection("stores").getList(1, 1, {
      filter:`name="${escapeFilter(name)}" && prefecture="${escapeFilter(pref)}" && city="${escapeFilter(city)}"`
    });
    if((existing.items || []).length > 0){
      throw new Error("この店舗はすでに登録されています。");
    }
  }catch(checkErr){
    if(String(checkErr?.message || "").includes("すでに登録")) throw checkErr;
    console.warn("重複チェック失敗（フィールド名違い等の可能性）", checkErr);
  }

  await pb.collection(reqCol).create({
    browserId,
    name,
    prefecture: pref,
    city,
    address,
    userEmail: pb.authStore.model?.email || ""
  });
}

/* =========================
   ★自動申請：loginから“戻ってきた時だけ”実行
========================= */
(async ()=>{
  updateStatus();

  const pending = loadPending();
  const fromLogin = sessionStorage.getItem(LOGIN_RETURN_FLAG);

  if(pb.authStore.isValid && pending && fromLogin === "1"){
    try{
      submit.disabled = true;
      hideBack();
      showMsg("ログイン完了。申請を自動送信中…","success");

      try{ await pb.collection("users").authRefresh(); }catch{}

      await submitRequest(pending);

      showMsg("申請が完了しました！","success");
      showBack();

      form.reset();
      suggBox.style.display = "none";
      clearPending();

    }catch(err){
      console.error(err);
      hideBack();
      showMsg("自動申請に失敗しました。\n\n--- 詳細 ---\n" + (err?.message || err), "error");
    }finally{
      submit.disabled = false;
      sessionStorage.removeItem(LOGIN_RETURN_FLAG);
    }
  }else{
    // フラグ無しの残骸は勝手に送らない＆消す
    if(pending && fromLogin !== "1"){
      clearPending();
    }
  }
})();

/* ===== submit ===== */
form.onsubmit = async (e)=>{
  e.preventDefault();
  msgBox.textContent = "";
  hideBack();

  const payload = {
    name: nameEl.value.trim(),
    pref: prefEl.value,
    city: cityEl.value.trim(),
    address: addrEl.value.trim()
  };

  if(!payload.name || !payload.pref || !payload.city || !payload.address){
    showMsg("必須項目が未入力です。","error");
    return;
  }

  // 未ログイン：申請内容を保存して login.html へ
  if(!pb.authStore.isValid){
    savePending(payload);
    try{ sessionStorage.setItem(LOGIN_RETURN_FLAG, "1"); }catch{}
    showMsg("ログインが必要です。ログイン画面へ移動します…","error");
    setTimeout(goLogin, 120);
    return;
  }

  // ログイン済み：通常申請
  try{
    submit.disabled = true;
    showMsg("送信中…","success");

    await submitRequest(payload);

    clearPending();
    sessionStorage.removeItem(LOGIN_RETURN_FLAG);

    showMsg("申請が完了しました！","success");
    showBack();

    form.reset();
    suggBox.style.display = "none";

  }catch(err){
    console.error("PB error:", err);
    hideBack();

    const status = err?.status ? `status: ${err.status}\n` : "";
    const msg = err?.message ? `message: ${err.message}\n` : "";
    const dataMsg = err?.data?.message ? `data.message: ${err.data.message}\n` : "";
    const data = err?.data ? JSON.stringify(err.data, null, 2) : "";

    showMsg(
      "申請に失敗しました。\n\n--- 詳細 ---\n" +
      status + msg + dataMsg + (data ? ("\n" + data) : ""),
      "error"
    );
  }finally{
    submit.disabled = false;
  }
};
</script>

</body>
</html>
