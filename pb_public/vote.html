<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>調理待ち時間（投票＋口コミ＋お気に入り） - FoodDeliveryEye</title>

<style>
:root{
  --bg-main:#07070b;
  --bg-elevated:#0c0c12;
  --accent:#5bff9c;
  --accent-soft:rgba(91,255,156,0.28);
  --accent2:#23ffd1;
  --text-main:#f5f5f7;
  --text-muted:rgba(245,245,247,0.62);
  --border-soft:rgba(255,255,255,0.08);
  --border-hair:rgba(255,255,255,0.06);
  --shadow-deep:0 26px 90px rgba(0,0,0,0.78);
}

*{ box-sizing:border-box; }
html,body{ height:100%; }
body{
  margin:0;
  padding:0;
  font-family:-apple-system,BlinkMacSystemFont,"Inter","Noto Sans JP",sans-serif;
  color:var(--text-main);
  background:
    radial-gradient(circle at 18% 0%, rgba(91,255,156,0.09) 0, transparent 55%),
    radial-gradient(circle at 90% 90%, rgba(255,255,255,0.03) 0, transparent 55%),
    linear-gradient(180deg, #050507 0%, #07070b 60%, #050507 100%);
}
.page{
  max-width:1040px;
  margin:0 auto;
  padding:18px 14px 42px;
}

/* =========================
   ✅ ヘッダー（共通）
========================= */
header.siteHeader{
  display:flex;
  align-items:center;
  justify-content:space-between;
  gap:12px;
  padding:12px 14px;
  border-radius:18px;
  background:rgba(5,5,8,0.72);
  border:1px solid var(--border-hair);
  backdrop-filter:blur(22px);
  box-shadow:0 18px 60px rgba(0,0,0,0.62);
  margin-bottom:18px;
  position:relative;
  z-index:50;
}
.logoArea{ display:flex; align-items:center; min-width:0; }
.logoLink{ display:inline-block; min-width:0; color:inherit; text-decoration:none; }
.logoTextMain{
  font-weight:900;
  font-size:18px;
  letter-spacing:0.06em;
  white-space:nowrap;
  overflow:hidden;
  text-overflow:ellipsis;
}
.logoTextSub{
  font-size:12px;
  line-height:1.5;
  color:rgba(245,245,247,0.55);
  white-space:nowrap;
  overflow:hidden;
  text-overflow:ellipsis;
  margin-top:2px;
}
.headerRight{ display:flex; align-items:center; gap:10px; flex:0 0 auto; min-width:0; }
nav{ display:flex; align-items:center; gap:8px; flex-wrap:wrap; }
nav a, nav button{
  color:var(--text-muted);
  text-decoration:none;
  padding:8px 12px;
  border-radius:999px;
  border:1px solid rgba(255,255,255,0.06);
  background:rgba(255,255,255,0.02);
  font-size:12px;
  line-height:1;
  transition:all .16s ease;
  white-space:nowrap;
  cursor:pointer;
  font-family:inherit;
}
nav a:hover, nav button:hover{ color:var(--text-main); background:rgba(255,255,255,0.05); }
nav .primary{
  color:#050814;
  background:var(--accent);
  border-color:transparent;
  font-weight:900;
  box-shadow:0 0 18px var(--accent-soft);
}
nav .primary:hover{ background:#7affb2; }
nav button{ appearance:none; -webkit-appearance:none; }

/* ログイン中ピル（緑に発光） */
.loggedPill{
  display:inline-flex !important;
  align-items:center;
  gap:8px;
  color:#07110a !important;
  background:linear-gradient(180deg, rgba(91,255,156,0.95), rgba(91,255,156,0.78)) !important;
  border-color:rgba(91,255,156,0.18) !important;
  box-shadow:0 0 18px rgba(91,255,156,0.22), 0 12px 28px rgba(0,0,0,0.45);
  font-weight:900;
}
.loggedLamp{
  width:10px; height:10px; border-radius:50%;
  background:var(--accent);
  box-shadow:0 0 10px rgba(91,255,156,0.9), 0 0 24px rgba(91,255,156,0.38);
  position:relative;
}
.loggedLamp::after{
  content:"";
  position:absolute;
  inset:-8px;
  border-radius:999px;
  border:1px solid rgba(91,255,156,0.25);
  animation:pulse 1.6s ease-in-out infinite;
  opacity:.65;
}
@keyframes pulse{
  0%{ transform:scale(0.72); opacity:0.25; }
  55%{ transform:scale(1.08); opacity:0.75; }
  100%{ transform:scale(1.35); opacity:0; }
}
.logoutPill{
  color:rgba(245,245,247,0.88) !important;
  border-color:rgba(255,255,255,0.10) !important;
  background:rgba(255,255,255,0.03) !important;
}
.logoutPill:hover{ border-color:rgba(91,255,156,0.18) !important; }

@media (max-width:640px){
  header.siteHeader{ flex-direction:column; align-items:stretch; gap:10px; }
  .headerRight{ flex-direction:column; align-items:stretch; gap:10px; }
  nav a, nav button{ padding:12px 14px; font-size:14px; }
}

/* =========================
   ✅ ログアウト確認モーダル
========================= */
.confirmModal{
  display:none;
  position:fixed;
  inset:0;
  background:rgba(0,0,0,0.72);
  justify-content:center;
  align-items:center;
  z-index:10000;
  padding:14px;
}
.confirmBox{
  width:min(420px, 100%);
  background:rgba(15,16,20,0.92);
  border:1px solid rgba(255,255,255,0.10);
  border-radius:16px;
  padding:16px;
  box-shadow:0 22px 80px rgba(0,0,0,0.72);
  backdrop-filter:blur(18px);
}
.confirmTitle{
  margin:0 0 8px;
  font-size:16px;
  font-weight:900;
  letter-spacing:.02em;
}
.confirmText{
  margin:0 0 12px;
  color:rgba(245,245,247,0.68);
  line-height:1.5;
  font-size:13px;
}
.confirmActions{
  display:flex;
  gap:10px;
  justify-content:flex-end;
  flex-wrap:wrap;
}
.confirmBtn{
  padding:10px 12px;
  border-radius:12px;
  border:1px solid rgba(255,255,255,0.10);
  background:rgba(255,255,255,0.04);
  color:rgba(245,245,247,0.9);
  font-weight:900;
  cursor:pointer;
  font-family:inherit;
}
.confirmBtn:hover{ background:rgba(255,255,255,0.07); }
.confirmBtnDanger{
  border-color:rgba(255,150,150,0.25);
  background:rgba(255,150,150,0.10);
  color:#ffdede;
}
.confirmBtnDanger:hover{ background:rgba(255,150,150,0.16); }

/* =========================
   ▼ 本文
========================= */
h2 { margin:12px 0 6px; }
h2 small { display:block; font-size:0.7em; color:#bbb; margin-top:2px; }

#requestBtn {
  display:inline-block;
  margin:6px 0 10px;
  font-size:0.85em;
  color:#66ff99;
  background:none;
  border:none;
  text-decoration:underline;
  cursor:pointer;
}

/* 検索 */
.searchContainer {
  display:flex;
  flex-direction:column;
  gap:10px;
  margin-bottom:10px;
}
.searchContainer div { display:flex; gap:8px; flex-wrap:wrap; }
.searchContainer input,
.searchContainer select{
  padding:10px;
  border-radius:10px;
  border:1px solid #333;
  background:#0f0f12;
  color:#fff;
  font-size:0.95em;
}
.searchContainer button{
  padding:10px 14px;
  border-radius:10px;
  border:1px solid #333;
  background:#ffa500;
  color:#000;
  cursor:pointer;
  font-size:0.95em;
  font-weight:800;
}
.favFilter{
  font-size:0.9em;
  color:#ccc;
  display:flex;
  align-items:center;
  gap:8px;
}

/* 店舗カード */
.storeCard{
  position:relative;
  background:#0f1014;
  border:1px solid #222;
  border-radius:14px;
  padding:12px;
  margin-bottom:12px;
  box-shadow:0 10px 24px rgba(0,0,0,0.35);
  display:flex;
  flex-direction:column;
  gap:8px;
}
.storeName{ font-weight:900; font-size:1.05em; color:#66ff99; }
.address{ font-size:0.85em; color:#bbb; margin-top:2px; }

/* 住所リンク */
.addressLink{
  color:inherit;
  text-decoration:underline;
  text-decoration-color:rgba(255,255,255,0.18);
  text-underline-offset:3px;
  text-decoration-thickness:1px;
  cursor:pointer;
}
.addressLink:hover{ text-decoration-color:rgba(91,255,156,0.35); }

.avgRating{ font-size:0.9em; color:#ccc; margin-top:2px; }

.voteContainer{ display:flex; gap:8px; flex-wrap:wrap; align-items:center; }
.voteContainer select{
  padding:8px 10px;
  border-radius:10px;
  border:1px solid #333;
  background:#111;
  color:#fff;
}
.voteContainer button{
  padding:8px 12px;
  border-radius:10px;
  border:1px solid #333;
  background:#eee;
  color:#000;
  cursor:pointer;
  font-weight:900;
}
.voteCount{ color:#ff6600; font-weight:900; }

.rightColumn{
  margin-top:4px;
  background:#15161b;
  border:1px solid rgba(255,255,255,.06);
  padding:10px;
  border-radius:12px;
  font-size:0.85em;
}

.accordion{
  width:100%;
  text-align:left;
  margin-top:8px;
  padding:10px 10px;
  background:#2a2a2f;
  color:#fff;
  border:none;
  border-radius:10px;
  cursor:pointer;
  font-weight:800;
}
.panel{
  display:none;
  background:#1a1a1f;
  border-radius:10px;
  padding:10px;
  margin-top:6px;
  color:#ccc;
  font-size:0.85em;
}

/* 口コミ */
.reviewToggleBtn{
  margin-top:8px;
  background:#1a1a1f;
  border:1px solid #333;
  color:#66ff99;
  padding:12px;
  border-radius:12px;
  cursor:pointer;
  font-size:0.95em;
  text-align:center;
  font-weight:900;
}
.reviewPanel{
  display:none;
  background:#111;
  border:1px solid #333;
  padding:10px;
  border-radius:12px;
  margin-top:8px;
  font-size:0.9em;
}

/* 星 */
.starWrap{ display:flex; gap:6px; cursor:pointer; margin-bottom:8px; }
.star{ font-size:22px; color:#444; }
.star.active{ color:#ffcc00; }

/* お気に入り */
.favoriteBtn{
  position:absolute;
  top:10px;
  right:10px;
  border:none;
  background:transparent;
  font-size:22px;
  cursor:pointer;
  color:#666;
}
.favoriteBtn.active{ color:#ff6699; }

/* 店舗報告（リンク風） */
.storeReportBtn{
  align-self:flex-end;
  font-size:0.8em;
  color:#777;
  background:none;
  border:none;
  padding:0;
  margin-top:2px;
  text-decoration:underline;
  cursor:pointer;
}

/* 店舗報告モーダル */
#storeReportModal{
  display:none;
  position:fixed;
  inset:0;
  background:rgba(0,0,0,0.7);
  justify-content:center;
  align-items:center;
  z-index:9999;
  padding:14px;
}
.modal-box{
  background:#111;
  padding:18px;
  border-radius:14px;
  width:min(360px, 100%);
  text-align:center;
  border:1px solid rgba(255,255,255,.10);
}
.modal-box h3{ margin:0 0 8px; }
.modal-box p{ color:#ccc; font-size:0.95em; margin:0 0 10px; }
#storeReportModal button{
  width:100%;
  padding:10px;
  margin-top:8px;
  border:none;
  border-radius:10px;
  cursor:pointer;
  font-weight:900;
}
.reportReasonOption{ background:#222; color:#fff; font-size:0.9em; }
.reportReasonOption.selected{ background:#555; }
#submitStoreReportBtn{ background:#66ff99; color:#000; }
#closeStoreReportBtn{ background:#333; color:#fff; }

/* ページネーション */
#pagination{
  margin:12px 0 4px;
  text-align:center;
  font-size:0.9em;
}
#pagination button{
  padding:8px 12px;
  margin:0 4px;
  border-radius:10px;
  border:1px solid #333;
  background:#1a1a1f;
  color:#fff;
  cursor:pointer;
  font-weight:900;
}
#pagination .pageNumBtn.current{
  background:#ffa500;
  color:#000;
  cursor:default;
}
</style>
</head>

<body>
<div class="page">

  <!-- ✅ ヘッダー -->
  <header class="siteHeader">
    <div class="logoArea">
      <a class="logoLink" href="index.html" aria-label="トップページへ戻る">
        <div style="min-width:0;">
          <div class="logoTextMain">FoodDeliveryEye</div>
          <div class="logoTextSub">配達員の体験を、みんなの安心と効率へ</div>
        </div>
      </a>
    </div>

    <div class="headerRight">
      <nav>
        <!-- 未ログイン時 -->
        <a id="navAbout" href="about.html">このサイトについて</a>
        <a id="navLogin" href="login.html">ログイン</a>
        <a id="navSignup" href="signup.html" class="primary">新規登録</a>

        <!-- ログイン時 -->
        <a id="navLoggedIn" href="mypage.html" style="display:none;">
          <span class="loggedLamp" aria-hidden="true"></span>
          ログイン中
        </a>
        <button id="navLogout" type="button" class="logoutPill" style="display:none;">ログアウトする</button>
      </nav>
    </div>
  </header>

  <h2>調理待ち時間<small>※お店到着後に商品受取までにかかった時間</small></h2>
  <button id="requestBtn" onclick="location.href='request.html'">掲載店舗を申請する</button>

  <div class="searchContainer">
    <input id="nameInput" placeholder="店舗名で検索">
    <div>
      <select id="prefSelect"><option value="">都道府県を選択</option></select>
      <select id="citySelect" style="display:none;"><option value="">市区町村を選択</option></select>
    </div>
    <div style="display:flex; justify-content:space-between; align-items:center; gap:12px; flex-wrap:wrap;">
      <button id="searchBtn" type="button">検索</button>
      <label class="favFilter">
        <input type="checkbox" id="favOnlyCheckbox">
        お気に入りのみ
      </label>
    </div>
  </div>

  <div id="storeContainer"></div>
  <div id="pagination"></div>

</div>

<!-- ✅ ログアウト確認 -->
<div id="logoutConfirmModal" class="confirmModal" aria-hidden="true">
  <div class="confirmBox" role="dialog" aria-modal="true" aria-labelledby="confirmTitle">
    <h3 class="confirmTitle" id="confirmTitle">本当にログアウトしますか？</h3>
    <p class="confirmText">ログアウトすると、お気に入り絞り込みや投稿ができなくなります。</p>
    <div class="confirmActions">
      <button id="cancelLogoutBtn" class="confirmBtn" type="button">キャンセル</button>
      <button id="confirmLogoutBtn" class="confirmBtn confirmBtnDanger" type="button">ログアウト</button>
    </div>
  </div>
</div>

<!-- 店舗情報報告モーダル -->
<div id="storeReportModal">
  <div class="modal-box">
    <h3>店舗情報の報告</h3>
    <p>報告理由を選んでください。</p>
    <button data-reason="1" class="reportReasonOption">1. 店舗情報が間違っている（名前、住所等）</button>
    <button data-reason="2" class="reportReasonOption">2. すでに登録してある店舗（二重登録）</button>
    <button data-reason="3" class="reportReasonOption">3. 存在しない店舗</button>
    <button id="submitStoreReportBtn" type="button">送信</button>
    <button id="closeStoreReportBtn" type="button">キャンセル</button>
  </div>
</div>

<script type="module">
import PocketBase from "https://cdn.jsdelivr.net/npm/pocketbase@0.21.2/dist/pocketbase.es.mjs";
const pb = new PocketBase("https://delivery-eye.onrender.com");
if (typeof pb.autoCancellation === "function") pb.autoCancellation(false);

/* ========================
   ✅ ヘッダー（ログイン状態で出し分け）
======================== */
const navAbout    = document.getElementById("navAbout");
const navLogin    = document.getElementById("navLogin");
const navSignup   = document.getElementById("navSignup");
const navLoggedIn = document.getElementById("navLoggedIn");
const navLogout   = document.getElementById("navLogout");

try{
  const nextUrl = "vote.html";
  navLogin.href = "login.html?next=" + encodeURIComponent(nextUrl);
}catch{}

function setNavLoggedIn(isLoggedIn){
  if(isLoggedIn){
    navAbout.style.display = "none";
    navLogin.style.display = "none";
    navSignup.style.display = "none";
    navLoggedIn.style.display = "";
    navLoggedIn.classList.add("loggedPill");
    navLogout.style.display = "";
  }else{
    navAbout.style.display = "";
    navLogin.style.display = "";
    navSignup.style.display = "";
    navLoggedIn.style.display = "none";
    navLoggedIn.classList.remove("loggedPill");
    navLogout.style.display = "none";
  }
}

async function ensureAuthModel(){
  if(!pb.authStore.isValid){
    setNavLoggedIn(false);
    return;
  }
  try{
    if (pb.collection && pb.collection("users")?.authRefresh) {
      await pb.collection("users").authRefresh();
    }
    setNavLoggedIn(true);
  }catch{
    pb.authStore.clear();
    setNavLoggedIn(false);
  }
}

/* ========================
   ✅ ログアウト確認
======================== */
const logoutConfirmModal = document.getElementById("logoutConfirmModal");
const cancelLogoutBtn = document.getElementById("cancelLogoutBtn");
const confirmLogoutBtn = document.getElementById("confirmLogoutBtn");

let logoutBusy = false;

function openLogoutConfirm(){
  logoutConfirmModal.style.display = "flex";
  logoutConfirmModal.setAttribute("aria-hidden", "false");
}
function closeLogoutConfirm(){
  logoutConfirmModal.style.display = "none";
  logoutConfirmModal.setAttribute("aria-hidden", "true");
}
async function doLogout(){
  if(logoutBusy) return;
  logoutBusy = true;
  try{
    pb.authStore.clear();
    setNavLoggedIn(false);

    favoriteMap = new Map();
    favoriteOnly = false;
    favOnlyCheckbox.checked = false;

    closeLogoutConfirm();
    await loadPage(1);
    alert("ログアウトしました");
  }finally{
    logoutBusy = false;
  }
}

navLogout?.addEventListener("click", openLogoutConfirm);
cancelLogoutBtn?.addEventListener("click", closeLogoutConfirm);
confirmLogoutBtn?.addEventListener("click", doLogout);
logoutConfirmModal?.addEventListener("click", (e)=>{ if(e.target === logoutConfirmModal) closeLogoutConfirm(); });
document.addEventListener("keydown", (e)=>{ if(e.key === "Escape" && logoutConfirmModal?.style.display === "flex") closeLogoutConfirm(); });

/* ========================
   共通・ユーティリティ
======================== */
function redirectToLogin(){
  alert("ログインが必要です。ログイン画面に移動します。");
  window.location.href = "login.html?next=" + encodeURIComponent("vote.html");
}
function escapeHtml(s){
  return String(s ?? "").replace(/[&<>"']/g, c=>({
    "&":"&amp;", "<":"&lt;", ">":"&gt;", '"':"&quot;", "'":"&#39;"
  }[c]));
}
function normalizeForFilter(text){
  return String(text ?? "").normalize("NFKC").toLowerCase().replace(/\s+/g,"");
}
function containsNGWordsEnhanced(text){
  const t = normalizeForFilter(text);
  const ngWords = [
    "しね","死ね","ころす","殺す","きも","キモ","きしょ","キショ",
    "ごみ","ゴミ","かす","カス","ばか","バカ","あほ","アホ",
    "ぶす","ブス","でぶ","デブ","はげ","ハゲ",
    "ちえおくれ","知恵遅れ","しょうがい","障害",
    "くず","クズ","ざこ","雑魚","にんげんのくず",
    "しんで","殺したい"
  ];
  return ngWords.some(w => t.includes(w));
}
function containsUrl(text){ return /https?:\/\/|www\./i.test(text); }
function looksLikeEmojiSpam(text){
  const codePoints = Array.from(String(text ?? ""));
  let emojiCount = 0;
  for(const ch of codePoints){
    const cp = ch.codePointAt(0);
    if((cp >= 0x1F300 && cp <= 0x1FAFF) || (cp >= 0x2600 && cp <= 0x27BF)) emojiCount++;
  }
  if(codePoints.length >= 10 && emojiCount / codePoints.length > 0.4) return true;
  if(/([!?w笑草ｗ])\1{4,}/i.test(text)) return true;
  return false;
}
function isToxicTone(text){
  if(containsNGWordsEnhanced(text)) return true;
  if(containsUrl(text)) return true;
  if(looksLikeEmojiSpam(text)) return true;
  return false;
}

/* ✅ 住所を分割 */
function splitAddressBanchiAndBuilding(raw){
  const s = String(raw ?? "").trim();
  if(!s) return { banchi:"", building:"" };

  const mSpace = s.match(/^(.+?)[ 　]+(.+)$/);
  if(mSpace) return { banchi:mSpace[1].trim(), building:mSpace[2].trim() };

  const mGo = s.match(/^(.*?号)(.*)$/);
  if(mGo) return { banchi:(mGo[1]||"").trim(), building:(mGo[2]||"").trim() };

  const mBanchi = s.match(/^(.*?番地)(.*)$/);
  if(mBanchi) return { banchi:(mBanchi[1]||"").trim(), building:(mBanchi[2]||"").trim() };

  const mHyphen = s.match(/^(.*?\d+(?:[-−ー]\d+){1,3})(.*)$/);
  if(mHyphen) return { banchi:(mHyphen[1]||"").trim(), building:(mHyphen[2]||"").trim() };

  return { banchi:s, building:"" };
}

/* ========================
   都道府県
======================== */
const prefs=[ "北海道","青森県","岩手県","宮城県","秋田県","山形県","福島県","茨城県","栃木県","群馬県","埼玉県","千葉県","東京都",
"神奈川県","新潟県","富山県","石川県","福井県","山梨県","長野県","岐阜県","静岡県","愛知県","三重県","滋賀県","京都府","大阪府",
"兵庫県","奈良県","和歌山県","鳥取県","島根県","岡山県","広島県","山口県","徳島県","香川県","愛媛県","高知県","福岡県","佐賀県",
"長崎県","熊本県","大分県","宮崎県","鹿児島県","沖縄県" ];

const prefSelect=document.getElementById("prefSelect");
prefs.forEach(p=>{
  const o=document.createElement("option");
  o.value=p; o.textContent=p;
  prefSelect.appendChild(o);
});
const citySelect=document.getElementById("citySelect");

const TOKYO_CITY_ORDER = [
  "千代田区","中央区","港区","新宿区","文京区","台東区","墨田区","江東区","品川区","目黒区","大田区","世田谷区","渋谷区","中野区","杉並区",
  "豊島区","北区","荒川区","板橋区","練馬区","足立区","葛飾区","江戸川区",
  "八王子市","立川市","武蔵野市","三鷹市","青梅市","府中市","昭島市","調布市","町田市","小金井市","小平市","日野市","東村山市",
  "国分寺市","国立市","福生市","狛江市","東大和市","清瀬市","東久留米市","武蔵村山市","多摩市","稲城市","羽村市","あきる野市","西東京市"
];

prefSelect.onchange = async ()=>{
  const pref = prefSelect.value;
  if(!pref){
    citySelect.style.display="none";
    citySelect.innerHTML = '<option value="">市区町村を選択</option>';
    return;
  }

  citySelect.innerHTML = '<option value="">市区町村を選択</option>';

  if(pref === "東京都"){
    TOKYO_CITY_ORDER.forEach(c=>{
      const o=document.createElement("option");
      o.value=c; o.textContent=c;
      citySelect.appendChild(o);
    });
    citySelect.style.display="block";
    return;
  }

  try{
    const res = await pb.collection("stores").getList(1,500,{ filter:`prefecture="${pref}"` });
    const cities=[...new Set(res.items.map(i=>i.city).filter(Boolean))].sort();
    cities.forEach(c=>{
      const o=document.createElement("option");
      o.value=c; o.textContent=c;
      citySelect.appendChild(o);
    });
    citySelect.style.display="block";
  }catch(e){
    console.error(e);
    citySelect.style.display="none";
  }
};

/* ========================
   検索 & お気に入り絞り込み & ページング
======================== */
document.getElementById("searchBtn").onclick=()=>loadPage(1);

let pageSize=10;

let favoriteOnly=false;
let favoriteMap=new Map(); // storeId -> favorite record id（ハート表示と削除に使う）
let currentPage=1;
let totalPages=1;

const favOnlyCheckbox=document.getElementById("favOnlyCheckbox");
favOnlyCheckbox.onchange = ()=>{
  if(favOnlyCheckbox.checked && !pb.authStore.isValid){
    alert("お気に入り絞り込みはログインが必要です");
    favOnlyCheckbox.checked=false;
    redirectToLogin();
    return;
  }
  favoriteOnly = favOnlyCheckbox.checked;
  loadPage(1);
};

function getSearchState(){
  const name = document.getElementById("nameInput").value.trim();
  const pref = prefSelect.value;
  const city = citySelect.value;
  return { name, pref, city, hasAny: !!(name || pref || city) };
}

function matchesStoreBySearch(store, st){
  // store: PocketBase record (stores)
  if(!store) return false;

  if(st.name){
    const hay = normalizeForFilter(store.name || "");
    const needle = normalizeForFilter(st.name);
    if(!hay.includes(needle)) return false;
  }
  if(st.pref){
    if(String(store.prefecture || "") !== String(st.pref)) return false;
  }
  if(st.city){
    if(String(store.city || "") !== String(st.city)) return false;
  }
  return true;
}

/**
 * ✅ favorites を expand で取って、favorite登録順（created desc）のまま store を返す
 * - フィルタなし：favoritesをページングして expand で store を出す（順番も保持）
 * - フィルタあり：favoritesを全件（最大500）expandで取り、store側で絞り込んでからクライアントページング（順番保持）
 */
async function loadFavoriteStoresOrdered(page){
  const userId = pb.authStore.model.id;
  const st = getSearchState();

  // ハート表示のために favoriteMap を作る（フィルタでも安定するように全件で作る）
  favoriteMap = new Map();
  try{
    const allFav = await pb.collection("favorites").getList(1,500,{
      filter:`userId="${userId}"`,
      sort:"-created"
    });
    allFav.items.forEach(f=>{
      if(f.storeId) favoriteMap.set(f.storeId, f.id);
    });
  }catch(e){
    console.error(e);
  }

  // ① フィルタが無いなら：favoritesをそのままページング + expand
  if(!st.hasAny){
    const favPaged = await pb.collection("favorites").getList(page, pageSize, {
      filter:`userId="${userId}"`,
      sort:"-created",
      expand:"storeId"
    });

    currentPage = favPaged.page;
    totalPages  = favPaged.totalPages || 1;

    // favoritesの並び順のまま store を取り出す
    const stores = favPaged.items
      .map(f => f.expand?.storeId)
      .filter(Boolean);

    return stores;
  }

  // ② フィルタがあるなら：全favoritesをexpand→storeで絞り込み→ページング（順序はfavorite順のまま）
  const favAllExpanded = await pb.collection("favorites").getList(1,500,{
    filter:`userId="${userId}"`,
    sort:"-created",
    expand:"storeId"
  });

  const filtered = favAllExpanded.items.filter(f=>{
    const store = f.expand?.storeId;
    return matchesStoreBySearch(store, st);
  });

  totalPages  = Math.max(1, Math.ceil(filtered.length / pageSize));
  currentPage = Math.min(Math.max(1, page), totalPages);

  const start = (currentPage - 1) * pageSize;
  const slice = filtered.slice(start, start + pageSize);

  const stores = slice.map(f => f.expand?.storeId).filter(Boolean);
  return stores;
}

async function loadPage(page=1){
  const container=document.getElementById("storeContainer");
  container.innerHTML="読み込み中…";

  try{
    // ✅ まず通常時も、ハート表示のため favorites を持っておく
    if(pb.authStore.isValid){
      favoriteMap = new Map();
      const userId = pb.authStore.model.id;
      const favList = await pb.collection("favorites").getList(1,500,{
        filter:`userId="${userId}"`,
        sort:"-created"
      });
      favList.items.forEach(f=>{
        if(f.storeId) favoriteMap.set(f.storeId, f.id);
      });
    }else{
      favoriteMap = new Map();
    }

    // ✅ お気に入りのみ：expandで favorite順を保持して表示
    if(favoriteOnly){
      if(!pb.authStore.isValid){
        redirectToLogin();
        return;
      }
      const stores = await loadFavoriteStoresOrdered(page);
      renderStores(stores);
      renderPagination();
      return;
    }

    // ✅ 通常：stores を普通にページング（name/pref/cityはサーバ側filter）
    const { name, pref, city } = getSearchState();
    let filter="";
    if(name) filter += `name~"${name}"`;
    if(pref) filter += (filter ? " && " : "") + `prefecture="${pref}"`;
    if(city) filter += (filter ? " && " : "") + `city="${city}"`;

    const list=await pb.collection("stores").getList(page,pageSize,{ filter, sort:"name" });

    currentPage = list.page;
    totalPages  = list.totalPages || 1;

    renderStores(list.items);
    renderPagination();

  }catch(e){
    console.error(e);
    container.textContent="読み込みエラー";
    document.getElementById("pagination").innerHTML="";
  }
}

function renderPagination(){
  const pEl = document.getElementById("pagination");
  if(!pEl) return;

  if(totalPages <= 1){
    pEl.innerHTML = "";
    return;
  }

  let html = "";
  if(currentPage > 1) html += `<button class="pageBtn" data-page="${currentPage-1}">前へ</button>`;

  let start = currentPage - 2;
  let end   = currentPage + 2;
  if(start < 1){ end += (1 - start); start = 1; }
  if(end > totalPages){ start -= (end - totalPages); end = totalPages; }
  if(start < 1) start = 1;

  for(let p = start; p <= end; p++){
    const cls = p === currentPage ? "pageBtn pageNumBtn current" : "pageBtn pageNumBtn";
    html += `<button class="${cls}" data-page="${p}">${p}</button>`;
  }

  if(currentPage < totalPages) html += `<button class="pageBtn" data-page="${currentPage+1}">次へ</button>`;

  pEl.innerHTML = html;
  pEl.querySelectorAll(".pageBtn").forEach(btn=>{
    btn.onclick = ()=>{
      const page = Number(btn.dataset.page) || 1;
      if(page === currentPage) return;
      loadPage(page);
      window.scrollTo({top:0, behavior:"smooth"});
    };
  });
}

/* ========================
   店舗カード
======================== */
const voteOptions=["なし","2〜3分","5〜10分","10分以上"];

const now=new Date();
const currentMonth=`${now.getFullYear()}年${now.getMonth()+1}月`;
const todayKey=`${now.getFullYear()}-${now.getMonth()+1}-${now.getDate()}`;
const pastMonths=[...Array(2)].map((_,i)=>{
  const d=new Date(now.getFullYear(),now.getMonth()-i-1,1);
  return `${d.getFullYear()}年${d.getMonth()+1}月`;
});

let browserId=localStorage.getItem("browserId");
if(!browserId){
  browserId="id-"+Math.random().toString(36).slice(2);
  localStorage.setItem("browserId",browserId);
}

/* 店舗報告用の状態 */
let reportTargetStoreId = null;
let selectedStoreReportReason = null;

function renderStores(stores){
  const container=document.getElementById("storeContainer");
  container.innerHTML="";

  if(!stores.length){
    container.textContent = favoriteOnly ? "お気に入り店舗がありません" : "該当店舗なし";
    return;
  }

  stores.forEach(s=>{
    const card=document.createElement("div");
    card.className="storeCard";

    const isFav = favoriteMap.has(s.id);

    const fullAddressText = (s.prefecture||"")+" "+(s.city||"")+" "+(s.address||"");
    const mapUrl = `https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(fullAddressText)}`;

    const split = splitAddressBanchiAndBuilding(String(s.address || ""));
    const leftText = ((s.prefecture||"")+" "+(s.city||"")+" "+(split.banchi||"")).trim();
    const rightText = (split.building || "").trim();

    card.innerHTML=
      `<button class="favoriteBtn ${isFav?"active":""}" title="お気に入り">${isFav?"♥":"♡"}</button>
       <div class="storeName">${escapeHtml(s.name || "")}</div>
       <div class="avgRating" id="avgRating-${s.id}">平均評価：口コミなし</div>
       <div class="address">
         <a class="addressLink" href="${mapUrl}" target="_blank" rel="noopener noreferrer">${escapeHtml(leftText)}</a>${rightText ? `<span> ${escapeHtml(rightText)}</span>` : ``}
       </div>
       <button class="storeReportBtn" data-store-id="${s.id}">店舗情報の報告</button>`;

    const favBtn = card.querySelector(".favoriteBtn");
    favBtn.onclick = ()=>handleFavoriteClick(s.id, favBtn);

    const storeReportBtn = card.querySelector(".storeReportBtn");
    storeReportBtn.onclick = ()=>handleStoreReport(s.id);

    /* 投票 */
    const vBox=document.createElement("div");
    vBox.className="voteContainer";
    const votedKey=`${s.id}-${todayKey}-${browserId}`;
    if(localStorage.getItem(votedKey)){
      vBox.innerHTML=`<span style="background:#ffa500; color:#000; padding:4px 8px; border-radius:10px; font-weight:900;">今日は投票済</span>`;
    }else{
      const sel=document.createElement("select");
      voteOptions.forEach(v=>{
        const o=document.createElement("option");
        o.value=v; o.textContent=v;
        sel.appendChild(o);
      });
      const btn=document.createElement("button");
      btn.textContent="投票";
      btn.onclick=()=>vote(s.id,sel.value);
      vBox.appendChild(sel);
      vBox.appendChild(btn);
    }
    card.appendChild(vBox);

    /* 集計 */
    const right=document.createElement("div");
    right.className="rightColumn";

    let nowLine="";
    voteOptions.forEach(v=>{
      const c=s.votes?.[currentMonth]?.[v]||0;
      nowLine+=`・${v}: <span class="voteCount">${c}票</span> `;
    });
    right.innerHTML=`<div style="font-weight:800;">${currentMonth} ${nowLine}</div>`;

    pastMonths.forEach(m=>{
      const acc=document.createElement("button");
      acc.className="accordion";
      acc.textContent=`${m}の結果`;

      const panel=document.createElement("div");
      panel.className="panel";

      let txt="";
      voteOptions.forEach(v=>{
        const c=s.votes?.[m]?.[v]||0;
        txt+=`・${v}: ${c}票 `;
      });
      panel.textContent=txt;

      acc.onclick=()=>panel.style.display = (panel.style.display==="block" ? "none" : "block");

      right.appendChild(acc);
      right.appendChild(panel);
    });

    card.appendChild(right);

    /* 口コミタブ */
    const toggleBtn=document.createElement("div");
    toggleBtn.className="reviewToggleBtn";
    toggleBtn.textContent="口コミを見る";

    const panel=document.createElement("div");
    panel.className="reviewPanel";
    panel.id=`reviewPanel-${s.id}`;
    panel.innerHTML=`
      <div style="font-weight:900; color:#66ff99; margin-bottom:8px;">口コミ</div>

      <div class="starWrap" id="starWrap-${s.id}">
        <span class="star" data-v="1">★</span>
        <span class="star" data-v="2">★</span>
        <span class="star" data-v="3">★</span>
        <span class="star" data-v="4">★</span>
        <span class="star" data-v="5">★</span>
      </div>

      <div id="reviews-${s.id}" style="margin-bottom:8px;">読み込み中…</div>

      <textarea id="reviewInput-${s.id}"
        placeholder="口コミを書く（最大200文字・任意）"
        maxlength="200"
        style="width:100%; height:70px; padding:10px; border-radius:10px; background:#0f0f12; color:#fff; border:1px solid #444;"></textarea>

      <button id="reviewBtn-${s.id}"
        style="margin-top:8px; width:100%; padding:10px; background:#66ff99; color:#000; border-radius:10px; border:none; font-weight:900;">
        投稿する
      </button>
    `;

    toggleBtn.onclick=()=>{
      const opened = panel.style.display==="block";
      panel.style.display = opened ? "none" : "block";
      toggleBtn.textContent = opened ? "口コミを見る" : "口コミを閉じる";
    };

    /* 星クリック */
    const sWrap=panel.querySelector(`#starWrap-${s.id}`);
    sWrap.querySelectorAll(".star").forEach(st=>{
      st.onclick=()=>{
        const val = Number(st.dataset.v);
        sWrap.querySelectorAll(".star").forEach(x=>{
          const v = Number(x.dataset.v);
          x.classList.toggle("active", v <= val);
        });
      };
    });

    /* 口コミ投稿 */
    panel.querySelector(`#reviewBtn-${s.id}`).onclick=()=>{
      const textEl = document.getElementById(`reviewInput-${s.id}`);
      const text = textEl.value.trim();

      const sWrapEl = document.getElementById(`starWrap-${s.id}`);
      let starValue = 0;
      sWrapEl.querySelectorAll(".star").forEach(st=>{
        if(st.classList.contains("active")){
          const v = Number(st.dataset.v);
          if(v > starValue) starValue = v;
        }
      });

      if(!starValue) return alert("星評価を選んでください");

      if(text && isToxicTone(text)){
        alert("誹謗中傷・URL・絵文字スパムなどが含まれている可能性があります。内容を見直してください。");
        return;
      }

      if(!pb.authStore.isValid){
        redirectToLogin();
        return;
      }

      submitReview(s.id, text, starValue);
    };

    card.appendChild(toggleBtn);
    card.appendChild(panel);

    container.appendChild(card);
  });

  loadAllReviewsForRenderedStores(stores);
}

/* ========================
   お気に入りトグル
======================== */
async function handleFavoriteClick(storeId, btn){
  if(!pb.authStore.isValid){
    redirectToLogin();
    return;
  }
  try{
    if(favoriteMap.has(storeId)){
      const favId = favoriteMap.get(storeId);
      await pb.collection("favorites").delete(favId);
      favoriteMap.delete(storeId);
      btn.classList.remove("active");
      btn.textContent="♡";

      // ✅ お気に入りのみ表示中は、削除後も「お気に入り登録順」を保った再描画をする
      if(favoriteOnly){
        await loadPage(1);
      }

    }else{
      const rec = await pb.collection("favorites").create({
        userId: pb.authStore.model.id,
        storeId
      });
      favoriteMap.set(storeId, rec.id);
      btn.classList.add("active");
      btn.textContent="♥";
    }
  }catch(e){
    console.error(e);
    alert("お気に入り更新エラー");
  }
}

/* ========================
   店舗情報の報告
======================== */
function handleStoreReport(storeId){
  if(!pb.authStore.isValid){
    redirectToLogin();
    return;
  }
  openStoreReportModal(storeId);
}

function openStoreReportModal(storeId){
  reportTargetStoreId = storeId;
  selectedStoreReportReason = null;
  document.querySelectorAll(".reportReasonOption").forEach(btn=>btn.classList.remove("selected"));
  document.getElementById("storeReportModal").style.display="flex";
}
function closeStoreReportModal(){
  reportTargetStoreId = null;
  selectedStoreReportReason = null;
  document.getElementById("storeReportModal").style.display="none";
}

async function submitStoreReport(){
  if(!reportTargetStoreId) return alert("店舗が取得できていません。ページ更新してください。");
  if(!selectedStoreReportReason) return alert("報告理由を選んでください。");

  const map = {
    1:"店舗情報が間違っている(名前、住所等)",
    2:"すでに登録してある店舗(二重登録)",
    3:"存在しない店舗"
  };
  const reason = map[selectedStoreReportReason];
  if(!reason) return alert("不正な報告理由です。");

  await reportStoreInternal(reportTargetStoreId, reason);
  closeStoreReportModal();
}

async function reportStoreInternal(storeId, reason){
  if(!pb.authStore.isValid){ redirectToLogin(); return; }

  try{
    const reporterId = pb.authStore.model.id;
    const start = new Date(); start.setHours(0,0,0,0);
    const iso = start.toISOString();

    const existing = await pb.collection("storeReports").getList(1,1,{
      filter:`storeId="${storeId}" && reporterId="${reporterId}" && created>="${iso}"`
    });
    if(existing.items.length){
      alert("この店舗は本日すでに報告済みです。");
      return;
    }

    await pb.collection("storeReports").create({ storeId, reporterId, reason });
    alert("店舗情報の報告を受け付けました。ありがとうございます。");
  }catch(e){
    console.error(e);
    alert("店舗情報の報告に失敗しました。");
  }
}

/* ========================
   投票（日次制限）
======================== */
async function vote(id, choice){
  if(!pb.authStore.isValid){
    redirectToLogin();
    return;
  }
  await executeVote(id,choice);
}

async function executeVote(id, choice){
  const key=`${id}-${todayKey}-${browserId}`;
  if(localStorage.getItem(key)) return alert("今日はすでに投票済です。");

  try{
    const s=await pb.collection("stores").getOne(id);
    const votes=s.votes||{};
    votes[currentMonth]=votes[currentMonth]||{};
    votes[currentMonth][choice]=(votes[currentMonth][choice]||0)+1;

    await pb.collection("stores").update(id,{votes});
    localStorage.setItem(key,"1");

    alert("投票しました！");
    loadPage(currentPage);
  }catch(e){
    console.error(e);
    alert("投票エラー");
  }
}

/* ========================
   口コミ表示 + 平均評価 + 投稿者ID表示
======================== */
async function loadAllReviewsForRenderedStores(stores){
  try{
    const list = await pb.collection("reviews").getList(1,500,{ sort:"-created" });
    const reviews = list.items;

    const grouped = {};
    reviews.forEach(r=>{
      const sid = r.storeId;
      if(!sid) return;
      if(!grouped[sid]) grouped[sid] = [];
      grouped[sid].push(r);
    });

    const currentUserId = pb.authStore.isValid ? pb.authStore.model.id : null;

    stores.forEach(s=>{
      const storeId = s.id;
      const box = document.getElementById(`reviews-${storeId}`);
      const avgEl = document.getElementById(`avgRating-${storeId}`);

      const items = grouped[storeId] || [];

      if(!items.length){
        if(avgEl) avgEl.textContent = "平均評価：口コミなし";
        if(box) box.innerHTML = `<span style="color:#888;">口コミはまだありません</span>`;
      }else{
        let sum = 0;
        items.forEach(r=>{ sum += r.star || 0; });
        const avg = sum / items.length;
        const rounded = Math.round(avg*10)/10;

        const filledCount = Math.round(avg);
        const emptyCount = 5 - filledCount;
        const filledStars = "★".repeat(filledCount);
        const emptyStars  = "★".repeat(emptyCount>0 ? emptyCount : 0);

        if(avgEl){
          avgEl.innerHTML =
            `平均評価：<span style="color:#ffcc00;">${filledStars}</span>`+
            `<span style="color:#555;">${emptyStars}</span> （${rounded.toFixed(1)}）`;
        }

        let html="";
        items.slice(0,3).forEach(r=>{
          const rawUserId = r.userId || "";
          const userLabel = rawUserId ? `投稿者ID: ${String(rawUserId).slice(0,4)}****` : "投稿者ID: 不明";

          html+=`
            <div style="border-bottom:1px solid #333; padding:6px 0;">
              <div style="color:#ffcc00; font-weight:900;">
                ${"★".repeat(r.star)}<span style="color:#555">${"★".repeat(5-r.star)}</span>
              </div>
              <div style="color:#ddd;">${escapeHtml(r.text || "")}</div>
              <div style="color:#888; font-size:0.8em;">${userLabel}</div>
              <div style="color:#666; font-size:0.75em;">${new Date(r.created).toLocaleString()}</div>
            </div>
          `;
        });

        if(items.length>3){
          html += `<button style="width:100%; padding:10px; margin-top:8px; background:#2a2a2f; border:none; border-radius:10px; color:#fff; font-weight:900; cursor:pointer;"
                     onclick="showAllReviews('${storeId}')">もっと見る</button>`;
        }

        if(box) box.innerHTML = html;
      }

      if(currentUserId){
        const myReview = (grouped[storeId] || []).find(r => r.userId === currentUserId);
        if(myReview){
          const sWrapEl = document.getElementById(`starWrap-${storeId}`);
          if(sWrapEl){
            const val = myReview.star || 0;
            sWrapEl.querySelectorAll(".star").forEach(st=>{
              const v = Number(st.dataset.v);
              st.classList.toggle("active", v <= val);
            });
          }
          const inputEl = document.getElementById(`reviewInput-${storeId}`);
          if(inputEl){
            inputEl.value = myReview.text === "（本文なし）" ? "" : (myReview.text || "");
          }
        }
      }
    });

  }catch(e){
    console.error(e);
    stores.forEach(s=>{
      const box = document.getElementById(`reviews-${s.id}`);
      const avgEl = document.getElementById(`avgRating-${s.id}`);
      if(avgEl) avgEl.textContent = "平均評価：取得に失敗しました";
      if(box) box.innerHTML = "読み込み失敗";
    });
  }
}

window.showAllReviews = function(storeId){
  pb.collection("reviews").getList(1,500,{ sort:"-created" })
    .then(list=>{
      const all = list.items.filter(r => r.storeId === storeId);
      const box=document.getElementById(`reviews-${storeId}`);
      let html="";
      all.forEach(r=>{
        const rawUserId = r.userId || "";
        const userLabel = rawUserId ? `投稿者ID: ${String(rawUserId).slice(0,4)}****` : "投稿者ID: 不明";

        html+=`
          <div style="border-bottom:1px solid #333; padding:6px 0;">
            <div style="color:#ffcc00; font-weight:900;">
              ${"★".repeat(r.star)}<span style="color:#555">${"★".repeat(5-r.star)}</span>
            </div>
            <div style="color:#ddd;">${escapeHtml(r.text || "")}</div>
            <div style="color:#888; font-size:0.8em;">${userLabel}</div>
            <div style="color:#666; font-size:0.75em;">${new Date(r.created).toLocaleString()}</div>
          </div>
        `;
      });
      if(box) box.innerHTML = html;
    });
}

/* ========================
   口コミ投稿（1ユーザー1店舗1件・再編集）
======================== */
async function submitReview(storeId,text,star){
  try{
    const userId = pb.authStore.model.id;

    const existing = await pb.collection("reviews").getList(1,1,{
      filter:`storeId="${storeId}" && userId="${userId}"`
    });

    const payload = {
      storeId,
      userId,
      star,
      text: (text && text.trim()) ? text : "（本文なし）"
    };

    if(existing.items.length){
      const reviewId = existing.items[0].id;
      await pb.collection("reviews").update(reviewId, payload);
      alert("口コミを更新しました！");
    }else{
      await pb.collection("reviews").create(payload);
      alert("口コミを投稿しました！");
    }

    document.getElementById(`reviewInput-${storeId}`).value="";
    loadPage(currentPage);

  }catch(e){
    console.error(e);
    alert("投稿に失敗しました。");
  }
}

/* 店舗報告モーダル */
document.querySelectorAll(".reportReasonOption").forEach(btn=>{
  btn.onclick = ()=>{
    const val = Number(btn.dataset.reason);
    selectedStoreReportReason = val;
    document.querySelectorAll(".reportReasonOption").forEach(b=>{
      b.classList.toggle("selected", b === btn);
    });
  };
});
document.getElementById("submitStoreReportBtn").onclick = ()=>submitStoreReport();
document.getElementById("closeStoreReportBtn").onclick = ()=>closeStoreReportModal();

/* ========================
   初回ロード
======================== */
(async ()=>{
  setNavLoggedIn(pb.authStore.isValid);
  await ensureAuthModel();
  loadPage(1);
})();
</script>

</body>
</html>
