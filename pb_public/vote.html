<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>é»’ãƒ¢ãƒ€ãƒ³A æœˆè¡¨ç¤ºä»˜ãï¼ˆPocketBaseç‰ˆãƒ»æ—¥æ¬¡æŠ•ç¥¨å¯¾å¿œï¼‰</title>
<style>
body { font-family: sans-serif; margin:0; padding:6px; background:#0d0d0d; color:#fff; }
header { display:flex; justify-content:space-between; align-items:center; padding:6px; background:#111; border-bottom:1px solid #222; }
header .status { font-size:0.8em; color:#ccc; }
#logoutBtn { background:#333; color:#fff; border:none; padding:4px 8px; border-radius:6px; cursor:pointer; font-size:0.8em; }
#logoutBtn:hover { background:#555; }
#requestBtn { display:inline-block; margin:6px 0 8px 0; font-size:0.7em; color:#66ff99; text-decoration:underline; background:none; border:none; padding:0; cursor:pointer; }
h2 { margin-bottom:4px; line-height:1.2em; }
h2 small { display:block; font-size:0.7em; color:#ccc; margin-top:2px; }
.searchContainer { display:flex; flex-direction:column; gap:4px; margin-bottom:8px; }
.searchContainer div { display:flex; gap:4px; }
.searchContainer input, .searchContainer select { padding:6px; border-radius:6px; border:1px solid #333; font-size:0.9em; flex:1; background:#111; color:#fff; }
.searchContainer button { padding:6px; border-radius:6px; border:1px solid #333; font-size:0.9em; cursor:pointer; background:#ffa500; color:#000; }
.storeCard { display:flex; justify-content:space-between; padding:6px; margin-bottom:6px; border:1px solid #222; border-radius:6px; background:#111; font-size:0.8em; }
.leftColumn { flex:1; margin-right:6px; display:flex; flex-direction:column; gap:4px; }
.storeName { font-weight:bold; color:#66ff99; }
.address { font-size:0.7em; color:#ccc; }
.rightColumn { flex:1; background:#1a1a1a; padding:4px; border-radius:4px; font-size:0.7em; text-align:left; }
.voteContainer { display:flex; align-items:center; gap:4px; flex-wrap:wrap; }
.voteCount { font-weight:bold; color:#ff6600; }
.monthLabel { color:#fff; font-weight:bold; }
.accordion { font-size:0.7em; padding:2px 4px; margin-top:2px; background:#333; border:none; border-radius:3px; cursor:pointer; width:100%; text-align:left; color:#fff; }
.panel { display:none; font-size:0.7em; padding-left:4px; background:#222; border-radius:2px; margin-bottom:2px; color:#ccc; }

/* ğŸ”¹ ãƒ¢ãƒ¼ãƒ€ãƒ« */
#loginModal {
  display:none; position:fixed; inset:0; background:rgba(0,0,0,0.7);
  justify-content:center; align-items:center; z-index:9999;
}
#loginModal .box {
  background:#111; padding:20px; border-radius:10px; text-align:center; width:280px;
}
#loginModal button {
  width:100%; padding:8px; margin-top:8px; border:none; border-radius:6px; cursor:pointer;
}
#googleLoginBtn { background:#fff; color:#000; }
#emailLoginBtn { background:#66ff99; color:#000; }
#closeModalBtn { background:#333; color:#fff; }
</style>
</head>
<body>

<header>
  <div class="status" id="userStatus">æœªãƒ­ã‚°ã‚¤ãƒ³</div>
  <button id="logoutBtn" style="display:none;">ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ</button>
</header>

<h2>èª¿ç†å¾…ã¡æ™‚é–“äºˆæ¸¬<small>â€»ãŠåº—åˆ°ç€å¾Œã«å•†å“å—å–ã¾ã§ã«ã‹ã‹ã£ãŸæ™‚é–“</small></h2>
<button id="requestBtn" onclick="location.href='request.html'">æ²è¼‰åº—èˆ—ã‚’ç”³è«‹ã™ã‚‹</button>

<div class="searchContainer">
  <input id="nameInput" placeholder="åº—èˆ—åã§æ¤œç´¢">
  <div>
    <select id="prefSelect"><option value="">éƒ½é“åºœçœŒã‚’é¸æŠ</option></select>
    <select id="citySelect" style="display:none;"><option value="">å¸‚åŒºç”ºæ‘ã‚’é¸æŠ</option></select>
  </div>
  <button id="searchBtn">æ¤œç´¢</button>
</div>

<div id="storeContainer"></div>

<!-- ğŸŸ¢ ãƒ­ã‚°ã‚¤ãƒ³é¸æŠãƒ¢ãƒ¼ãƒ€ãƒ« -->
<div id="loginModal">
  <div class="box">
    <h3 style="margin-top:0;">ãƒ­ã‚°ã‚¤ãƒ³ãŒå¿…è¦ã§ã™</h3>
    <p style="font-size:0.9em; color:#ccc;">ã©ã®æ–¹æ³•ã§ãƒ­ã‚°ã‚¤ãƒ³ã—ã¾ã™ã‹ï¼Ÿ</p>
    <button id="googleLoginBtn">Googleã§ãƒ­ã‚°ã‚¤ãƒ³</button>
    <button id="emailLoginBtn">ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã§ãƒ­ã‚°ã‚¤ãƒ³</button>
    <button id="closeModalBtn">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
  </div>
</div>

<script type="module">
import PocketBase from "https://cdn.jsdelivr.net/npm/pocketbase@0.21.2/dist/pocketbase.es.mjs";
const pb = new PocketBase("https://delivery-eye.onrender.com");

// ğŸŸ¢ ãƒ­ã‚°ã‚¤ãƒ³çŠ¶æ…‹ã®UIæ›´æ–°é–¢æ•°
function updateUserStatus() {
  const status = document.getElementById("userStatus");
  const logoutBtn = document.getElementById("logoutBtn");
  if (pb.authStore.isValid) {
    const email = pb.authStore.model?.email || "ãƒ­ã‚°ã‚¤ãƒ³ä¸­";
    status.textContent = `ãƒ­ã‚°ã‚¤ãƒ³ä¸­: ${email}`;
    logoutBtn.style.display = "inline-block";
  } else {
    status.textContent = "æœªãƒ­ã‚°ã‚¤ãƒ³";
    logoutBtn.style.display = "none";
  }
}

// ---- ãƒšãƒ¼ã‚¸ãƒ­ãƒ¼ãƒ‰æ™‚ã«çŠ¶æ…‹ç¢ºèª ----
updateUserStatus();

// éƒ½é“åºœçœŒãƒªã‚¹ãƒˆ
const prefs=["åŒ—æµ·é“","é’æ£®çœŒ","å²©æ‰‹çœŒ","å®®åŸçœŒ","ç§‹ç”°çœŒ","å±±å½¢çœŒ","ç¦å³¶çœŒ","èŒ¨åŸçœŒ","æ ƒæœ¨çœŒ","ç¾¤é¦¬çœŒ","åŸ¼ç‰çœŒ","åƒè‘‰çœŒ","æ±äº¬éƒ½","ç¥å¥ˆå·çœŒ","æ–°æ½ŸçœŒ","å¯Œå±±çœŒ","çŸ³å·çœŒ","ç¦äº•çœŒ","å±±æ¢¨çœŒ","é•·é‡çœŒ","å²é˜œçœŒ","é™å²¡çœŒ","æ„›çŸ¥çœŒ","ä¸‰é‡çœŒ","æ»‹è³€çœŒ","äº¬éƒ½åºœ","å¤§é˜ªåºœ","å…µåº«çœŒ","å¥ˆè‰¯çœŒ","å’Œæ­Œå±±çœŒ","é³¥å–çœŒ","å³¶æ ¹çœŒ","å²¡å±±çœŒ","åºƒå³¶çœŒ","å±±å£çœŒ","å¾³å³¶çœŒ","é¦™å·çœŒ","æ„›åª›çœŒ","é«˜çŸ¥çœŒ","ç¦å²¡çœŒ","ä½è³€çœŒ","é•·å´çœŒ","ç†Šæœ¬çœŒ","å¤§åˆ†çœŒ","å®®å´çœŒ","é¹¿å…å³¶çœŒ","æ²–ç¸„çœŒ"];
const prefSelect=document.getElementById("prefSelect");
prefs.forEach(p=>{const o=document.createElement("option");o.value=p;o.textContent=p;prefSelect.appendChild(o);});
const citySelect=document.getElementById("citySelect");

let currentPage=1,pageSize=20;
const voteOptions=["ãªã—","2ã€œ3åˆ†","5ã€œ10åˆ†","10åˆ†ä»¥ä¸Š"];
const now=new Date(),currentMonth=`${now.getFullYear()}å¹´${now.getMonth()+1}æœˆ`;
const todayKey=`${now.getFullYear()}-${now.getMonth()+1}-${now.getDate()}`;
const pastMonths=[...Array(2)].map((_,i)=>{const d=new Date(now.getFullYear(),now.getMonth()-i-1,1);return `${d.getFullYear()}å¹´${d.getMonth()+1}æœˆ`;});
let browserId=localStorage.getItem("browserId");if(!browserId){browserId="id-"+Math.random().toString(36).slice(2);localStorage.setItem("browserId",browserId);}

prefSelect.onchange=async()=>{
  const pref=prefSelect.value;
  if(!pref){citySelect.style.display="none";return;}
  const res=await pb.collection("stores").getList(1,500,{filter:`prefecture="${pref}"`});
  const cities=[...new Set(res.items.map(i=>i.city).filter(Boolean))].sort();
  citySelect.innerHTML='<option value="">å¸‚åŒºç”ºæ‘ã‚’é¸æŠ</option>';
  cities.forEach(c=>{const o=document.createElement("option");o.value=c;o.textContent=c;citySelect.appendChild(o);});
  citySelect.style.display="block";
};

document.getElementById("searchBtn").onclick=()=>loadPage(1);

async function loadPage(page=1){
  const container=document.getElementById("storeContainer");
  container.innerHTML="<p>èª­ã¿è¾¼ã¿ä¸­...</p>";
  const name=document.getElementById("nameInput").value.trim();
  const pref=prefSelect.value,city=citySelect.value;
  let filter="";
  if(name)filter+=`name~"${name}"`;
  if(pref)filter+=(filter?" && ":"")+`prefecture="${pref}"`;
  if(city)filter+=(filter?" && ":"")+`city="${city}"`;
  try{
    const list=await pb.collection("stores").getList(page,pageSize,{filter,sort:"name"});
    renderStores(list.items);
  }catch(e){console.error(e);container.textContent="èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼";}
}

function renderStores(stores){
  const container=document.getElementById("storeContainer");
  container.innerHTML="";
  if(!stores.length){container.textContent="è©²å½“åº—èˆ—ãªã—";return;}
  stores.forEach(s=>{
    const card=document.createElement("div");card.className="storeCard";
    const left=document.createElement("div");left.className="leftColumn";
    left.innerHTML=`<div class="storeName">${s.name}</div><div class="address">${s.prefecture||""} ${s.city||""} ${s.address||""}</div>`;
    const voteBox=document.createElement("div");voteBox.className="voteContainer";
    const votedKey=`${s.id}-${todayKey}-${browserId}`;
    if(localStorage.getItem(votedKey)){
      const tag=document.createElement("span");tag.textContent="ä»Šæ—¥ã¯æŠ•ç¥¨æ¸ˆ";tag.style.background="#ffa500";tag.style.color="#000";tag.style.padding="2px 4px";tag.style.borderRadius="4px";voteBox.appendChild(tag);
    }else{
      const sel=document.createElement("select");voteOptions.forEach(v=>{const o=document.createElement("option");o.value=v;o.textContent=v;sel.appendChild(o);});
      const btn=document.createElement("button");btn.textContent="æŠ•ç¥¨";
      btn.onclick=()=>vote(s.id,sel.value);
      voteBox.appendChild(sel);voteBox.appendChild(btn);
    }
    left.appendChild(voteBox);

    const right=document.createElement("div");right.className="rightColumn";
    let nowLine="";voteOptions.forEach(v=>{const c=s.votes?.[currentMonth]?.[v]||0;nowLine+=`ãƒ»${v}: <span class='voteCount'>${c}äºº</span> `;});
    right.innerHTML=`<div>${currentMonth} ${nowLine}</div>`;
    pastMonths.forEach(m=>{
      const acc=document.createElement("button");acc.className="accordion";acc.textContent=`${m}ã®çµæœ`;
      const panel=document.createElement("div");panel.className="panel";
      let txt="";voteOptions.forEach(v=>{const c=s.votes?.[m]?.[v]||0;txt+=`ãƒ»${v}: ${c}äºº `;});
      panel.textContent=txt;acc.onclick=()=>panel.style.display=panel.style.display==="block"?"none":"block";right.appendChild(acc);right.appendChild(panel);
    });

    card.appendChild(left);card.appendChild(right);container.appendChild(card);
  });
}

// âœ… æ—¥æ¬¡åˆ¶é™ç‰ˆ vote()
async function vote(id, choice) {
  if (!pb.authStore.isValid) {
    document.getElementById("loginModal").style.display = "flex";
    window.pendingVote = { id, choice };
    return;
  }
  await executeVote(id, choice);
}

async function executeVote(id, choice) {
  const key = `${id}-${todayKey}-${browserId}`;
  if (localStorage.getItem(key)) {
    alert("ä»Šæ—¥ã¯ã™ã§ã«æŠ•ç¥¨æ¸ˆã§ã™ã€‚");
    return;
  }

  try {
    const s = await pb.collection("stores").getOne(id);
    const votes = s.votes || {};
    votes[currentMonth] = votes[currentMonth] || {};
    votes[currentMonth][choice] = (votes[currentMonth][choice] || 0) + 1;

    await pb.collection("stores").update(id, { votes });
    localStorage.setItem(key, "1");
    alert("æŠ•ç¥¨ãŒå®Œäº†ã—ã¾ã—ãŸï¼");
    loadPage();
  } catch (e) {
    console.error("æŠ•ç¥¨ã‚¨ãƒ©ãƒ¼", e);
    alert("æŠ•ç¥¨ã«å¤±æ•—ã—ã¾ã—ãŸã€‚");
  }
}

// ğŸŸ¢ ãƒ¢ãƒ¼ãƒ€ãƒ«ãƒœã‚¿ãƒ³
document.getElementById("googleLoginBtn").onclick = async () => {
  try {
    const authData = await pb.collection("users").authWithOAuth2({ provider: "google" });
    console.log("âœ… Googleãƒ­ã‚°ã‚¤ãƒ³æˆåŠŸ:", authData);
    document.getElementById("loginModal").style.display = "none";
    updateUserStatus();
    const { id, choice } = window.pendingVote;
    if (id && choice) await executeVote(id, choice);
  } catch (err) {
    console.error("âŒ Googleãƒ­ã‚°ã‚¤ãƒ³å¤±æ•—:", err);
    alert("ãƒ­ã‚°ã‚¤ãƒ³ã«å¤±æ•—ã—ã¾ã—ãŸã€‚");
  }
};

document.getElementById("emailLoginBtn").onclick = () => alert("ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã§ã®ãƒ­ã‚°ã‚¤ãƒ³æ©Ÿèƒ½ã¯é–‹ç™ºä¸­ã§ã™ã€‚");
document.getElementById("closeModalBtn").onclick = () => (document.getElementById("loginModal").style.display = "none");

// ğŸŸ£ ãƒ­ã‚°ã‚¢ã‚¦ãƒˆãƒœã‚¿ãƒ³
document.getElementById("logoutBtn").onclick = () => {
  pb.authStore.clear();
  updateUserStatus();
  alert("ãƒ­ã‚°ã‚¢ã‚¦ãƒˆã—ã¾ã—ãŸã€‚");
};

loadPage();
</script>
</body>
</html>
