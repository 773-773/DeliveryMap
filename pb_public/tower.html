<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>マンション 入館情報</title>

<style>
  :root{
    --bg:#0d0d0d;
    --text:#f5f5f7;
    --muted:rgba(245,245,247,.62);
    --hair:rgba(255,255,255,.06);
    --accent:#5bff9c;
    --accent-soft:rgba(91,255,156,.28);
  }

  *{ box-sizing:border-box; }
  body{
    background:var(--bg);
    color:#fff;
    font-family:system-ui,-apple-system,BlinkMacSystemFont,"Noto Sans JP",sans-serif;
    margin:0;
    padding:10px;
  }

  /* =========================
     ✅ 画像のヘッダーに寄せる
  ========================== */
  header{
    display:flex;
    align-items:center;
    justify-content:space-between;
    gap:12px;
    padding:12px 14px;
    border-radius:18px;
    background:rgba(5,5,8,0.72);
    border:1px solid var(--hair);
    backdrop-filter:blur(22px);
    box-shadow:0 18px 60px rgba(0,0,0,0.62);
    margin-bottom:12px;

    position:sticky;
    top:0;
    z-index:50;
  }

  .logoArea{ display:flex; align-items:center; gap:0; min-width:0; }
  .logoLink{
    display:inline-block;
    min-width:0;
    color:inherit;
    text-decoration:none;
  }
  .logoTextMain{
    font-weight:900;
    font-size:18px;
    letter-spacing:0.06em;
    white-space:nowrap;
    overflow:hidden;
    text-overflow:ellipsis;
  }
  .logoTextSub{
    font-size:12px;
    line-height:1.5;
    color:rgba(245,245,247,0.55);
    white-space:nowrap;
    overflow:hidden;
    text-overflow:ellipsis;
    margin-top:2px;
  }

  .headerRight{ display:flex; align-items:center; gap:10px; flex:0 0 auto; min-width:0; }

  nav{ display:flex; align-items:center; gap:8px; flex-wrap:wrap; }
  nav a, nav button{
    color:var(--muted);
    text-decoration:none;
    padding:8px 12px;
    border-radius:999px;
    border:1px solid rgba(255,255,255,0.06);
    background:rgba(255,255,255,0.02);
    font-size:12px;
    line-height:1;
    transition:all 0.16s ease;
    white-space:nowrap;
    cursor:pointer;
    font-family:inherit;
  }
  nav a:hover, nav button:hover{ color:var(--text); background:rgba(255,255,255,0.05); }

  nav .primary{
    color:#050814;
    background:var(--accent);
    border-color:transparent;
    font-weight:900;
    box-shadow:0 0 18px var(--accent-soft);
  }
  nav .primary:hover{ background:#7affb2; }

  nav button{ appearance:none; -webkit-appearance:none; }

  /* ✅ ログイン中 pill（画像みたいに） */
  .loggedPill{
    display:inline-flex !important;
    align-items:center;
    gap:8px;
    color:#07110a !important;
    background:linear-gradient(180deg, rgba(91,255,156,0.95), rgba(91,255,156,0.78)) !important;
    border-color:rgba(91,255,156,0.18) !important;
    box-shadow:0 0 18px rgba(91,255,156,0.22), 0 12px 28px rgba(0,0,0,0.45);
    font-weight:900;
    padding:10px 18px; /* ←少し大きめ */
  }
  .loggedLamp{
    width:12px; height:12px; border-radius:50%;
    background:var(--accent);
    box-shadow:0 0 10px rgba(91,255,156,0.9), 0 0 24px rgba(91,255,156,0.38);
    position:relative;
  }
  .loggedLamp::after{
    content:"";
    position:absolute;
    inset:-10px;
    border-radius:999px;
    border:1px solid rgba(91,255,156,0.25);
    animation:pulse 1.6s ease-in-out infinite;
    opacity:0.65;
  }
  @keyframes pulse{
    0%{ transform:scale(0.72); opacity:0.25; }
    55%{ transform:scale(1.08); opacity:0.75; }
    100%{ transform:scale(1.35); opacity:0; }
  }

  .logoutPill{
    padding:10px 16px;
    color:rgba(245,245,247,0.88) !important;
    border-color:rgba(255,255,255,0.10) !important;
    background:rgba(255,255,255,0.03) !important;
    font-weight:800;
  }
  .logoutPill:hover{ border-color:rgba(91,255,156,0.18) !important; }

  @media (max-width: 640px){
    header{ flex-direction:column; align-items:stretch; gap:10px; }
    .headerRight{ flex-direction:column; align-items:stretch; gap:10px; }
    nav a, nav button{ padding:12px 14px; font-size:14px; }
    .loggedPill, .logoutPill{ justify-content:center; }
  }

  /* ====== 以下：元ページUI ====== */
  h2{ margin:12px 2px 6px; }

  .subRow{
    display:flex;
    justify-content:flex-end;
    align-items:center;
    gap:10px;
    margin:0 2px 10px;
  }
  .applyLink{
    font-size:.78em;
    color:#66ff99;
    text-decoration:none;
    white-space:nowrap;
    opacity:.95;
  }
  .applyLink:hover{ text-decoration:underline; }

  .searchContainer{
    margin:10px 0;
    display:flex;
    flex-direction:column;
    gap:6px;
  }
  .searchContainer input,
  .searchContainer select{
    padding:10px;
    background:#111;
    color:#fff;
    border:1px solid #333;
    border-radius:8px;
  }
  .searchContainer button{
    padding:10px;
    background:#ffa500;
    color:#000;
    border:none;
    border-radius:8px;
    cursor:pointer;
    font-weight:700;
  }

  .storeCard{
    background:#111;
    border:1px solid #222;
    border-radius:10px;
    padding:12px;
    margin-bottom:10px;
    font-size:.9em;
  }
  .title{
    font-weight:800;
    color:#66ff99;
    margin-bottom:6px;
    line-height:1.25;
  }
  .addr{ color:#ccc; margin-bottom:10px; line-height:1.35; }

  .row{
    display:flex;
    gap:10px;
    align-items:flex-start;
    margin:6px 0;
  }
  .label{
    width:78px;
    flex:0 0 78px;
    color:#aaa;
  }
  .value{
    flex:1;
    color:#eee;
    white-space:pre-wrap;
    line-height:1.35;
  }

  .actions{
    display:flex;
    gap:8px;
    margin-top:10px;
    flex-wrap:wrap;
    align-items:center;
  }

  .btn{
    border:none;
    border-radius:10px;
    padding:7px 10px;
    cursor:pointer;
    font-weight:800;
    font-size:.8em;
  }
  .btnEntry{ background:#1f3a2a; color:#9bffbf; border:1px solid rgba(102,255,153,.25); }
  .btnReport{ background:#1a1a1a; color:#aaa; border:1px solid rgba(255,255,255,.10); font-weight:700; }
  .btn:disabled{ opacity:.5; cursor:not-allowed; }

  .pendingPill{
    display:inline-flex;
    align-items:center;
    gap:6px;
    padding:6px 10px;
    border-radius:999px;
    font-size:.78em;
    border:1px solid rgba(255,255,255,.10);
    background:#141414;
    color:#bdbdbd;
    user-select:none;
  }
  .dot{
    width:8px;height:8px;border-radius:50%;
    background:#8f8f8f;
    display:inline-block;
  }

  .modal{
    display:none;
    position:fixed;
    inset:0;
    background:rgba(0,0,0,.72);
    justify-content:center;
    align-items:center;
    z-index:10000;
    padding:14px;
  }
  .modal .box{
    width:min(380px, 100%);
    background:#111;
    border:1px solid #222;
    border-radius:12px;
    padding:16px;
  }
  .modal h3{ margin:0 0 10px; }
  .modal .muted{ color:#bbb; font-size:.82em; line-height:1.35; }

  .choiceBlock{ text-align:left; margin-top:8px; }
  .textarea{
    width:100%;
    margin-top:10px;
    padding:10px;
    border-radius:10px;
    border:1px solid #333;
    background:#0f0f0f;
    color:#fff;
    min-height:90px;
    resize:vertical;
  }
  .small{ font-size:.8em; color:#bbb; margin-top:6px; line-height:1.35; }

  .modal button{
    width:100%;
    padding:10px;
    margin-top:10px;
    border:none;
    border-radius:10px;
    cursor:pointer;
    font-weight:800;
  }

  #googleLoginBtn{ background:#fff; color:#000; }
  #emailLoginBtn{ background:#66ff99; color:#000; }
  #closeModalBtn{ background:#333; color:#fff; }

  .select{
    width:100%;
    padding:10px;
    border-radius:10px;
    border:1px solid #333;
    background:#111;
    color:#fff;
    margin-top:10px;
  }
  #sendReportBtn{ background:#66ff99;color:#000; }
  #closeReportBtn{ background:#333;color:#fff; }
</style>
</head>

<body>

<header>
  <div class="logoArea">
    <a class="logoLink" href="index.html" aria-label="トップページへ戻る">
      <div style="min-width:0;">
        <div class="logoTextMain">FoodDeliveryEye</div>
        <div class="logoTextSub">配達員の体験を、みんなの安心と効率へ</div>
      </div>
    </a>
  </div>

  <div class="headerRight">
    <nav>
      <!-- 未ログイン表示 -->
      <a id="navAbout" href="about.html">このサイトについて</a>
      <a id="navLogin" href="login.html">ログイン</a>
      <a id="navSignup" href="signup.html" class="primary">新規登録</a>

      <!-- ログイン中はこれだけ -->
      <a id="navLoggedIn" href="mypage.html" style="display:none;">
        <span class="loggedLamp" aria-hidden="true"></span>
        ログイン中
      </a>
      <button id="navLogout" type="button" class="logoutPill" style="display:none;">ログアウトする</button>
    </nav>
  </div>
</header>

<h2>マンション 入館情報</h2>

<div class="subRow">
  <a class="applyLink" href="tower_request.html">マンション掲載申請はこちら</a>
</div>

<div class="searchContainer">
  <input id="nameInput" placeholder="建物名で検索">
  <select id="prefSelect"><option value="">都道府県</option></select>
  <select id="citySelect" style="display:none;"><option value="">市区町村</option></select>
  <button id="searchBtn">検索</button>
</div>

<div id="list"></div>

<div id="loginModal" class="modal">
  <div class="box">
    <h3>ログインが必要です</h3>
    <button id="googleLoginBtn">Googleでログイン</button>
    <button id="emailLoginBtn">メールアドレスでログイン</button>
    <button id="closeModalBtn">閉じる</button>
  </div>
</div>

<div id="entryModal" class="modal">
  <div class="box">
    <h3>入館方法の申請</h3>

    <div class="choiceBlock">
      <label><input type="radio" name="entryType" value="正面可"> 正面可</label><br>
      <label><input type="radio" name="entryType" value="正面入り口で手続き"> 正面入り口で手続き</label><br>
      <label><input type="radio" name="entryType" value="防災センター経由"> 防災センター経由</label><br>
      <label><input type="radio" name="entryType" value="その他"> その他</label>
    </div>

    <textarea id="entryComment" class="textarea" placeholder="詳細（任意）"></textarea>
    <div class="small">※ 管理人が承認したら、この物件への入館方法申請はできなくなります。</div>

    <button id="sendEntryBtn" style="background:#66ff99;color:#000;">送信</button>
    <button id="closeEntryBtn" style="background:#333;color:#fff;">閉じる</button>
  </div>
</div>

<div id="reportModal" class="modal">
  <div class="box">
    <h3>報告</h3>
    <div class="muted" id="reportInfo"></div>

    <select id="reportReason" class="select">
      <option value="">理由を選択</option>
      <option value="情報が違う">情報が違う</option>
      <option value="入館方法が変わった">入館方法が変わった</option>
      <option value="備考を追加したい">備考を追加したい</option>
      <option value="その他">その他</option>
    </select>

    <textarea id="reportComment" class="textarea" placeholder="詳細（必須）"></textarea>

    <button id="sendReportBtn">送信</button>
    <button id="closeReportBtn">閉じる</button>
  </div>
</div>

<script type="module">
import PocketBase from "https://cdn.jsdelivr.net/npm/pocketbase@0.21.2/dist/pocketbase.es.mjs";
const pb = new PocketBase("https://delivery-eye.onrender.com");

const list = document.getElementById("list");
const prefSelect = document.getElementById("prefSelect");
const citySelect = document.getElementById("citySelect");

let currentTowerId = null;
let pendingAction = null;

/* ===== ヘッダー制御（ここが今回の肝） ===== */
const navAbout    = document.getElementById("navAbout");
const navLogin    = document.getElementById("navLogin");
const navSignup   = document.getElementById("navSignup");
const navLoggedIn = document.getElementById("navLoggedIn");
const navLogout   = document.getElementById("navLogout");

function attachNext(){
  const next = encodeURIComponent(location.pathname + location.search + location.hash);
  if(navLogin)  navLogin.href  = `login.html?next=${next}`;
  if(navSignup) navSignup.href = `signup.html?next=${next}`;
}

function setNavLoggedIn(isLoggedIn){
  if(isLoggedIn){
    // ✅ ログイン中は「ログイン中」と「ログアウトする」だけ
    if(navAbout)  navAbout.style.display  = "none";
    if(navLogin)  navLogin.style.display  = "none";
    if(navSignup) navSignup.style.display = "none";

    if(navLoggedIn){
      navLoggedIn.style.display = "";
      navLoggedIn.classList.add("loggedPill"); // ←見た目を確実に
    }
    if(navLogout) navLogout.style.display = "";
  }else{
    if(navAbout)  navAbout.style.display  = "";
    if(navLogin)  navLogin.style.display  = "";
    if(navSignup) navSignup.style.display = "";

    if(navLoggedIn){
      navLoggedIn.style.display = "none";
      navLoggedIn.classList.remove("loggedPill");
    }
    if(navLogout) navLogout.style.display = "none";
  }
}

async function ensureAuthModel(){
  if(!pb.authStore.isValid){
    setNavLoggedIn(false);
    return;
  }
  try{
    if (pb.collection && pb.collection("users")?.authRefresh) {
      await pb.collection("users").authRefresh();
    }
    setNavLoggedIn(true);
  }catch{
    pb.authStore.clear();
    setNavLoggedIn(false);
  }
}

/* ✅ これで「変わってない」を潰す：状態変化を常に反映 */
try{
  pb.authStore.onChange(() => setNavLoggedIn(pb.authStore.isValid), true);
}catch{
  // onChange が無い環境でも、下の初期処理だけは動く
}

attachNext();
setNavLoggedIn(pb.authStore.isValid);
ensureAuthModel();

if(navLogout){
  navLogout.addEventListener("click", () => {
    pb.authStore.clear();
    setNavLoggedIn(false);
    loadList();
  });
}

/* ===== ブラウザID ===== */
let browserId = localStorage.getItem("towerBrowserId");
if (!browserId) {
  browserId = "id-" + Math.random().toString(36).slice(2);
  localStorage.setItem("towerBrowserId", browserId);
}

/* 都道府県 */
const prefs = [
  "北海道","青森県","岩手県","宮城県","秋田県","山形県","福島県",
  "茨城県","栃木県","群馬県","埼玉県","千葉県","東京都","神奈川県",
  "新潟県","富山県","石川県","福井県","山梨県","長野県","岐阜県",
  "静岡県","愛知県","三重県","滋賀県","京都府","大阪府","兵庫県",
  "奈良県","和歌山県","鳥取県","島根県","岡山県","広島県","山口県",
  "徳島県","香川県","愛媛県","高知県","福岡県","佐賀県","長崎県",
  "熊本県","大分県","宮崎県","鹿児島県","沖縄県"
];
prefs.forEach(p => {
  const o = document.createElement("option");
  o.value = p;
  o.textContent = p;
  prefSelect.appendChild(o);
});

/* 市区町村ロード */
prefSelect.onchange = async () => {
  const pref = prefSelect.value;
  if (!pref) {
    citySelect.style.display = "none";
    return;
  }
  const res = await pb.collection("towers").getList(1, 500, { filter: `prefecture='${escapeFilter(pref)}'` });
  const cities = [...new Set(res.items.map(i => i.city).filter(Boolean))].sort();
  citySelect.innerHTML = '<option value="">市区町村</option>';
  cities.forEach(c => {
    const o = document.createElement("option");
    o.value = c;
    o.textContent = c;
    citySelect.appendChild(o);
  });
  citySelect.style.display = "block";
};

document.getElementById("searchBtn").onclick = () => loadList();

/* 一覧ロード */
async function loadList() {
  list.innerHTML = "読み込み中…";

  let filter = "";
  const name = document.getElementById("nameInput").value.trim();
  const pref = prefSelect.value;
  const city = citySelect.value;

  if (name) filter += `name~"${escapeFilter(name)}"`;
  if (pref) filter += (filter ? " && " : "") + `prefecture='${escapeFilter(pref)}'`;
  if (city) filter += (filter ? " && " : "") + `city='${escapeFilter(city)}'`;

  const res = await pb.collection("towers").getList(1, 500, { filter, sort: "name" });
  await renderList(res.items);
}

/* 承認済み判定 */
function isEntryLocked(t){
  if (!!t.entryApproved) return true;
  const et = (t.entryType ?? "").toString().trim();
  if (et && et !== "未設定") return true;
  return false;
}

/* 申請済チェック */
async function hasPendingRequest(towerId) {
  try {
    await pb.collection("entry_requests").getFirstListItem(
      `towerId='${escapeFilter(towerId)}' && browserId='${escapeFilter(browserId)}' && status='pending'`
    );
    return true;
  } catch {
    return false;
  }
}

/* リスト表示 */
async function renderList(items) {
  list.innerHTML = "";
  if (!items.length) {
    list.textContent = "該当なし";
    return;
  }

  for (const t of items) {
    const card = document.createElement("div");
    card.className = "storeCard";

    const title = document.createElement("div");
    title.className = "title";
    title.textContent = t.name || "（名称未設定）";

    const addr = document.createElement("div");
    addr.className = "addr";
    addr.textContent = `${t.prefecture || ""} ${t.city || ""} ${t.address || ""}`.trim();

    const entryRow = document.createElement("div");
    entryRow.className = "row";
    const entryLabel = document.createElement("div");
    entryLabel.className = "label";
    entryLabel.textContent = "入館方法";
    const entryVal = document.createElement("div");
    entryVal.className = "value";
    entryVal.textContent = (t.entryType && String(t.entryType).trim()) ? t.entryType : "未設定";
    entryRow.appendChild(entryLabel);
    entryRow.appendChild(entryVal);

    const memoRow = document.createElement("div");
    memoRow.className = "row";
    const memoLabel = document.createElement("div");
    memoLabel.className = "label";
    memoLabel.textContent = "備考";
    const memoVal = document.createElement("div");
    memoVal.className = "value";
    memoVal.textContent = (t.memo && String(t.memo).trim()) ? t.memo : "なし";
    memoRow.appendChild(memoLabel);
    memoRow.appendChild(memoVal);

    const actions = document.createElement("div");
    actions.className = "actions";

    const locked = isEntryLocked(t);
    if (!locked) {
      const entryPending = await hasPendingRequest(t.id);
      if (entryPending) {
        const pill = document.createElement("div");
        pill.className = "pendingPill";
        pill.innerHTML = `<span class="dot"></span> 入館方法：承認待ち`;
        actions.appendChild(pill);
      } else {
        const b = document.createElement("button");
        b.className = "btn btnEntry";
        b.textContent = "入館方法を申請";
        b.onclick = () => openEntryModal(t.id);
        actions.appendChild(b);
      }
    }

    const report = document.createElement("button");
    report.className = "btn btnReport";
    report.textContent = "報告";
    report.onclick = () => openReportModal(t);
    actions.appendChild(report);

    card.appendChild(title);
    card.appendChild(addr);
    card.appendChild(entryRow);
    card.appendChild(memoRow);
    card.appendChild(actions);

    list.appendChild(card);
  }
}

/* 入館申請 */
function openEntryModal(towerId) {
  currentTowerId = towerId;
  document.getElementById("entryComment").value = "";
  document.querySelectorAll("input[name='entryType']").forEach(x => x.checked = false);
  document.getElementById("entryModal").style.display = "flex";
}
document.getElementById("closeEntryBtn").onclick = () => {
  document.getElementById("entryModal").style.display = "none";
};

document.getElementById("sendEntryBtn").onclick = async () => {
  const sel = document.querySelector("input[name='entryType']:checked");
  if (!sel) return alert("入館方法を選択してください");
  const comment = document.getElementById("entryComment").value.trim();

  if (!pb.authStore.isValid) {
    document.getElementById("entryModal").style.display = "none";
    document.getElementById("loginModal").style.display = "flex";
    pendingAction = { type:"entry", towerId: currentTowerId, payload: { method: sel.value, comment } };
    return;
  }

  await sendEntryRequest(currentTowerId, sel.value, comment);
};

async function sendEntryRequest(towerId, method, comment) {
  try {
    const t = await pb.collection("towers").getOne(towerId);
    if (isEntryLocked(t)) return alert("この物件は申請できません（承認済/設定済）。");

    const already = await hasPendingRequest(towerId);
    if (already) return alert("既に申請済（承認待ち）です。");

    await pb.collection("entry_requests").create({
      towerId, method, comment, browserId, status: "pending"
    });

    alert("入館方法を申請しました。ありがとうございます。");
    document.getElementById("entryModal").style.display = "none";
    loadList();
  } catch (e) {
    console.error(e);
    alert("申請の送信に失敗しました: " + (e?.message || e));
  }
}

/* 報告 */
let currentReportTowerId = null;

function openReportModal(tower){
  currentReportTowerId = tower.id;

  const info = document.getElementById("reportInfo");
  info.innerHTML =
    `建物：<b>${escapeHtml(tower.name || "（名称未設定）")}</b><br>` +
    `住所：${escapeHtml(`${tower.prefecture||""} ${tower.city||""} ${tower.address||""}`.trim())}`;

  document.getElementById("reportReason").value = "";
  document.getElementById("reportComment").value = "";
  document.getElementById("reportModal").style.display = "flex";
}

document.getElementById("closeReportBtn").onclick = () => {
  document.getElementById("reportModal").style.display = "none";
  currentReportTowerId = null;
};

document.getElementById("sendReportBtn").onclick = async () => {
  const reason = document.getElementById("reportReason").value.trim();
  const comment = document.getElementById("reportComment").value.trim();
  if (!reason) return alert("理由を選択してください");
  if (!comment) return alert("詳細（コメント）を書いてください");

  if (!pb.authStore.isValid) {
    document.getElementById("reportModal").style.display = "none";
    document.getElementById("loginModal").style.display = "flex";
    pendingAction = { type:"report", towerId: currentReportTowerId, payload: { reason, comment } };
    return;
  }

  await sendTowerReport(currentReportTowerId, reason, comment);
};

async function sendTowerReport(towerId, reason, comment){
  try{
    await pb.collection("towerReports").create({ towerId, reason, comment, browserId });
    alert("報告を送信しました。ありがとうございます。");
    document.getElementById("reportModal").style.display = "none";
    currentReportTowerId = null;
  }catch(e){
    console.error(e);
    alert("報告の送信に失敗しました: " + (e?.message || e));
  }
}

/* ログイン */
document.getElementById("googleLoginBtn").onclick = async () => {
  try {
    await pb.collection("users").authWithOAuth2({ provider: "google" });
    document.getElementById("loginModal").style.display = "none";
    await ensureAuthModel(); // ←確実にヘッダー反映

    if (pendingAction) {
      const a = pendingAction; pendingAction = null;
      if (a.type === "entry")  await sendEntryRequest(a.towerId, a.payload.method, a.payload.comment);
      if (a.type === "report") await sendTowerReport(a.towerId, a.payload.reason, a.payload.comment);
    }
  } catch (e) {
    console.error(e);
    alert("ログイン失敗");
  }
};

document.getElementById("emailLoginBtn").onclick = () => {
  alert("メールログインはこのHTMLでは未実装（必要なら実装する）。");
};
document.getElementById("closeModalBtn").onclick = () => {
  document.getElementById("loginModal").style.display = "none";
};

/* util */
function escapeHtml(s){
  return String(s ?? "")
    .replaceAll("&","&amp;")
    .replaceAll("<","&lt;")
    .replaceAll(">","&gt;")
    .replaceAll('"',"&quot;")
    .replaceAll("'","&#039;");
}
function escapeFilter(s){
  return String(s ?? "").replaceAll("\\", "\\\\").replaceAll("'", "\\'");
}

/* 初期 */
loadList();
</script>

</body>
</html>
