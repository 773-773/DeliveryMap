<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>é»’ãƒ¢ãƒ€ãƒ³A æœˆè¡¨ç¤ºä»˜ãï¼ˆPocketBaseç‰ˆï¼‰</title>
<style>
body { font-family: sans-serif; margin:0; padding:6px; background:#0d0d0d; color:#fff; }
#requestBtn { display:inline-block; margin:2px 0 8px 0; font-size:0.7em; color:#66ff99; text-decoration:underline; background:none; border:none; padding:0; cursor:pointer; }
h2 { margin-bottom:4px; line-height:1.2em; }
h2 small { display:block; font-size:0.7em; color:#ccc; margin-top:2px; }
.searchContainer { display:flex; flex-direction:column; gap:4px; margin-bottom:8px; }
.searchContainer div { display:flex; gap:4px; }
.searchContainer input, .searchContainer select { padding:6px; border-radius:6px; border:1px solid #333; font-size:0.9em; flex:1; background:#111; color:#fff; }
.searchContainer button { padding:6px; border-radius:6px; border:1px solid #333; font-size:0.9em; cursor:pointer; background:#ffa500; color:#000; }
.storeCard { display:flex; justify-content:space-between; padding:6px; margin-bottom:6px; border:1px solid #222; border-radius:6px; background:#111; font-size:0.8em; }
.leftColumn { flex:1; margin-right:6px; display:flex; flex-direction:column; gap:4px; }
.storeName { font-weight:bold; color:#66ff99; }
.address { font-size:0.7em; color:#ccc; }
.rightColumn { flex:1; background:#1a1a1a; padding:4px; border-radius:4px; font-size:0.7em; text-align:left; }
.voteContainer { display:flex; align-items:center; gap:4px; flex-wrap:wrap; }
.voteCount { font-weight:bold; color:#ff6600; }
.monthLabel { color:#fff; font-weight:bold; }
.accordion { font-size:0.7em; padding:2px 4px; margin-top:2px; background:#333; border:none; border-radius:3px; cursor:pointer; width:100%; text-align:left; color:#fff; }
.panel { display:none; font-size:0.7em; padding-left:4px; background:#222; border-radius:2px; margin-bottom:2px; color:#ccc; }
</style>
</head>
<body>
<h2>èª¿ç†å¾…ã¡æ™‚é–“äºˆæ¸¬<small>â€»ãŠåº—åˆ°ç€å¾Œã«å•†å“å—å–ã¾ã§ã«ã‹ã‹ã£ãŸæ™‚é–“</small></h2>
<button id="requestBtn" onclick="location.href='request.html'">æ²è¼‰åº—èˆ—ã‚’ç”³è«‹ã™ã‚‹</button>

<div class="searchContainer">
  <input id="nameInput" placeholder="åº—èˆ—åã§æ¤œç´¢">
  <div>
    <select id="prefSelect"><option value="">éƒ½é“åºœçœŒã‚’é¸æŠ</option></select>
    <select id="citySelect" style="display:none;"><option value="">å¸‚åŒºç”ºæ‘ã‚’é¸æŠ</option></select>
  </div>
  <button id="searchBtn">æ¤œç´¢</button>
</div>

<div id="storeContainer"></div>

<script type="module">
import PocketBase from "https://cdn.jsdelivr.net/npm/pocketbase@0.21.2/dist/pocketbase.es.mjs";
const pb = new PocketBase("https://delivery-eye.onrender.com");

// ---- ğŸŸ¢ ãƒ­ã‚°ã‚¤ãƒ³çŠ¶æ…‹ã®ç¢ºèª ----
if (!pb.authStore.isValid) {
  console.log("æœªãƒ­ã‚°ã‚¤ãƒ³: æŠ•ç¥¨æ™‚ã«ãƒ­ã‚°ã‚¤ãƒ³ç”»é¢ã¸èª˜å°ã—ã¾ã™");
} else {
  console.log("ãƒ­ã‚°ã‚¤ãƒ³ä¸­:", pb.authStore.model?.email);
}

// éƒ½é“åºœçœŒãƒªã‚¹ãƒˆ
const prefs=["åŒ—æµ·é“","é’æ£®çœŒ","å²©æ‰‹çœŒ","å®®åŸçœŒ","ç§‹ç”°çœŒ","å±±å½¢çœŒ","ç¦å³¶çœŒ","èŒ¨åŸçœŒ","æ ƒæœ¨çœŒ","ç¾¤é¦¬çœŒ","åŸ¼ç‰çœŒ","åƒè‘‰çœŒ","æ±äº¬éƒ½","ç¥å¥ˆå·çœŒ","æ–°æ½ŸçœŒ","å¯Œå±±çœŒ","çŸ³å·çœŒ","ç¦äº•çœŒ","å±±æ¢¨çœŒ","é•·é‡çœŒ","å²é˜œçœŒ","é™å²¡çœŒ","æ„›çŸ¥çœŒ","ä¸‰é‡çœŒ","æ»‹è³€çœŒ","äº¬éƒ½åºœ","å¤§é˜ªåºœ","å…µåº«çœŒ","å¥ˆè‰¯çœŒ","å’Œæ­Œå±±çœŒ","é³¥å–çœŒ","å³¶æ ¹çœŒ","å²¡å±±çœŒ","åºƒå³¶çœŒ","å±±å£çœŒ","å¾³å³¶çœŒ","é¦™å·çœŒ","æ„›åª›çœŒ","é«˜çŸ¥çœŒ","ç¦å²¡çœŒ","ä½è³€çœŒ","é•·å´çœŒ","ç†Šæœ¬çœŒ","å¤§åˆ†çœŒ","å®®å´çœŒ","é¹¿å…å³¶çœŒ","æ²–ç¸„çœŒ"];
const prefSelect=document.getElementById("prefSelect");
prefs.forEach(p=>{const o=document.createElement("option");o.value=p;o.textContent=p;prefSelect.appendChild(o);});
const citySelect=document.getElementById("citySelect");

let currentPage=1,pageSize=20;
const voteOptions=["ã»ã¼ãªã—","2ã€œ3åˆ†","5ã€œ10åˆ†","10åˆ†ä»¥ä¸Š"];
const now=new Date(),currentMonth=`${now.getFullYear()}å¹´${now.getMonth()+1}æœˆ`;
const pastMonths=[...Array(2)].map((_,i)=>{const d=new Date(now.getFullYear(),now.getMonth()-i-1,1);return `${d.getFullYear()}å¹´${d.getMonth()+1}æœˆ`;});
let browserId=localStorage.getItem("browserId");if(!browserId){browserId="id-"+Math.random().toString(36).slice(2);localStorage.setItem("browserId",browserId);}

prefSelect.onchange=async()=>{
  const pref=prefSelect.value;
  if(!pref){citySelect.style.display="none";return;}
  const res=await pb.collection("stores").getList(1,500,{filter:`prefecture="${pref}"`});
  const cities=[...new Set(res.items.map(i=>i.city).filter(Boolean))].sort();
  citySelect.innerHTML='<option value="">å¸‚åŒºç”ºæ‘ã‚’é¸æŠ</option>';
  cities.forEach(c=>{const o=document.createElement("option");o.value=c;o.textContent=c;citySelect.appendChild(o);});
  citySelect.style.display="block";
};

document.getElementById("searchBtn").onclick=()=>loadPage(1);

async function loadPage(page=1){
  const container=document.getElementById("storeContainer");
  container.innerHTML="<p>èª­ã¿è¾¼ã¿ä¸­...</p>";
  const name=document.getElementById("nameInput").value.trim();
  const pref=prefSelect.value,city=citySelect.value;
  let filter="";
  if(name)filter+=`name~"${name}"`;
  if(pref)filter+=(filter?" && ":"")+`prefecture="${pref}"`;
  if(city)filter+=(filter?" && ":"")+`city="${city}"`;
  try{
    const list=await pb.collection("stores").getList(page,pageSize,{filter,sort:"name"});
    renderStores(list.items);
  }catch(e){console.error(e);container.textContent="èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼";}
}

function renderStores(stores){
  const container=document.getElementById("storeContainer");
  container.innerHTML="";
  if(!stores.length){container.textContent="è©²å½“åº—èˆ—ãªã—";return;}
  stores.forEach(s=>{
    const card=document.createElement("div");card.className="storeCard";
    const left=document.createElement("div");left.className="leftColumn";
    left.innerHTML=`<div class="storeName">${s.name}</div><div class="address">${s.prefecture||""} ${s.city||""} ${s.address||""}</div>`;
    const voteBox=document.createElement("div");voteBox.className="voteContainer";
    const votedKey=`${s.id}-${currentMonth}-${browserId}`;
    if(localStorage.getItem(votedKey)){
      const tag=document.createElement("span");tag.textContent="ä»Šæœˆã¯æŠ•ç¥¨æ¸ˆ";tag.style.background="#ffa500";tag.style.color="#000";tag.style.padding="2px 4px";tag.style.borderRadius="4px";voteBox.appendChild(tag);
    }else{
      const sel=document.createElement("select");voteOptions.forEach(v=>{const o=document.createElement("option");o.value=v;o.textContent=v;sel.appendChild(o);});
      const btn=document.createElement("button");btn.textContent="æŠ•ç¥¨";
      btn.onclick=()=>vote(s.id,sel.value);
      voteBox.appendChild(sel);voteBox.appendChild(btn);
    }
    left.appendChild(voteBox);

    const right=document.createElement("div");right.className="rightColumn";
    let nowLine="";voteOptions.forEach(v=>{const c=s.votes?.[currentMonth]?.[v]||0;nowLine+=`ãƒ»${v}: <span class='voteCount'>${c}äºº</span> `;});
    right.innerHTML=`<div>${currentMonth} ${nowLine}</div>`;
    pastMonths.forEach(m=>{
      const acc=document.createElement("button");acc.className="accordion";acc.textContent=`${m}ã®çµæœ`;
      const panel=document.createElement("div");panel.className="panel";
      let txt="";voteOptions.forEach(v=>{const c=s.votes?.[m]?.[v]||0;txt+=`ãƒ»${v}: ${c}äºº `;});
      panel.textContent=txt;acc.onclick=()=>panel.style.display=panel.style.display==="block"?"none":"block";right.appendChild(acc);right.appendChild(panel);
    });

    card.appendChild(left);card.appendChild(right);container.appendChild(card);
  });
}

async function vote(id,choice){
  // ---- ğŸŸ¡ ãƒ­ã‚°ã‚¤ãƒ³ãƒã‚§ãƒƒã‚¯è¿½åŠ  ----
  if (!pb.authStore.isValid) {
    alert("æŠ•ç¥¨ã™ã‚‹ã«ã¯ãƒ­ã‚°ã‚¤ãƒ³ãŒå¿…è¦ã§ã™ã€‚ãƒ­ã‚°ã‚¤ãƒ³ãƒšãƒ¼ã‚¸ã¸ç§»å‹•ã—ã¾ã™ã€‚");
    window.location.href = "/login.html";  // â† ã‚ãªãŸã®ãƒ­ã‚°ã‚¤ãƒ³ãƒšãƒ¼ã‚¸ãƒ‘ã‚¹ã«åˆã‚ã›ã¦å¤‰æ›´
    return;
  }

  const key=`${id}-${currentMonth}-${browserId}`;
  if(localStorage.getItem(key)){alert("ä»Šæœˆã¯æŠ•ç¥¨æ¸ˆ");return;}
  try{
    const s=await pb.collection("stores").getOne(id);
    const votes=s.votes||{};votes[currentMonth]=votes[currentMonth]||{};votes[currentMonth][choice]=(votes[currentMonth][choice]||0)+1;
    await pb.collection("stores").update(id,{votes});
    localStorage.setItem(key,"1");
    loadPage();
  }catch(e){console.error("æŠ•ç¥¨ã‚¨ãƒ©ãƒ¼",e);}
}

loadPage();
</script>
</body>
</html>
<!-- force update #åˆå¾Œ -->
