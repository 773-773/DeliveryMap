<!-- =========================
     poll.html（アンケートページ）
     ✅ 未ログインで回答しようとしたら login.html に飛ばし、
        ログイン後に poll.html に戻る
     ※ 他は極力そのまま。変更点は「未ログイン時のクリック挙動」だけ
========================= -->
<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>アンケート | FoodDeliveryEye</title>

<style>
:root{
  --bg-main:#07070b;
  --bg-elevated:#0c0c12;
  --accent:#5bff9c;
  --accent-soft: rgba(91, 255, 156, 0.28);
  --accent2:#23ffd1;
  --text-main:#f5f5f7;
  --text-muted:rgba(245,245,247,0.62);
  --border-soft: rgba(255,255,255,0.08);
  --border-hair: rgba(255,255,255,0.06);
  --danger: rgba(255,182,182,.95);
}
*{ box-sizing:border-box; }
body{
  margin:0;
  min-height:100vh;
  font-family:-apple-system,BlinkMacSystemFont,"Inter","Noto Sans JP",sans-serif;
  color:var(--text-main);
  background:
    radial-gradient(circle at 18% 0%, rgba(91,255,156,0.09) 0, transparent 55%),
    radial-gradient(circle at 90% 90%, rgba(255,255,255,0.03) 0, transparent 55%),
    linear-gradient(180deg, #050507 0%, #07070b 60%, #050507 100%);
}

/* ✅ 重要：pageのpaddingでヘッダーが大きく見えるのを防ぐ（掲示板と同じ“ヘッダー自身が余白を持つ”方式） */
.page{
  max-width:1040px;
  margin:0 auto;
  padding:0; /* ←ここがポイント */
}

/* =========================
   ✅ あなたの掲示板と「同一」ヘッダー（1pxも変えない）
========================= */
header.siteHeader{
  display:flex;
  align-items:center;
  justify-content:space-between;
  gap:12px;
  padding:12px 14px;
  border-radius:18px;
  background:rgba(5,5,8,0.72);
  border:1px solid rgba(255,255,255,0.06);
  backdrop-filter:blur(22px);
  box-shadow:0 18px 60px rgba(0,0,0,0.62);
  margin:12px 12px 18px;
  position:relative;
  z-index:50;
  border-bottom:none;
}
.logoArea{ display:flex; align-items:center; min-width:0; }
.logoLink{ display:inline-block; min-width:0; color:inherit; text-decoration:none; }
.logoTextMain{
  font-weight:900;
  font-size:18px;
  letter-spacing:0.06em;
  white-space:nowrap;
  overflow:hidden;
  text-overflow:ellipsis;
}
.logoTextSub{
  font-size:12px;
  line-height:1.5;
  color:rgba(245,245,247,0.55);
  white-space:nowrap;
  overflow:hidden;
  text-overflow:ellipsis;
  margin-top:2px;
}
.headerRight{ display:flex; align-items:center; gap:10px; flex:0 0 auto; min-width:0; }
nav{ display:flex; align-items:center; gap:8px; flex-wrap:wrap; }
nav a, nav button{
  color:rgba(245,245,247,0.62);
  text-decoration:none;
  padding:8px 12px;
  border-radius:999px;
  border:1px solid rgba(255,255,255,0.06);
  background:rgba(255,255,255,0.02);
  font-size:12px;
  line-height:1;
  transition:all .16s ease;
  white-space:nowrap;
  cursor:pointer;
  font-family:inherit;
}
nav a:hover, nav button:hover{ color:#f5f5f7; background:rgba(255,255,255,0.05); }
nav .primary{
  color:#050814;
  background:#5bff9c;
  border-color:transparent;
  font-weight:900;
  box-shadow:0 0 18px rgba(91,255,156,0.28);
}
nav .primary:hover{ background:#7affb2; }
nav button{ appearance:none; -webkit-appearance:none; }
.loggedPill{
  display:inline-flex !important;
  align-items:center;
  gap:8px;
  color:#07110a !important;
  background:linear-gradient(180deg, rgba(91,255,156,0.95), rgba(91,255,156,0.78)) !important;
  border-color:rgba(91,255,156,0.18) !important;
  box-shadow:0 0 18px rgba(91,255,156,0.22), 0 12px 28px rgba(0,0,0,0.45);
  font-weight:900;
}
.loggedLamp{
  width:10px; height:10px; border-radius:50%;
  background:#5bff9c;
  box-shadow:0 0 10px rgba(91,255,156,0.9), 0 0 24px rgba(91,255,156,0.38);
  position:relative;
}
.loggedLamp::after{
  content:"";
  position:absolute;
  inset:-8px;
  border-radius:999px;
  border:1px solid rgba(91,255,156,0.25);
  animation:pulse 1.6s ease-in-out infinite;
  opacity:.65;
}
@keyframes pulse{
  0%{ transform:scale(0.72); opacity:0.25; }
  55%{ transform:scale(1.08); opacity:0.75; }
  100%{ transform:scale(1.35); opacity:0; }
}
.logoutPill{
  color:rgba(245,245,247,0.88) !important;
  border-color:rgba(255,255,255,0.10) !important;
  background:rgba(255,255,255,0.03) !important;
}
.logoutPill:hover{ border-color:rgba(91,255,156,0.18) !important; }

@media (max-width:640px){
  header.siteHeader{ flex-direction:column; align-items:stretch; gap:10px; }
  .headerRight{ flex-direction:column; align-items:stretch; gap:10px; }
  nav a, nav button{ padding:12px 14px; font-size:14px; }
}

/* =========================
   ここから下：アンケート本体（元のまま）
========================= */

/* top */
.topTools{
  display:flex;
  justify-content:flex-end;
  gap:10px;
  margin: 6px 12px 14px; /* ← page padding消した分、横12pxだけ合わせる */
  flex-wrap:wrap;
}
.pillBtn{
  display:inline-flex;
  align-items:center;
  gap:10px;
  border-radius:999px;
  padding:10px 12px;
  text-decoration:none;
  font-weight:900;
  font-size:12px;
  border:1px solid rgba(255,255,255,0.08);
  background:rgba(10,10,16,0.72);
  color:rgba(245,245,247,0.90);
  box-shadow:0 14px 42px rgba(0,0,0,0.55);
  transition:all .16s ease;
}
.pillBtn:hover{ background:rgba(255,255,255,0.05); transform:translateY(-1px); }
.pillDot{ width:9px; height:9px; border-radius:50%; background:var(--accent); box-shadow:0 0 14px rgba(91,255,156,.35); }

.pillWrap{ display:flex; align-items:center; justify-content:space-between; gap:12px; flex:1; min-width:0; }
.pillLeftFill{
  flex:1;
  min-width:0;
  height:44px;
  display:flex;
  align-items:center;
  padding-left:18px;
  font-size:13px;
  font-weight:700;
  color:rgba(245,245,247,0.75);
  border-radius:999px;
  border:1px solid rgba(255,255,255,0.06);
  background:rgba(255,255,255,0.015);
  box-shadow: inset 0 0 0 1px rgba(255,255,255,0.02);
}

/* poll list */
.list{ display:flex; flex-direction:column; gap:12px; padding:0 12px; }
.card{
  position:relative;
  padding:18px 16px 16px;
  border-radius:22px;
  background:rgba(10,10,16,0.88);
  border:1px solid var(--border-hair);
  box-shadow:0 18px 50px rgba(0,0,0,0.65);
  overflow:hidden;
}
.cardHead{
  display:flex;
  justify-content:space-between;
  align-items:flex-start;
  gap:12px;
}
.q{
  font-size:16px;
  font-weight:900;
  line-height:1.5;
  margin:0;
}
.meta{
  font-size:11px;
  color:rgba(245,245,247,.45);
  white-space:nowrap;
}
.choices{ margin-top:12px; display:flex; flex-direction:column; gap:10px; }

.choiceBtn{
  position:relative;
  padding:12px 14px;
  border-radius:16px;
  border:1px solid rgba(255,255,255,0.10);
  background:rgba(255,255,255,0.03);
  color:#fff;
  font-size:14px;
  font-weight:900;
  cursor:pointer;
  display:flex;
  justify-content:space-between;
  align-items:center;
  overflow:hidden;
  --pct:0;
}
.choiceBtn::before{
  content:"";
  position:absolute;
  inset:0;
  width:calc(var(--pct) * 1%);
  background:linear-gradient(90deg, rgba(91,255,156,.35), rgba(35,255,209,.25));
  opacity:0;
}
.choiceBtn[data-show="1"]::before{ opacity:1; }
.choiceBtn span{ position:relative; z-index:1; }
.choiceBtn .pct{
  font-size:12px;
  min-width:54px;
  text-align:right;
  opacity:0;
  color:rgba(245,245,247,0.78);
}
.choiceBtn[data-show="1"] .pct{ opacity:1; }

.choiceBtn:hover{ background:rgba(255,255,255,0.06); border-color:rgba(91,255,156,0.22); }
.choiceBtn.isLocked{ cursor:default; opacity:.92; }
.choiceBtn.isLocked:hover{ background:rgba(255,255,255,0.03); border-color:rgba(255,255,255,0.10); }

.bottomRow{ display:flex; justify-content:space-between; align-items:center; gap:10px; margin-top:10px; }
.count{ font-size:11px; color:rgba(245,245,247,.45); }
.msg{ font-size:11px; color:#a7aed0; min-height:18px; white-space:pre-wrap; margin-top:8px; }
.note{ margin-top:10px; font-size:11px; color:rgba(245,245,247,.55); line-height:1.6; }

.systemMsg{
  margin:12px 12px 0;
  font-size:12px;
  color:rgba(245,245,247,.70);
  padding:12px 12px;
  border-radius:16px;
  border:1px solid rgba(255,255,255,0.08);
  background:rgba(255,255,255,0.02);
}
.systemMsg b{ color:var(--text-main); }
.systemMsg .err{ color: var(--danger); }

footer{
  margin-top:28px;
  padding:12px 12px 0;
  border-top:1px solid rgba(255,255,255,0.05);
  font-size:11px;
  color:rgba(245,245,247,0.36);
}

/* pagination */
.pager{
  margin-top:18px;
  display:flex;
  justify-content:center;
  gap:10px;
  padding:0 12px;
}
.pagerInner{
  display:flex;
  align-items:center;
  gap:10px;
  padding:10px 12px;
  border-radius:16px;
  border:1px solid rgba(255,255,255,0.06);
  background:rgba(0,0,0,0.22);
  box-shadow:0 18px 55px rgba(0,0,0,0.58);
}
.pageBtns{ display:flex; align-items:center; gap:10px; }
.pageBtn{
  width:44px;
  height:40px;
  border-radius:12px;
  border:1px solid rgba(255,255,255,0.08);
  background:rgba(255,255,255,0.04);
  color:#fff;
  font-weight:900;
  cursor:pointer;
  transition:all .16s ease;
}
.pageBtn:hover{ background:rgba(255,255,255,0.07); transform:translateY(-1px); }
.pageBtn:active{ transform:translateY(0px); }
.pageBtn.isActive{
  background:#f0b246;
  color:#050507;
  border-color:transparent;
  box-shadow:0 0 0 2px rgba(240,178,70,0.18), 0 12px 28px rgba(0,0,0,0.45);
}
.nextBtn{
  height:40px;
  padding:0 16px;
  border-radius:12px;
  border:1px solid rgba(255,255,255,0.08);
  background:rgba(255,255,255,0.04);
  color:#fff;
  font-weight:900;
  cursor:pointer;
  transition:all .16s ease;
}
.nextBtn:hover{ background:rgba(255,255,255,0.07); transform:translateY(-1px); }
.nextBtn:active{ transform:translateY(0px); }
.nextBtn:disabled,.pageBtn:disabled{ opacity:.45; cursor:default; transform:none; }

@media (max-width: 640px){
  .topTools{justify-content:flex-start}
  .pillWrap{width:100%}
  .pager{justify-content:flex-start}
}
</style>
</head>

<body>
<div class="page">

<header class="siteHeader">
  <div class="logoArea">
    <a class="logoLink" href="index.html" aria-label="トップページへ戻る">
      <div style="min-width:0;">
        <div class="logoTextMain">FoodDeliveryEye</div>
        <div class="logoTextSub">配達員の体験を、みんなの安心と効率へ</div>
      </div>
    </a>
  </div>

  <div class="headerRight">
    <nav>
      <a id="navAbout" href="about.html">このサイトについて</a>
      <a id="navLogin" href="login.html">ログイン</a>
      <a id="navSignup" href="signup.html" class="primary">新規登録</a>

      <a id="navLoggedIn" href="mypage.html" style="display:none;">
        <span class="loggedLamp" aria-hidden="true"></span>
        ログイン中
      </a>
      <button id="navLogout" type="button" class="logoutPill" style="display:none;">ログアウト</button>
    </nav>
  </div>
</header>

<div class="topTools">
  <div class="pillWrap">
    <div class="pillLeftFill">
      みんなの声で、次のアンケートが決まります
    </div>
    <a class="pillBtn" href="poll_request.html" aria-label="アンケート案 募集中">
      <span class="pillDot"></span>アンケート案 募集中
    </a>
  </div>
</div>

<div id="systemMsg" class="systemMsg" style="display:none"></div>
<div class="list" id="pollList"></div>

<div class="pager" id="pager" style="display:none">
  <div class="pagerInner">
    <div class="pageBtns" id="pageBtns"></div>
    <button class="nextBtn" id="nextBtn" type="button">次へ</button>
  </div>
</div>

<footer>© FoodDeliveryEye</footer>
</div>

<script src="https://cdn.jsdelivr.net/npm/pocketbase@0.21.1/dist/pocketbase.umd.js"></script>

<script>
(() => {
  const PB_URL = "https://delivery-eye.onrender.com";
  const pb = new window.PocketBase(PB_URL);

  /* =========================
     ✅ 共通：戻り先（next）管理
     - 未ログイン時に回答クリック → 現在URLを保存して login.html?next=... へ
     - login.html でログイン成功 → next に戻る
  ========================= */
  const KEY_NEXT_STORE = "fdel_next_url_v1";

  function currentRelativeUrl(){
    // 相対パスのみにする（open redirect対策）
    return location.pathname.split("/").pop() + location.search + location.hash;
  }

  function goLoginWithNext(){
    try{
      const next = currentRelativeUrl();
      localStorage.setItem(KEY_NEXT_STORE, next);
      location.href = "login.html?next=" + encodeURIComponent(next);
    }catch{
      location.href = "login.html?next=" + encodeURIComponent(currentRelativeUrl());
    }
  }

  /* =========================
     ✅ ヘッダー：ログイン状態切替（元のまま）
  ========================= */
  const navAbout    = document.getElementById("navAbout");
  const navLogin    = document.getElementById("navLogin");
  const navSignup   = document.getElementById("navSignup");
  const navLoggedIn = document.getElementById("navLoggedIn");
  const navLogout   = document.getElementById("navLogout");

  navLogin?.addEventListener("click", (e)=>{
    try{
      const next = currentRelativeUrl();
      localStorage.setItem(KEY_NEXT_STORE, next);
      navLogin.href = "login.html?next=" + encodeURIComponent(next);
    }catch{}
  });

  function setNavLoggedIn(isLoggedIn){
    if(isLoggedIn){
      navAbout.style.display = "none";
      navLogin.style.display = "none";
      navSignup.style.display = "none";
      navLoggedIn.style.display = "";
      navLoggedIn.classList.add("loggedPill");
      navLogout.style.display = "";
    }else{
      navAbout.style.display = "";
      navLogin.style.display = "";
      navSignup.style.display = "";
      navLoggedIn.style.display = "none";
      navLoggedIn.classList.remove("loggedPill");
      navLogout.style.display = "none";
    }
  }

  async function ensureAuthModel(){
    if(!pb.authStore.isValid){
      setNavLoggedIn(false);
      return;
    }
    try{
      await pb.collection("users").authRefresh();
      setNavLoggedIn(true);
    }catch{
      pb.authStore.clear();
      setNavLoggedIn(false);
    }
  }

  navLogout?.addEventListener("click", ()=>{
    if(!confirm("ログアウトしますか？")) return;
    pb.authStore.clear();
    setNavLoggedIn(false);
    location.reload();
  });

  setNavLoggedIn(pb.authStore.isValid);
  ensureAuthModel();

  /* =========================
     以下：アンケート本体（ほぼ元のまま）
     ✅ 変更点：未ログイン時は「メッセージ表示」ではなく login.html に飛ばす
  ========================= */
  const pollListEl = document.getElementById("pollList");
  const systemMsgEl = document.getElementById("systemMsg");

  const pagerEl = document.getElementById("pager");
  const pageBtnsEl = document.getElementById("pageBtns");
  const nextBtnEl = document.getElementById("nextBtn");
  const PER_PAGE = 15;
  let topicsAll = [];
  let currentPage = 1;

  function escapeHtml(s){
    return (s||"")
      .replaceAll("&","&amp;")
      .replaceAll("<","&lt;")
      .replaceAll(">","&gt;")
      .replaceAll('"',"&quot;")
      .replaceAll("'","&#039;");
  }

  function sysMsg(html, isErr=false){
    systemMsgEl.style.display = "block";
    systemMsgEl.innerHTML = isErr ? `<span class="err">${html}</span>` : html;
  }

  window.addEventListener("error", (e)=>{
    sysMsg("JSエラー: " + escapeHtml(e.message || "unknown"), true);
  });
  window.addEventListener("unhandledrejection", (e)=>{
    sysMsg("Promiseエラー: " + escapeHtml(e.reason?.message || e.reason || "unknown"), true);
  });

  function lock(card, v){
    card.querySelectorAll(".choiceBtn").forEach(b=>{
      b.disabled = v;
      b.classList.toggle("isLocked", v);
    });
  }

  function indexToKey(idx){ return "c" + String(idx); }

  async function getMyVote(topicId){
    if(!pb.authStore.isValid) return null;
    const me = pb.authStore.model?.id;
    if(!me) return null;

    try{
      const item = await pb.collection("polls").getFirstListItem(
        `topic="${topicId}" && user="${me}"`
      );
      if(item?.choiceKey) return String(item.choiceKey);
      if(item?.choice) return String(item.choice);
      if(item?.choiceIndex) return indexToKey(Number(item.choiceIndex));
      return null;
    }catch{
      return null;
    }
  }

  async function getCounts(topicId){
    try{
      const recs = await pb.collection("polls").getFullList({ filter:`topic="${topicId}"` });

      const counts = {1:0,2:0,3:0,4:0};

      recs.forEach(r=>{
        let idx = 0;
        if(r.choiceIndex) idx = Number(r.choiceIndex);
        else if(r.choiceKey) idx = Number(String(r.choiceKey).replace("c",""));
        else if(r.choice) idx = Number(String(r.choice).replace("c",""));
        if(counts[idx] !== undefined) counts[idx]++;
      });

      const total = Object.values(counts).reduce((a,b)=>a+b,0);
      return {counts,total};
    }catch{
      return {counts:{1:0,2:0,3:0,4:0}, total:0, denied:true};
    }
  }

  function renderResult(card, counts){
    const total = Object.values(counts).reduce((a,b)=>a+b,0);

    card.querySelectorAll(".choiceBtn").forEach(btn=>{
      const idx = Number(btn.dataset.choiceIndex);
      const pct = total ? Math.round((counts[idx]/total)*100) : 0;
      btn.style.setProperty("--pct", pct);
      btn.querySelector(".pct").textContent = pct + "%";
      btn.dataset.show = "1";
      btn.disabled = true;
      btn.classList.add("isLocked");
    });

    card.querySelector(".count").textContent = total ? `${total}人が回答` : "0人が回答";
  }

  function buildCard(t){
    const card = document.createElement("section");
    card.className = "card";

    const created10 = (t.created || "").slice(0,10);

    const choices = [t.choice1,t.choice2,t.choice3,t.choice4]
      .map(v => (v||"").trim())
      .filter(Boolean);

    const noteHtml = t.note ? `<div class="note">補足：${escapeHtml(t.note)}</div>` : "";

    card.innerHTML = `
      <div class="cardHead">
        <p class="q">${escapeHtml(t.question || "")}</p>
        <div class="meta">${escapeHtml(created10)}</div>
      </div>

      <div class="choices">
        ${choices.map((c,i)=>`
          <button type="button" class="choiceBtn" data-choice-index="${i+1}" data-show="0" style="--pct:0">
            <span>${escapeHtml(c)}</span>
            <span class="pct"></span>
          </button>
        `).join("")}
      </div>

      <div class="bottomRow"><div class="count"></div></div>
      <div class="msg"></div>
      ${noteHtml}
    `;
    return card;
  }

  async function attach(card, topic){
    const msg = card.querySelector(".msg");

    const myKey = await getMyVote(topic.id);
    if(myKey){
      const r = await getCounts(topic.id);
      if(r.denied){
        msg.textContent = "投票済み（結果の取得権限がありません）";
        lock(card, true);
        return;
      }
      renderResult(card, r.counts);
      msg.textContent = "投票済みです。";
      return;
    }

    card.querySelectorAll(".choiceBtn").forEach(btn=>{
      btn.addEventListener("click", async ()=>{
        msg.textContent = "";

        // ✅ ここだけ変更：未ログインならログインへ飛ぶ（戻ってこれる）
        if(!pb.authStore.isValid){
          goLoginWithNext();
          return;
        }

        lock(card, true);

        const idx = Number(btn.dataset.choiceIndex);
        const key = indexToKey(idx);

        try{
          await pb.collection("polls").create({
            topic: topic.id,
            user: pb.authStore.model.id,
            choiceKey: key,
            choiceIndex: idx,
            choice: key
          });
          msg.textContent = "投票を反映しました。";
        }catch(e){
          msg.textContent = "投票済みです。";
        }

        const r = await getCounts(topic.id);
        if(r.denied){
          msg.textContent = msg.textContent || "投票しました（結果の取得権限がありません）";
          return;
        }
        renderResult(card, r.counts);
        msg.textContent = "投票済みです。";
      });
    });
  }

  function totalPages(){
    return Math.max(1, Math.ceil(topicsAll.length / PER_PAGE));
  }

  function buildPager(){
    const pages = totalPages();
    if(pages <= 1){
      pagerEl.style.display = "none";
      return;
    }
    pagerEl.style.display = "flex";
    pageBtnsEl.innerHTML = "";

    for(let p=1; p<=pages; p++){
      const b = document.createElement("button");
      b.type = "button";
      b.className = "pageBtn" + (p === currentPage ? " isActive" : "");
      b.textContent = String(p);
      b.addEventListener("click", ()=>{
        if(currentPage === p) return;
        currentPage = p;
        renderPage();
      });
      pageBtnsEl.appendChild(b);
    }

    nextBtnEl.disabled = currentPage >= pages;
    nextBtnEl.onclick = ()=>{
      const pages = totalPages();
      if(currentPage < pages){
        currentPage++;
        renderPage();
      }
    };
  }

  async function renderPage(){
    pollListEl.innerHTML = "";
    systemMsgEl.style.display = "none";

    const pages = totalPages();
    if(currentPage > pages) currentPage = pages;

    const start = (currentPage - 1) * PER_PAGE;
    const slice = topicsAll.slice(start, start + PER_PAGE);

    for(const t of slice){
      const card = buildCard(t);
      pollListEl.appendChild(card);
      try{
        await attach(card, t);
      }catch{
        card.querySelector(".msg").textContent = "このアンケートの表示中にエラーが出ました。";
      }
    }

    buildPager();
    window.scrollTo({ top: 0, behavior: "smooth" });
  }

  async function load(){
    pollListEl.innerHTML = "";
    systemMsgEl.style.display = "none";
    pagerEl.style.display = "none";

    let res;
    try{
      res = await pb.collection("poll_topics").getList(1,200,{
        filter:`published=true && status!="archived"`,
        sort:"-created"
      });
    }catch(err){
      const m = err?.data?.message || err?.message || "unknown";
      sysMsg(
        `読み込み失敗：${escapeHtml(m)}<br><br>` +
        `PocketBase側の <b>poll_topics の List/View ルール</b>が一般ユーザーに開いてない可能性があります。` +
        `<br>List/View を <b>published=true</b> で読めるようにしてください。`,
        true
      );
      return;
    }

    if(!res.items.length){
      sysMsg("公開中のアンケートがありません。");
      return;
    }

    topicsAll = res.items;
    currentPage = 1;
    renderPage();
  }

  load();
})();
</script>

</body>
</html>
